# Summary
`log4j.properties` configures Log4j 1.x for the KLMReport component of the Move‑Mediation‑Ingest pipeline. It defines a root logger at **INFO** level with two appenders: a daily‑rolling file appender (`File`) whose target file is supplied via the `${logfile.name}` system property, and a console appender (`stdout`). All log events from the application are formatted with a standard pattern and written to both destinations in production.

# Key Components
- **log4j.rootLogger** – Sets global log level (`INFO`) and attaches `File` and `stdout` appenders.  
- **log4j.appender.File** – `org.apache.log4j.DailyRollingFileAppender` writing to `${logfile.name}`; rotates daily.  
- **log4j.appender.File.layout** – `org.apache.log4j.PatternLayout` with pattern `[%‑5p] %d{ISO8601} %c - %m%n`.  
- **log4j.appender.stdout** – `org.apache.log4j.ConsoleAppender` targeting `System.out`.  
- **log4j.appender.stdout.layout** – Same `PatternLayout` as file appender.

# Data Flow
| Element | Description |
|---------|-------------|
| **Input** | Log events generated by Java classes (`org.apache.log4j.Logger`) throughout KLMReport. |
| **Processing** | Log4j evaluates each event against the root logger level; formats with the defined pattern. |
| **Outputs** | 1. Writes formatted line to the daily‑rolled file (`${logfile.name}`). 2. Writes the same line to STDOUT (console). |
| **Side Effects** | File creation/rotation on the host filesystem; console output visible in the process’s stdout stream. |
| **External Services** | None; purely local I/O. No DB, queue, or network interaction. |

# Integrations
- Loaded automatically by the JVM when the classpath contains `log4j.properties` (e.g., packaged in `KLMReport.jar` or placed on the classpath via `-Dlog4j.configuration`).  
- Consumed by all Java components of the **move‑mediation‑klm** module that use Log4j for logging (e.g., report generators, Hadoop job wrappers).  
- Interacts with the production deployment scripts that set the `logfile.name` system property to a path under the job’s log directory.

# Operational Risks
- **Unbounded file growth** – Daily rolling mitigates but does not limit total size; old logs may accumulate. *Mitigation*: schedule log‑cleanup or add `MaxBackupIndex`.  
- **Missing `logfile.name` property** – Results in `null` file path and runtime `FileNotFoundException`. *Mitigation*: enforce property via startup wrapper or default fallback.  
- **Log level too low** – `INFO` may generate excessive volume under heavy load. *Mitigation*: allow override with `-Dlog4j.rootLogger=WARN,File,stdout` in high‑throughput scenarios.  
- **Synchronous I/O** – Both appenders block the application thread. *Mitigation*: replace with `AsyncAppender` for performance‑critical jobs.

# Usage
```bash
# Example startup for a KLMReport job
java -Dlogfile.name=/var/log/mnaas/klm/report_$(date +%Y%m%d).log \
     -Dlog4j.configuration=file:/opt/mnaas/KLMReport/conf/log4j.properties \
     -cp klm-report.jar:$(dependency_jars) com.tcl.move.klm.Main
```
To debug configuration issues, enable Log4j internal debugging:
```bash
java -Dlog4j.debug=true ...   # prints configuration parsing to stdout
```

# Configuration
- **System Property** `logfile.name` – Absolute path for the daily‑rolling log file. Must be set by the launch script or environment.  
- **Optional Override** `log4j.rootLogger` – Can be redefined at runtime to change log level or appenders.  
- **File Location** – `log4j.properties` must be on the classpath or referenced via `-Dlog4j.configuration`. No other external config files are referenced.

# Improvements
1. **Add size‑based rollover** – Replace `DailyRollingFileAppender` with `RollingFileAppender` (or `RollingFileAppender` + `TimeBasedRollingPolicy` via Log4j 2) to cap file size and retain a configurable number of archives.  
2. **Introduce asynchronous logging** – Wrap the file appender in `org.apache.log4j.AsyncAppender` to decouple I/O latency from the main processing threads.