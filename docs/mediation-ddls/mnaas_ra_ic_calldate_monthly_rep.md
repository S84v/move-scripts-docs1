**File:** `mediation-ddls\mnaas_ra_ic_calldate_monthly_rep.hql`  

---

## 1. High‑Level Summary
This script creates the Hive/MySQL view `mnaas.ra_ic_calldate_monthly_rep`. The view consolidates inter‑connect (IC) traffic metrics for each billing month, combining **mediation**, **rejection**, and **generation** data for both SMS (`TEMSI`) and voice (`TEMVI`). It pulls raw counts and usage from the underlying tables `ra_calldate_traffic_table`, `ra_calldate_rej_tbl`, `ra_calldate_gen_succ_rej`, and the calendar table `month_reports`. The resulting view is used downstream for monthly reporting, billing validation, and KPI dashboards.

---

## 2. Core Components (CTEs & Logic)

| Component | Responsibility |
|-----------|-----------------|
| **`med_data`** | Filters `ra_calldate_traffic_table` for `usagefor='Interconnect'` and extracts per‑month SMS/voice CDR counts and usage (bytes‑sec). |
| **`med_summary`** | Aggregates `med_data` by `callmonth` → total SMS CDR, SMS usage, voice CDR, voice usage (converted to minutes). |
| **`rej_data`** | Joins `ra_calldate_rej_tbl` with `month_reports` (by `bill_month = month`) and extracts rejected SMS/voice CDR counts and usage. |
| **`rej_summary`** | Aggregates `rej_data` by `callmonth`. |
| **`gen_data`** | Joins `ra_calldate_gen_succ_rej` with `month_reports` (status = 'SUCCESS') and extracts generated (successful) SMS/voice CDR counts and usage. |
| **`gen_summary`** | Aggregates `gen_data` by `callmonth`. |
| **Final SELECT** | Left‑joins the three summaries on `callmonth` to produce a flat row per month containing: <br>• Mediation SMS/voice CDR & usage <br>• Rejection SMS/voice CDR & usage <br>• Generation SMS/voice CDR & usage |

---

## 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Input tables / sources** | `mnaas.ra_calldate_traffic_table` (mediation data) <br> `mnaas.ra_calldate_rej_tbl` (rejection data) <br> `mnaas.ra_calldate_gen_succ_rej` (generation data) <br> `mnaas.month_reports` (calendar mapping `bill_month → month`) |
| **Output** | Hive/MySQL **view** `mnaas.ra_ic_calldate_monthly_rep`. No physical table is created; the view is a stored query. |
| **Side effects** | DDL operation – creates or replaces the view. No data mutation. |
| **Assumptions** | • All referenced tables exist and are populated before this script runs.<br>• `usage_type` values are limited to `'TEMSI'` (SMS) and `'TEMVI'` (voice).<br>• `bytes_sec_sms` holds SMS usage; `cdr_usage` holds generic usage for rejections.<br>• `month_reports` contains a column `month` that matches the `callmonth` format used in traffic tables.<br>• The underlying DB engine supports `CREATE VIEW … AS WITH …` syntax (Hive/Impala or MySQL 8+). |

---

## 4. Integration Points

| Connected Script / Component | Relationship |
|------------------------------|--------------|
| **`mnaas_ra_calldate_traffic_table.hql`** | Creates `ra_calldate_traffic_table` – source for `med_data`. |
| **`mnaas_ra_calldate_rej_tbl`** (generated by `mnaas_ra_calldate_*_reject.hql` scripts) | Supplies rejection counts/usage for `rej_data`. |
| **`mnaas_ra_calldate_gen_succ_rej.hql`** | Populates `ra_calldate_gen_succ_rej` – source for `gen_data`. |
| **`mnaas_month_reports.hql`** (or similar) | Provides the `month_reports` calendar table used in joins. |
| **Downstream reporting jobs** (e.g., monthly billing, KPI dashboards) | Consume `ra_ic_calldate_monthly_rep` to produce CSV/Parquet extracts or feed BI tools. |
| **Orchestration layer (Airflow / Oozie)** | Typically runs this DDL after the three source tables are refreshed for a given month. |

---

## 5. Operational Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Missing source tables** | View creation fails, downstream jobs break. | Add a pre‑execution validation step that checks existence & row‑count of each source table. |
| **Schema drift (column rename or type change)** | Query errors or silent data loss. | Version‑control table schemas; include unit tests that compile the view against a test schema. |
| **Incorrect `usage_type` codes** (e.g., new service types) | New traffic will be omitted from the view. | Extend the CASE statements to a default `ELSE 0` and log unexpected codes. |
| **Performance degradation** (large joins on `month_reports`) | Long view compilation, slow downstream queries. | Ensure `month_reports` is small and cached; add appropriate partitioning on `callmonth` in source tables. |
| **View staleness** (source tables refreshed but view not re‑created) | Reports show outdated data. | Include the view creation in the same orchestration DAG as source table loads, using `CREATE OR REPLACE VIEW`. |
| **Division by zero** (voice usage conversion `/ 60`) | Runtime error if `med_voi_usage` is NULL. | Use `NULLIF(med_voi_usage,0)` or `COALESCE` to guard division. |

---

## 6. Execution & Debugging Guide

1. **Prerequisites**  
   * Hive/Impala (or MySQL) client installed.  
   * Connection details (host, port, credentials) supplied via environment variables or a properties file (`hive-site.xml`, `~/.my.cnf`).  

2. **Run the script**  
   ```bash
   # Example using Hive CLI
   hive -f mediation-ddls/mnaas_ra_ic_calldate_monthly_rep.hql
   # Or using MySQL client
   mysql -u $DB_USER -p$DB_PASS -h $DB_HOST < mediation-ddls/mnaas_ra_ic_calldate_monthly_rep.hql
   ```

3. **Verify creation**  
   ```sql
   SHOW CREATE VIEW mnaas.ra_ic_calldate_monthly_rep;
   SELECT * FROM mnaas.ra_ic_calldate_monthly_rep LIMIT 10;
   ```

4. **Debugging tips**  
   * If the view fails to compile, run each CTE individually as a temporary table (`CREATE TABLE tmp AS …`) to isolate the problematic part.  
   * Check data types of columns used in arithmetic (`bytes_sec_sms`, `cdr_usage`) – mismatched types cause implicit cast errors.  
   * Use `EXPLAIN` on the final SELECT to inspect join order and identify missing indexes/partitions.  

5. **Re‑creation**  
   The script uses `CREATE VIEW`. If you need to replace an existing view, change the first line to `CREATE OR REPLACE VIEW …` (supported in Hive 2.1+ and MySQL 8).  

---

## 7. External Configuration / Environment Variables

| Variable / File | Purpose |
|-----------------|---------|
| `DB_HOST`, `DB_USER`, `DB_PASS` (or equivalent) | Database connection credentials used by the orchestration wrapper that invokes the script. |
| `HIVE_CONF_DIR` / `MYSQL_CNF` | Location of client configuration (e.g., Kerberos tickets, SSL certificates). |
| `SCHEMA=mnaas` (if templated) | Allows the same script to be reused for a different schema by external substitution. |
| `LOG_LEVEL` (if the wrapper logs) | Controls verbosity of orchestration logs; not used directly in the HQL file. |

If the script is part of a larger templating system (e.g., Jinja2), placeholders such as `${SCHEMA}` may appear; in the current version they are hard‑coded to `mnaas`.

---

## 8. Suggested Improvements (TODO)

1. **Add defensive handling for division** – replace `sum(rej_voi_usage) / 60` with `sum(rej_voi_usage) / NULLIF(60,0)` or `sum(rej_voi_usage) / 60.0` to avoid integer division pitfalls.  
2. **Document column lineage** – create a separate markdown file mapping each output column back to its source table/field. This aids impact analysis when upstream schemas change.  

---