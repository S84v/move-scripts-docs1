**File:** `mediation-ddls\mnaas_ra_calldate_ic_partner_reject.hql`  

---

## 1. High‑Level Summary
This HiveQL script creates (or replaces) the view `mnaas.ra_calldate_ic_partner_reject`. The view aggregates inter‑connect (IC) call detail records (CDRs) that are **not billable** because they are egress traffic to partner networks. It pulls raw traffic data from `ra_calldate_traffic_table`, enriches it with organization details from `org_details`, filters on usage types (`TEMSI`, `TEMVI`) and on partner type (excluding “INGRESS”), and groups by a set of key dimensions to produce summed CDR counts and usage minutes. The resulting view is consumed downstream by billing, reporting, or exception‑handling jobs that need to isolate partner‑reject traffic.

---

## 2. Key Objects & Responsibilities

| Object | Type | Responsibility |
|--------|------|-----------------|
| `ra_calldate_ic_partner_reject` | Hive **VIEW** | Provides a pre‑aggregated, filtered snapshot of egress inter‑connect CDRs that should not be billed. |
| `ra_calldate_traffic_table` | Hive **TABLE** (populated by upstream mediation jobs) | Source of raw CDR rows, containing fields such as `filename`, `processed_date`, `callmonth`, `tcl_secs_id`, `orgname`, `proposition_addon`, `country`, `cdr_count`, `bytes_sec_sms`, `calltype`, `usage_type`, `partnertype`, `row_num`. |
| `org_details` | Hive **TABLE** (created by `mnaas_org_details.hql`) | Holds mapping of `tcl_secs_id` → `orgno`, `orgname`, etc., used for enrichment of traffic rows. |
| `createtab_stmt` | Script wrapper (metadata column) | Not part of execution; indicates the DDL statement to be executed by the orchestration engine. |

---

## 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | - Hive tables: `mnaas.ra_calldate_traffic_table`, `mnaas.org_details`.<br>- Columns referenced: `filename`, `processed_date`, `callmonth`, `tcl_secs_id`, `orgname`, `proposition_addon`, `country`, `cdr_count`, `bytes_sec_sms`, `calltype`, `usage_type`, `partnertype`, `row_num`. |
| **Outputs** | - Hive **VIEW**: `mnaas.ra_calldate_ic_partner_reject` (metadata stored in Hive Metastore). |
| **Side Effects** | - Overwrites (or creates) the view definition in Hive Metastore.<br>- No data files are written directly; downstream jobs reading the view will trigger reads from the underlying tables. |
| **Assumptions** | - Underlying tables exist and are up‑to‑date for the processing window.<br>- `row_num` column is generated by a prior windowing operation (e.g., `ROW_NUMBER() OVER (…)`).<br>- `partnertype` values are consistently capitalised or case‑insensitive; the script uses `UPPER(partnertype) != 'INGRESS'`.<br>- Hive execution engine (Tez/MR) is available and the user has `CREATE VIEW` privileges on schema `mnaas`. |

---

## 4. Integration Points (Connections to Other Scripts/Components)

| Direction | Component | Connection Detail |
|-----------|-----------|-------------------|
| **Upstream** | `mnaas_ra_calldate_traffic_table` creation script (likely `mnaas_ra_calldate_*_reject.hql` family) | Populates the raw traffic table that this view reads. |
| **Upstream** | `mnaas_org_details.hql` | Supplies the `org_details` table used for the left‑outer join. |
| **Sibling Views** | Other reject views (`ra_calldate_ic_ingress_reject`, `ra_calldate_geneva_reject`, etc.) | Share the same source tables and similar filtering logic; may be used together in downstream aggregation jobs. |
| **Downstream** | Billing/Exception handling jobs (e.g., nightly ETL, Oozie workflow, Airflow DAG) | Query this view to exclude partner‑reject traffic from billable usage calculations. |
| **Orchestration** | Production scheduler (Oozie, Airflow, Control-M) | Executes the `.hql` file via Hive CLI or Beeline as part of a larger mediation pipeline. |
| **Monitoring** | Hive Metastore / Atlas lineage tools | Capture lineage from `ra_calldate_traffic_table` → this view → downstream consumption. |

---

## 5. Operational Risks & Mitigations

| Risk | Impact | Recommended Mitigation |
|------|--------|------------------------|
| **Missing source tables** (`ra_calldate_traffic_table` or `org_details`) | View creation fails; downstream jobs break. | Add pre‑execution checks (e.g., `SHOW TABLES LIKE ...`) in the orchestration script; alert on failure. |
| **Schema drift** (column rename or type change) | Query errors or silent data loss. | Version‑control table schemas; run schema validation tests in CI pipeline. |
| **Incorrect `partnertype` case handling** | Some ingress records may slip through, causing billing errors. | Normalize `partnertype` at source ingestion or add explicit `LOWER()` handling and unit tests. |
| **`row_num` filter (`row_num = 1`)** may drop legitimate duplicate rows if windowing logic changes. | Under‑reporting of usage. | Document the purpose of `row_num`; verify upstream window function logic before deployment. |
| **View recreation without `IF NOT EXISTS`** can cause transient failures if another job holds a lock. | Job contention, retries. | Use `CREATE OR REPLACE VIEW` (if supported) or coordinate view refresh via a lock table. |
| **Performance**: Large joins and aggregations may cause long Hive jobs. | SLA breach. | Ensure underlying tables are partitioned on `callmonth` or `processed_date`; add appropriate statistics (`ANALYZE TABLE`). |

---

## 6. Running / Debugging the Script

1. **Standard Execution (via scheduler)**  
   ```bash
   hive -f mediation-ddls/mnaas_ra_calldate_ic_partner_reject.hql
   ```
   *Or* via Beeline:
   ```bash
   beeline -u jdbc:hive2://<hive-host>:10000/default -f mediation-ddls/mnaas_ra_calldate_ic_partner_reject.hql
   ```

2. **Ad‑hoc Validation**  
   ```sql
   -- Verify view definition
   SHOW CREATE VIEW mnaas.ra_calldate_ic_partner_reject;

   -- Sample data check
   SELECT * FROM mnaas.ra_calldate_ic_partner_reject LIMIT 20;
   ```

3. **Debugging Steps**  
   - **Check source tables**: `DESCRIBE FORMATTED mnaas.ra_calldate_traffic_table;` and `DESCRIBE FORMATTED mnaas.org_details;`.  
   - **Validate row count** before and after view creation: `SELECT COUNT(*) FROM mnaas.ra_calldate_traffic_table WHERE usage_type IN ('TEMSI','TEMVI') AND row_num = 1 AND UPPER(partnertype) != 'INGRESS';`.  
   - **Review Hive logs** for any “SemanticException” or “AnalysisException”.  
   - **Run the SELECT portion alone** (copy the inner SELECT) to isolate errors.

---

## 7. External Configuration / Environment Variables

The script itself does not reference external config files or environment variables. However, typical production environments inject:

| Variable | Purpose |
|----------|---------|
| `HIVE_CONF_DIR` | Location of Hive configuration (e.g., `hive-site.xml`). |
| `HADOOP_USER_NAME` | Execution user for Hadoop/Hive permissions. |
| `METASTORE_URI` | Hive Metastore endpoint, if not default. |
| `DB_SCHEMA` (optional) | Some pipelines parameterise the schema (`mnaas`) via a variable; verify if the orchestration wrapper does so. |

If any of these are set at runtime, they affect where the view is created.

---

## 8. Suggested Improvements (TODO)

1. **Add Idempotent View Creation**  
   Replace the raw `CREATE VIEW` with `CREATE OR REPLACE VIEW` (Hive 3.x+) or wrap the statement in a conditional drop:
   ```sql
   DROP VIEW IF EXISTS mnaas.ra_calldate_ic_partner_reject;
   CREATE VIEW mnaas.ra_calldate_ic_partner_reject AS ...
   ```

2. **Parameterise Filter Values**  
   Externalise `usage_type` list and `partner_type` exclusion into a configuration table or Hive variable, enabling easier updates without code change.

---