**File:** `move-indiamed-api\APIAccessManagementMigration\src\com\tcl\api\callout\AlertEmail.java`

---

## 1. High‑Level Summary
`AlertEmail` is a utility class that loads runtime configuration from `APIAcessMgmt.properties`, initializes Log4j, and provides a single public method `sendAlertMail(String)` to dispatch an alert e‑mail via the JavaMail API. In production it is invoked by other call‑out components (e.g., `APIMain`, `AccountNumDetails`) whenever a critical error occurs during the API Access Management migration job, ensuring that the operations team receives timely notifications.

---

## 2. Important Classes & Functions  

| Element | Responsibility |
|---------|-----------------|
| **class `AlertEmail`** | Encapsulates email‑alert logic and Log4j initialization. |
| `public static void main(String[] args)` | Stand‑alone test driver: loads properties, sets system properties, configures logger, and sends a sample alert. |
| `public void sendAlertMail(String messageBody)` | Builds a `MimeMessage` using system properties (`error_mail_to`, `email_from`, `email_cc`, `mail_host`), sends it via `Transport.send`, and logs success or failure. |
| `private static String getStackTrace(Exception e)` | Helper that converts an exception stack trace to a `String` for logging. |

---

## 3. Inputs, Outputs, Side Effects & Assumptions  

| Category | Details |
|----------|---------|
| **Inputs** | • `APIAcessMgmt.properties` (hard‑coded workspace path) <br>• System properties read at runtime: `error_mail_to`, `email_from`, `email_cc`, `mail_host` <br>• `messageBody` argument to `sendAlertMail` |
| **Outputs** | • Email sent to the recipients defined in the properties file <br>• Log entries written to the file defined by `logfile.name` (e.g., `Accessmgmt.log`) |
| **Side Effects** | • Mutates the JVM’s system property table (adds all entries from the properties file) <br>• Writes to the Log4j file appender <br>• Network traffic to the SMTP host |
| **Assumptions** | • JavaMail library is on the classpath <br>• SMTP host (`mail_host`) is reachable and allows relay from the executing host <br>• `APIAcessMgmt.properties` exists at the hard‑coded location and contains all required keys <br>• Log4j configuration (`log4j.properties`) reads `logfile.name` system property to locate the log file |

---

## 4. Integration Points (How This File Connects to the Rest of the System)

| Connected Component | Interaction |
|----------------------|-------------|
| **`APIAccessManagementMigration` job scripts** (e.g., `APIMain`, `AccountNumDetails`) | Call `new AlertEmail().sendAlertMail(errorMsg)` when they catch a fatal exception or detect a data‑move anomaly. |
| **`APIAcessMgmt.properties`** (see previous HISTORY entry) | Supplies the SMTP host, sender/recipient addresses, and the Log4j logfile name. |
| **Log4j (`log4j.properties`)** | Consumes the `logfile.name` system property set by this class to route log output. |
| **External mail server (`mail_host`)** | Receives the SMTP `MAIL FROM`/`RCPT TO` commands generated by JavaMail. |
| **Monitoring/Operations** | Operators watch `Accessmgmt.log` for the “Message sent successfully” entry or error stack traces. |

---

## 5. Operational Risks & Recommended Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Hard‑coded workspace path** (`E:\\eclipse-workspace\\APIAccessManagement\\`) | Failure when the code runs on a different server or under a different directory layout. | Externalize the base path via an environment variable or a command‑line argument; fallback to a relative classpath resource. |
| **Missing or malformed properties** (e.g., empty `error_mail_to`) | `NullPointerException` or malformed e‑mail causing send failure. | Validate required properties at startup; abort with a clear log message if any are missing. |
| **No retry / async handling** | Transient SMTP outage leads to lost alerts. | Wrap `Transport.send` in a retry loop with exponential back‑off or queue the alert for later processing (e.g., via a JMS topic). |
| **Logger may be `null` if initialization fails** | Subsequent `logger.info/error` calls throw `NullPointerException`. | Initialise logger in a static block and guard all logging calls with a null‑check or use `Logger.getLogger` directly. |
| **Plain‑text credentials (if added later) in properties** | Security exposure. | Store sensitive values (e.g., SMTP credentials) in a secure vault or use encrypted property values. |
| **Blocking call in main thread** | If used in a batch job, email send could delay job completion. | Consider sending alerts in a separate thread or using a non‑blocking mail library. |

---

## 6. Running / Debugging the Class  

1. **Compile** (assuming the project uses Maven/Ant and the classpath includes JavaMail and Log4j):  
   ```bash
   javac -cp ".;lib/*" com/tcl/api/callout/AlertEmail.java
   ```

2. **Execute** (no arguments required):  
   ```bash
   java -cp ".;lib/*" com.tcl.api.callout.AlertEmail
   ```
   - The program will load `APIAcessMgmt.properties` from the hard‑coded location, set system properties, initialise Log4j, and send a sample alert with body “Sample alert message”.

3. **Debugging Tips**  
   - **Check the log file** (`Accessmgmt.log`) for the “Message sent successfully” entry or any error stack trace.  
   - **Enable Log4j DEBUG** by adding `log4j.rootLogger=DEBUG, FILE` in `log4j.properties`.  
   - **Validate properties**: before running, open `APIAcessMgmt.properties` and confirm keys `error_mail_to`, `email_from`, `email_cc`, `mail_host` are present and correctly formatted.  
   - **Network test**: from the host, telnet to the SMTP host on port 25 (or the configured port) to ensure connectivity.  
   - **Unit test**: create a JUnit test that injects a mock `Session` (using GreenMail or a similar in‑memory SMTP server) to verify `sendAlertMail` behavior without sending real e‑mail.

---

## 7. External Configuration & Environment Variables  

| Config Source | Key | Purpose |
|---------------|-----|---------|
| `APIAcessMgmt.properties` (file) | `error_mail_to` | Comma‑separated list of TO recipients. |
|  | `email_from` | Sender address (single). |
|  | `email_cc` | Comma‑separated CC list (optional). |
|  | `mail_host` | SMTP host name (e.g., `mxrelay.vsnl.co.in`). |
|  | `logfile.name` (set by this class) | Full path of the Log4j file appender used by the migration job. |
| System / Environment | None directly used, but the class sets system properties from the file for downstream components. |

---

## 8. Suggested TODO / Improvements  

1. **Externalize the workspace/base directory** – read a `BASE_DIR` environment variable or a JVM system property instead of the hard‑coded `E:\\eclipse-workspace\\APIAccessManagement\\`.  
2. **Add property validation and graceful fallback** – before using any `System.getProperty`, verify it is non‑null and log a clear error; optionally provide default values (e.g., a fallback SMTP host).  

--- 

*End of documentation.*