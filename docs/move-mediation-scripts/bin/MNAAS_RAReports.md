**MNAAS_RAReports.sh – High‑Level Documentation**

---

### 1. Purpose (One‑paragraph summary)

`MNAAS_RAReports.sh` is a Bash driver that launches the Java‑based **RAReport** batch job to produce the daily Revenue‑Assurance (RA) report for the MNAAS platform. It loads common batch properties, redirects error output to a central log file, invokes the `RAReport.jar` with a fixed start‑date argument, and records start/end timestamps in the same log. The script is intended to be scheduled (e.g., via cron) as part of the daily data‑move pipeline, feeding downstream billing, analytics, or audit processes.

---

### 2. Key Functions / Components

| Name / Artifact | Type | Responsibility |
|-----------------|------|----------------|
| **`. /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`** | Bash source file | Supplies environment variables used by the script (e.g., `$MNAAS_RAReport_LogPath`, Java classpath, DB credentials). |
| **`exec 2>>$MNAAS_RAReport_LogPath`** | Bash redirection | Sends all subsequent *stderr* from the script to the RA‑report log file. |
| **`MNAAS_Run_Adhoc_Report()`** | Bash function | Executes the Java JAR `RAReport.jar` with hard‑coded arguments (`2021‑06‑01 null … daily Y`) and logs a success message via `logger`. |
| **Main program block** | Bash statements | Writes a header, start timestamp, and script identifier to the log, then attempts to invoke `MNAAS_Run_Daily_Report`. |
| **`RAReport.jar`** | Java executable (external) | Performs the actual data extraction, transformation, and aggregation needed for the daily RA report. |

*Note:* The script calls `MNAAS_Run_Daily_Report`, which is **not defined** in this file. The intended call is most likely `MNAAS_Run_Adhoc_Report`. This discrepancy is highlighted in the operational‑risk section.

---

### 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | • Environment variables defined in `MNAAS_Java_Batch.properties` (e.g., `$MNAAS_RAReport_LogPath`).<br>• Implicit date range: the Java call uses a hard‑coded start date `2021‑06‑01` and a `null` end date (interpreted by the JAR as “process up to today”). |
| **Outputs** | • Log entries appended to `$MNAAS_RAReport_LogPath` (start time, script name, success/failure messages).<br>• Files generated by `RAReport.jar` (location defined inside the JAR or via properties – not visible from this script). |
| **Side Effects** | • Launches a Java process that may read/write to Hadoop/HDFS, relational DBs, or other storage systems (as configured inside the JAR).<br>• May emit metrics or alerts via `logger`. |
| **Assumptions** | • `MNAAS_Java_Batch.properties` exists and defines all required variables.<br>• Java runtime is available and `$JAVA_HOME`/`PATH` are correctly set.<br>• `RAReport.jar` is present at the path shown and is compatible with the current data schema.<br>• The user executing the script has read/write permissions on the log directory. |

---

### 4. Integration Points (How this script connects to the wider system)

| Connection | Description |
|------------|-------------|
| **Property File (`MNAAS_Java_Batch.properties`)** | Shared across all MNAAS batch scripts (e.g., `MNAAS_Monthly_RAReports.sh`, `MNAAS_PreValidation_Checks.sh`). Provides common configuration such as DB URLs, HDFS paths, and log locations. |
| **Java JAR (`RAReport.jar`)** | Central processing component used by multiple scripts (daily, monthly, ad‑hoc RA reports). The JAR reads from staging tables populated by upstream ingestion jobs (e.g., `MNAAS_MSISDN_Level_Daily_Usage_Aggr_*`). |
| **Logging (`logger` & `$MNAAS_RAReport_LogPath`)** | Consolidated log file consumed by monitoring/alerting tools (e.g., Splunk, ELK). Other scripts write to the same directory, enabling a single view of batch health. |
| **Scheduler** | Typically invoked by a cron entry or an enterprise scheduler (e.g., Control-M, Oozie) that runs the script after the daily data‑load jobs complete. |
| **Downstream Consumers** | The generated RA report files are later consumed by billing reconciliation processes (`MNAAS_Monthly_Billing_Export.sh`) and audit dashboards. |

---

### 5. Operational Risks & Recommended Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Undefined function call** (`MNAAS_Run_Daily_Report`) | Script exits with *command not found*, causing daily RA report to be missed. | Update the call to `MNAAS_Run_Adhoc_Report` (or rename the function consistently). Add a sanity check (`type -t MNAAS_Run_Daily_Report && MNAAS_Run_Daily_Report || exit 1`). |
| **Hard‑coded start date (`2021‑06‑01`)** | Future runs may re‑process historic data unnecessarily, increasing load and potentially overwriting newer aggregates. | Parameterize the start date via a property or command‑line argument; default to the previous run’s date if not supplied. |
| **Missing/invalid `$MNAAS_RAReport_LogPath`** | Logs are lost; error output may be sent to the invoking shell, polluting console. | Validate that `$MNAAS_RAReport_LogPath` is non‑empty and writable before `exec`. Fail fast with a clear message. |
| **Java process failure (non‑zero exit code)** | No RA report generated, downstream billing may be incomplete. | Capture the Java exit code, log it, and propagate a non‑zero exit status from the script. Optionally trigger an alert via `logger` or an external monitoring hook. |
| **Insufficient resource limits** (memory/CPU) for the Java job | Job may be killed by the OS or OOM killer, leading to partial output. | Define JVM options (e.g., `-Xmx`) in the properties file; monitor resource usage during the first few runs. |
| **Lack of idempotency** (report files overwritten) | Re‑runs could corrupt already‑published data. | Ensure the JAR writes to a timestamped directory or uses a lock file; document the expected behavior. |

---

### 6. Typical Execution / Debug Workflow

1. **Preparation**  
   ```bash
   # Verify environment
   source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties
   echo "Log path: $MNAAS_RAReport_LogPath"
   ls -l "$MNAAS_RAReport_LogPath"
   ```

2. **Run the script manually (for a test date)**  
   ```bash
   ./MNAAS_RAReports.sh   # run as the same user the scheduler uses
   ```

3. **Check the log**  
   ```bash
   tail -n 30 "$MNAAS_RAReport_LogPath"
   ```

4. **Debugging**  
   - The script already enables `set -x`; if more detail is needed, run:  
     ```bash
     bash -x MNAAS_RAReports.sh 2>&1 | tee /tmp/ra_debug.log
     ```  
   - Verify the Java command directly:  
     ```bash
     java -jar /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/RAReport.jar 2021-06-01 null \
          /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties \
          "$MNAAS_RAReport_LogPath" daily Y
     echo $?   # should be 0
     ```

5. **Scheduler verification**  
   - Confirm the cron entry (or Control‑M job) points to the correct script path and uses the proper environment (e.g., `source /etc/profile` before execution).  

---

### 7. External Configuration & Environment Variables

| Variable / File | Origin | Usage |
|-----------------|--------|-------|
| **`/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`** | Maintained by the MNAAS operations team | Defines `$MNAAS_RAReport_LogPath` and possibly DB/HDFS connection strings, JVM options, and other shared parameters. |
| **`$MNAAS_RAReport_LogPath`** | Exported by the properties file | Destination for all `stderr` and `logger` messages; also passed as an argument to the Java JAR (likely for the JAR to write its own logs). |
| **`RAReport.jar`** | Deployed under `/app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/` | Core processing engine; version controlled separately. |
| **`JAVA_HOME` / `PATH`** | System environment | Required for the `java -jar` invocation. |

If any of these are missing or point to incorrect locations, the script will fail early.

---

### 8. Suggested Improvements (TODO)

1. **Fix the function call typo** – replace `MNAAS_Run_Daily_Report` with `MNAAS_Run_Adhoc_Report` (or rename the function to match the intended usage). Add a guard that aborts if the function is undefined.  
2. **Make the start date configurable** – read a `START_DATE` variable from the properties file or accept a command‑line argument, defaulting to the previous successful run date. This removes the hard‑coded `2021‑06‑01` and enables true daily processing.

--- 

*End of documentation.*