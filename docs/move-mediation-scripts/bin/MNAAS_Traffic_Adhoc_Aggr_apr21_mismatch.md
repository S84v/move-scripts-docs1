**File:** `move-mediation-scripts/bin/MNAAS_Traffic_Adhoc_Aggr_apr21_mismatch.sh`  

---

## 1. One‑paragraph production summary
This Bash script orchestrates the daily refresh of the **Ad‑hoc Traffic Aggregation** tables used for the “Monthly Usage Trend” report (April‑2021 data‑mismatch correction). It drives three logical steps – partition removal, intermediate‑table aggregation, and final table load – by invoking Java JARs, refreshing Impala metadata, and updating a shared process‑status file. The script is designed to be idempotent, prevents concurrent runs, logs all activity, and on failure creates an SDP ticket and notifies the Move‑Dev team via email.

---

## 2. Important functions & responsibilities  

| Function | Responsibility |
|----------|----------------|
| `MNAAS_remove_partitions_from_the_table` | Updates status file, checks that the *drop‑partitions* Java job is not already running, executes the Java class that drops stale Hive/Impala partitions, refreshes the target table in Impala, logs success/failure. |
| `MNAAS_traffic_aggr_adhoc_inter_table_loading` | Sets status flag = 2, ensures the *inter‑table aggregation* Java job is not already running, runs the Java class that aggregates raw traffic into a temporary staging table, refreshes the staging table in Impala, logs outcome. |
| `MNAAS_traffic_aggr_adhoc_table_loading` | Sets status flag = 3, launches a background refresh script (`traffic_aggr_adhoc_refresh.sh`), runs the final load Java class that moves data from the staging table to the production aggregation table, refreshes the production table in Impala, logs outcome. |
| `terminateCron_successful_completion` | Writes “Success” and final timestamps to the status file, logs script termination, exits with code 0. |
| `terminateCron_Unsuccessful_completion` | Logs failure, calls `email_and_SDP_ticket_triggering_step`, exits with code 1. |
| `email_and_SDP_ticket_triggering_step` | Marks job status as *Failure* in the status file, sends an SDP ticket/e‑mail (if not already sent) to the support mailbox, updates the status file to indicate ticket creation, logs the action. |

---

## 3. Inputs, outputs, side‑effects & assumptions  

| Category | Details |
|----------|---------|
| **Configuration inputs** | `MNAAS_Traffic_Adhoc_Aggr.properties` (sourced at start). It defines all environment variables used throughout the script (paths, DB names, class names, hostnames, email addresses, etc.). |
| **External files** | • Process‑status file (`$MNAAS_traffic_aggr_adhoc_ProcessStatusFileName`) – shared mutable state. <br>• Partition‑list file (`MNAAS_Traffic_AdhocPartitions_Daily_Uniq_FileName_Apr_mismatch`). <br>• Java JARs (`$Generic_Jar_Names`, `$MNAAS_Main_JarPath`). |
| **External services** | • Hive/Impala cluster (`$HIVE_HOST`, `$IMPALAD_HOST`). <br>• Java runtime (JAR execution). <br>• Mail system (`mailx`). |
| **Outputs** | • Log file (`$MNAAS_traffic_aggr_adhocLogPath`). <br>• Updated process‑status file (flags, timestamps, job status). <br>• Impala table refreshes (metadata updates). |
| **Side‑effects** | • Alters Hive/Impala tables (partition drop, data insert). <br>• May spawn background script `traffic_aggr_adhoc_refresh.sh`. <br>• Sends e‑mail/SDP ticket on failure. |
| **Assumptions** | • All required environment variables are correctly defined in the properties file. <br>• Java classes (`drop_partitions_in_table`, `$traffic_aggr_adhoc_aggregation_classname`, `$MNAAS_traffic_aggr_adhoc_load_classname`) are present and compatible with the supplied classpath. <br>• `ps`‑based concurrency check works reliably on the host OS. <br>• Impala shell (`impala-shell`) is reachable and the user has required privileges. |

---

## 4. Connections to other scripts / components  

| Connected component | How this script interacts |
|---------------------|---------------------------|
| `traffic_aggr_adhoc_refresh.sh` (in `/app/hadoop_users/MNAAS/MNAAS_CronFiles/`) | Launched in background from `MNAAS_traffic_aggr_adhoc_table_loading` to perform any post‑load housekeeping (e.g., cache refresh). |
| **Driver scripts** (e.g., `MNAAS_Traffic_Adhoc_Aggr.sh`, `MNAAS_Traffic_Adhoc_Aggr_driver.sh`) | Likely invoke this script via a cron schedule; they share the same properties file and status file. |
| **Partition definition file** `MNAAS_Traffic_AdhocPartitions_Daily_Uniq_FileName_Apr_mismatch` | Provides the list of partitions to drop; generated by upstream data‑pre‑processing jobs. |
| **Java JARs** (`drop_partitions_in_table`, aggregation & load classes) | Executed via `java -cp …` calls; these JARs implement the heavy data‑movement logic. |
| **Process‑status file** (`$MNAAS_traffic_aggr_adhoc_ProcessStatusFileName`) | Shared with other scripts (e.g., daily load, hourly aggregation) to coordinate state and avoid overlapping runs. |
| **SDP ticketing / mail system** | Failure handling uses `mailx` to raise a ticket; the same mechanism is used across the Move‑Mediation suite. |

---

## 5. Operational risks & recommended mitigations  

| Risk | Mitigation |
|------|------------|
| **Concurrent execution detection via `ps` may miss fast‑starting duplicate processes** | Replace `ps | grep` logic with a lock file (`flock`) or use a PID file stored atomically. |
| **Status file race conditions (multiple scripts editing the same file)** | Serialize access using `flock` around all `sed` updates, or move to a lightweight DB (e.g., SQLite) for state tracking. |
| **Java job failure not captured if the process exits with non‑zero but the script continues** | Ensure `set -e` (or explicit `|| exit 1`) after each Java invocation; capture stdout/stderr to log for easier debugging. |
| **Impala‑shell refresh failures silently ignored** (only logged) | Check the exit code of `impala-shell` and treat non‑zero as fatal, invoking the failure path. |
| **Mailx/SDP ticket creation may fail (network, quota)** | Add retry logic and fallback to write a local “alert” file; monitor that file via a watchdog. |
| **Hard‑coded paths and class names make migration difficult** | Externalize all such values into the properties file (already done for many) and validate them at script start. |
| **`set -x` leaves sensitive values in logs** | Remove `set -x` in production or redirect debug output to a secure location with restricted permissions. |

---

## 6. Typical execution / debugging workflow  

1. **Manual run (debug mode)**  
   ```bash
   # Ensure the correct properties file is present
   source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Traffic_Adhoc_Aggr.properties
   # Run the script interactively
   bash -x /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Traffic_Adhoc_Aggr_apr21_mismatch.sh
   ```
   *`-x`* prints each command; watch the log file (`$MNAAS_traffic_aggr_adhocLogPath`) for timestamps.

2. **Check process status before start**  
   ```bash
   grep MNAAS_Daily_ProcessStatusFlag $MNAAS_traffic_aggr_adhoc_ProcessStatusFileName
   ```
   Verify flag is `0` or `1` (ready) before triggering.

3. **Validate Java classpaths**  
   ```bash
   echo $CLASSPATHVAR $Generic_Jar_Names $MNAAS_Main_JarPath
   java -cp "$CLASSPATHVAR:$Generic_Jar_Names" -version   # sanity check
   ```

4. **Inspect Impala refresh**  
   ```bash
   impala-shell -i $IMPALAD_HOST -q "SHOW TABLES LIKE '${traffic_aggr_adhoc_tblname}';"
   ```

5. **Post‑run verification**  
   - Confirm the status file shows `MNAAS_job_status=Success`.  
   - Check the target aggregation table for expected row counts.  
   - Review the log for any “failed” messages or missing SDP tickets.

6. **Cron integration**  
   The script is typically invoked from a cron entry such as:  
   ```cron
   02 02 * * * /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Traffic_Adhoc_Aggr_apr21_mismatch.sh >> /dev/null 2>&1
   ```

---

## 7. External configuration / environment variables  

| Variable (populated by the properties file) | Purpose |
|--------------------------------------------|---------|
| `MNAAS_traffic_aggr_adhocLogPath` | Path to the script’s log file. |
| `MNAAS_traffic_aggr_adhoc_ProcessStatusFileName` | Shared status file tracking flags, PID, timestamps. |
| `Dname_MNAAS_drop_partitions_traffic_aggr_adhoc_tbl` | Unique name used for the partition‑drop Java process (for `ps` detection). |
| `CLASSPATHVAR`, `Generic_Jar_Names`, `MNAAS_Main_JarPath` | Java classpath components. |
| `drop_partitions_in_table` | Fully‑qualified Java class name for partition removal. |
| `dbname`, `traffic_aggr_adhoc_tblname` | Hive database and target table names. |
| `HIVE_HOST`, `HIVE_JDBC_PORT` | Hive connection details (used by Java class). |
| `IMPALAD_HOST` | Impala daemon host for metadata refresh. |
| `traffic_aggr_adhoc_tblname_refresh`, `traffic_aggr_adhoc_inter_tblname_refresh` | Impala `REFRESH` statements passed to `impala-shell`. |
| `traffic_aggr_adhoc_aggregation_classname` | Java class for intermediate aggregation. |
| `MNAAS_traffic_aggr_adhoc_load_classname` | Java class for final load. |
| `MNAAS_traffic_aggr_adhoc_ScriptName` | Human‑readable script identifier used in logs/tickets. |
| `SDP_ticket_from_email`, `SDP_ticket_to_email`, `MOVE_DEV_TEAM` | Email routing for failure notifications. |
| `MNAAS_Property_filename` | Path to the same properties file (passed to Java). |
| `MNAAS_Traffic_AdhocPartitions_Daily_Uniq_FileName_Apr_mismatch` | File containing the list of partitions to be dropped (generated by upstream jobs). |

---

## 8. Suggested TODO / improvements  

1. **Replace `ps | grep` concurrency guard with a robust lock** – e.g., `flock -n /var/lock/MNAAS_TrafficAggr.lock` at script start and release on exit. This eliminates false‑positive “already running” detections and race conditions on the status file.  

2. **Add explicit exit‑code checks for `impala-shell`** – capture its return value, log a clear error, and invoke `terminateCron_Unsuccessful_completion` if the refresh fails. This will prevent silent data‑staleness when Impala metadata cannot be refreshed.  

---