**File:** `move-mediation-scripts\bin\MNAAS_Daily_Validations_Checks.sh`  

---

## 1. High‑Level Summary
This Bash script performs pre‑load validation of daily CDR traffic files that have been landed in four different staging directories. It counts the number of `*CDRTrafficDetail*` files, compares the count against configurable warning (≈100) and incident (≈150) thresholds, logs the result, sends a warning e‑mail (and optionally creates an SDP ticket) when limits are exceeded, and updates a shared *process‑status* file that is used by downstream MOVE ingestion jobs to coordinate execution order. The script is intended to be run from a cron schedule and guards against concurrent executions.

---

## 2. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| `staging_validation_1` – `staging_validation_4` | For each of the four staging locations (`$MNAASMainStagingDirDaily`, `$MNAASMainStagingDirDaily_v2`, `$MNAASMainStagingDirDaily_v1`, `$MNAASMainStagingDirDaily_afr_seq_check`): <br>• Update the process‑status file with a unique flag/value.<br>• Count `*CDRTrafficDetail*` files.<br>• Log count and severity.<br>• Trigger `warning_email` (warning) or `email_and_SDP_ticket_triggering_step_validation` (incident). |
| `warning_email <message> <category>` | Build a templated warning e‑mail (using `mailx`) and send it to the SDP recipient list. Also logs that the warning was sent. |
| `terminateCron_successful_completion` | Reset the process‑status file to “idle” (`ProcessStatusFlag=0`, `ProcessName=MNAASLoading`, `job_status=Success`), record run‑time, and exit with status 0. |
| `terminateCron_Unsuccessful_completion` | Log failure, invoke `email_and_SDP_ticket_triggering_step` to raise an SDP ticket, and exit with status 1. |
| `email_and_SDP_ticket_triggering_step` | Mark the job as `Failure` in the status file, ensure a single SDP ticket/e‑mail is generated (guarded by `MNAAS_email_sdp_created` flag), and log the action. |
| `email_and_SDP_ticket_triggering_step_validation` | Simple wrapper used for incident‑level alerts (already logged by the validation functions). |
| **Main block** | Checks for existing script instances, reads the current `ProcessStatusFlag` from the shared status file, decides which validation steps need to run based on that flag, runs them, and finally calls the appropriate termination routine. |

---

## 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Configuration (sourced)** | `MNAAS_Daily_Validations_Checks.properties` – defines all environment variables used: <br>• Staging directory paths (`MNAASMainStagingDirDaily*`) <br>• Limits (`file_warning_limit`, `file_incident_limit`) <br>• Log directory (`MNAAS_Daily_Validations_Checks_LogPath`) <br>• Process‑status file (`MNAAS_Daily_Validations_Checks_ProcessStatusFileName`) <br>• Script name (`MNAAS_Daily_Validations_Checks_ScriptName`) <br>• Email recipients (`MOVE_SDP_Receipient_List`) |
| **External services** | • Local file system (staging dirs, status file, log files) <br>• Syslog (`logger`) <br>• SMTP server (`mxrelay.vsnl.co.in`) via `mailx` |
| **Primary input** | Presence of files matching `*CDRTrafficDetail*` in the four staging directories. |
| **Primary output** | – Updated process‑status file (flags, timestamps, job status). <br>– Log entries written to `${MNAAS_Daily_Validations_Checks_LogPath}$(date +_%F)`. <br>– Warning e‑mail (and SDP ticket) when thresholds are crossed. |
| **Side effects** | • May create an SDP ticket (outside the script, via downstream ticketing system that consumes the e‑mail). <br>• Alters the shared status file that downstream MOVE ingestion scripts read to decide whether to start. |
| **Assumptions** | • The properties file exists and contains valid absolute paths and numeric limits. <br>• The `mailx` command is configured and can reach the SMTP relay. <br>• The process‑status file is a simple key‑value text file readable/writable by the script user. <br>• No other process modifies the same status file concurrently (guarded by the instance‑count check). |

---

## 4. Integration Points & Call Graph  

| Component | Interaction |
|-----------|-------------|
| **Downstream MOVE ingestion scripts** (e.g., `MNAAS_Daily_KYC_Feed_Loading.sh`, `MNAAS_Daily_Tolling_tbl_Aggr.sh`) | Read the same `ProcessStatusFile` to determine whether the staging area is ready (`ProcessStatusFlag=0`) before starting their own loads. |
| **SDP ticketing system** | Consumes the warning/incident e‑mail generated by `warning_email` or `email_and_SDP_ticket_triggering_step`. No direct API call; relies on e‑mail parsing. |
| **Cron scheduler** | Executes this script on a daily basis (typically early morning). The script itself checks for concurrent runs and aborts if another instance is already active. |
| **Logging infrastructure** | Uses `logger` (syslog) and writes to daily log files; downstream monitoring tools may tail these logs for alerts. |
| **Properties repository** | All environment variables are externalised; any change to staging paths or limits must be reflected in `MNAAS_Daily_Validations_Checks.properties`. |

---

## 5. Operational Risks & Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| **False‑positive alerts** (e.g., temporary file spikes) | Unnecessary SDP tickets, operator fatigue | Tune `file_warning_limit`/`file_incident_limit` per historical volume; add a “grace period” check (e.g., verify count persists for two consecutive runs). |
| **Missing or malformed properties file** | Script aborts, downstream jobs stall | Add a pre‑flight validation step that verifies required variables exist and are non‑empty; exit with clear error code. |
| **Concurrent executions** (race condition on status file) | Corrupted flag values, duplicate tickets | Current `ps aux|grep` guard is coarse; replace with a lock file (`flock`) to guarantee exclusive access. |
| **SMTP outage** → e‑mail not sent | No visibility of critical incidents | Implement retry logic for `mailx` and fallback to a local file‑based alert (e.g., write to `/var/log/alert`) that a monitoring daemon can pick up. |
| **Log file growth** (daily logs never rotated) | Disk exhaustion | Ensure log rotation (e.g., via `logrotate`) is configured for `${MNAAS_Daily_Validations_Checks_LogPath}`. |
| **Hard‑coded file pattern** (`*CDRTrafficDetail*`) | Future file naming changes break validation | Externalise the pattern in the properties file. |

---

## 6. Running & Debugging the Script  

1. **Standard execution (cron)**  
   ```bash
   /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Daily_Validations_Checks.properties
   /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Daily_Validations_Checks.sh
   ```
   The script will exit silently on success; logs are written to the daily log file.

2. **Manual run with debug output**  
   ```bash
   set -x   # already enabled in script
   ./MNAAS_Daily_Validations_Checks.sh
   ```
   Observe the console for the expanded commands and any `logger` output.

3. **Force a single validation step** (useful for testing a specific staging dir):  
   ```bash
   # Edit the status file to set ProcessStatusFlag=1, then run:
   ./MNAAS_Daily_Validations_Checks.sh
   ```
   Or temporarily comment out the `if` block and call a function directly:
   ```bash
   staging_validation_2
   ```

4. **Check the process‑status file**  
   ```bash
   cat $MNAAS_Daily_Validations_Checks_ProcessStatusFileName
   ```
   Verify flags are reset to `0` after a successful run.

5. **Inspect generated e‑mail** (if warnings were sent)  
   ```bash
   grep -i "Warning" /var/log/maillog | tail
   ```

6. **Log verification**  
   ```bash
   tail -f ${MNAAS_Daily_Validations_Checks_LogPath}$(date +_%F)
   ```

---

## 7. External Configuration & Environment Variables  

| Variable (from properties) | Purpose |
|----------------------------|---------|
| `MNAASMainStagingDirDaily` / `*_v2` / `*_v1` / `*_afr_seq_check` | Absolute paths to the four staging directories inspected by the script. |
| `file_warning_limit` | Upper bound for a *warning* condition (default ≈ 100). |
| `file_incident_limit` | Upper bound for an *incident* condition (default ≈ 150). |
| `MNAAS_Daily_Validations_Checks_ProcessStatusFileName` | Path to the shared status file that coordinates with other MOVE jobs. |
| `MNAAS_Daily_Validations_Checks_LogPath` | Directory where daily log files are written. |
| `MNAAS_Daily_Validations_Checks_ScriptName` | Human‑readable name used in logs and e‑mail subjects. |
| `MOVE_SDP_Receipient_List` | Comma‑separated list of e‑mail addresses that receive warnings/SDP tickets. |
| `MNAAS_email_sdp_created` | Flag inside the status file to avoid duplicate ticket creation. |
| `MNAAS_job_status` | Updated to `Success` or `Failure` for downstream monitoring. |

*All of the above are sourced at the top of the script via `.` (dot‑source) of the properties file.*

---

## 8. Suggested Improvements (TODO)

1. **Replace ad‑hoc process‑count check with a robust lock** – use `flock -n /tmp/MNAAS_Validations.lock` to guarantee a single instance and avoid false positives from the `ps | grep` method.
2. **Externalise the file‑matching pattern and email template** – add `CDR_FILE_PATTERN` and `EMAIL_TEMPLATE_PATH` entries to the properties file, allowing future naming changes without script edits and enabling richer HTML e‑mail formatting.  

--- 

*End of documentation.*