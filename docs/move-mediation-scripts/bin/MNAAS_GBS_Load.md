**File:** `move-mediation-scripts\bin\MNAAS_GBS_Load.sh`

---

## 1. Purpose (One‑paragraph summary)

`MNAAS_GBS_Load.sh` is the orchestrator that triggers the **GBS (Global Billing System) data loader** Java application on a regular schedule. It decides, based on the current date‑time, whether to load **only the current month’s traffic data**, **the full month (traffic + reference tables)**, or **the previous month’s full data** (early‑month run). The script is guarded against concurrent executions, reads all runtime parameters from a central properties file, and writes the Java loader’s log to a configurable location. It is typically invoked by a cron‑like scheduler (e.g., every minute) to ensure the loader runs at the defined 3‑hour windows.

---

## 2. Key Functions & Responsibilities

| Function | Call‑signature (as used) | Responsibility |
|----------|--------------------------|----------------|
| `MNAAS_run_traffic <period>` | `MNAAS_run_traffic "MM-YYYY"` | Executes the Java loader in **traffic‑only** mode (`N Y N N` flags). |
| `MNAAS_run_all <period>` | `MNAAS_run_all "MM-YYYY"` | Executes the Java loader in **full‑load** mode (`Y Y N N` flags) – loads both traffic and reference data for the supplied month/year. |
| `MNAAS_run_revalidation <period>` | `MNAAS_run_revalidation "MM-YYYY"` | Executes the Java loader in **re‑validation** mode (`N N Y N` flags). Currently disabled (`reval="N"`). |

All three functions invoke the same JAR:

```bash
java -jar $GBSLoaderJarPath $1 <flags> $MNAASPropertiesPath/MNAAS_ShellScript.properties $GBSLoaderJavaLogPath
```

---

## 3. Inputs, Outputs, Side‑effects & Assumptions

| Category | Details |
|----------|---------|
| **Inputs** | • Current system date/time (via `date`).<br>• Environment variables sourced from `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_ShellScript.properties` (e.g., `GBSLoaderJarPath`, `GBSLoaderJavaLogPath`, `MNAASDailyGBSLoadScriptName`). |
| **Outputs** | • Java loader log file written to `$GBSLoaderJavaLogPath`.<br>• Data loaded into downstream storage (Hive/HDFS/DB) – side‑effect of the Java loader, not directly visible in the script. |
| **Side‑effects** | • Starts a Java process that may create/overwrite tables, files, or Hive partitions.<br>• May generate temporary files in the Java loader’s working directory.<br>• Updates job‑monitoring tables (if the Java loader does so). |
| **Assumptions** | • Java 1.8+ is installed and on `$PATH`.<br>• `$GBSLoaderJarPath` points to a valid, executable JAR.<br>• The properties file defines all required variables.<br>• The host has sufficient memory/CPU for the Java loader.<br>• The script runs under a user with read access to the properties file and write access to the log path. |
| **External Services** | • Hadoop/Hive cluster (accessed by the Java loader).<br>• Possibly a relational DB for audit tables (via the Java loader).<br>• No direct network calls from the shell script itself. |

---

## 4. Interaction with Other Scripts / Components

| Connected Component | How the connection is made |
|---------------------|----------------------------|
| **MNAAS_GBS_Journal_Sqoop_Load.sh** | Likely runs *after* `MNAAS_GBS_Load.sh` to import journal data; both share the same properties file and may be scheduled sequentially. |
| **MNAAS_FailedEvents_tbl_Load.sh** | Consumes failure records generated by the Java loader (if any) and loads them into a “failed events” table. |
| **Other daily aggregation scripts** (`MNAAS_Daily_*`) | Operate on the same data domain (SIM inventory, tolling, etc.) and assume that GBS data is already loaded by this script before they run. |
| **Scheduler (cron, Oozie, Airflow, etc.)** | Calls `MNAAS_GBS_Load.sh` every minute (or at a high frequency) – the script’s internal time‑window logic decides whether to actually launch a load. |
| **Properties file** (`MNAAS_ShellScript.properties`) | Central configuration hub; any change here propagates to all GBS‑related scripts. |
| **Java Loader JAR** (`$GBSLoaderJarPath`) | The core processing engine; any updates to the JAR affect the behavior of this script. |

---

## 5. Operational Risks & Recommended Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Concurrent execution** – the `ps aux | grep -w $MNAASDailyGBSLoadScriptName` check may miss fast‑starting duplicate processes, leading to overlapping loads. | Data corruption, duplicate rows, resource contention. | Replace with a robust lock file (`flock`) or use a PID file; ensure the lock is released on abnormal exit. |
| **Month‑wrap calculation** – `prevMon=$((10#$month-1))` yields `0` for January, causing an invalid period (`0-YYYY`). | Load fails for the first days of the year. | Add logic: if month == 01 → `prevMon=12` and `prevYear=year-1`. |
| **Hard‑coded schedule** – only runs at specific minutes (10‑15) of the 3‑hour marks; any drift in cron timing can skip a run. | Missed loads, stale data. | Externalize schedule to the properties file or use a more tolerant window (e.g., `*/5 * * * *`). |
| **Revalidation flag never enabled** – `reval="N"` is static, making the revalidation block dead code. | Missed data quality checks. | Make `reval` configurable via the properties file or a command‑line argument. |
| **No error handling** – Java exit codes are ignored; script proceeds regardless of failure. | Silent failures, downstream jobs run on incomplete data. | Capture Java exit status (`$?`), log it, and abort or send an alert if non‑zero. |
| **Log path not rotated** – Continuous appends may fill disk. | Disk exhaustion, job stoppage. | Implement log rotation (logrotate) or size‑based rollover within the Java loader. |

---

## 6. Running / Debugging the Script

1. **Prerequisites**  
   ```bash
   export MNAASDailyGBSLoadScriptName=MNAAS_GBS_Load.sh   # or verify it is set in the properties file
   source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_ShellScript.properties
   ```

2. **Manual execution** (useful for a specific period):  
   ```bash
   ./MNAAS_GBS_Load.sh
   ```
   The script already runs with `set -x`, so each command is echoed.

3. **Force a particular mode** (bypass schedule):  
   ```bash
   java -jar $GBSLoaderJarPath "03-2024" Y Y N N $MNAASPropertiesPath/MNAAS_ShellScript.properties $GBSLoaderJavaLogPath
   ```
   This directly invokes the same Java call the script would make.

4. **Check for running instances** (to verify lock logic):  
   ```bash
   ps -ef | grep -w $MNAASDailyGBSLoadScriptName | grep -v grep
   ```

5. **Inspect logs**:  
   ```bash
   tail -f $GBSLoaderJavaLogPath
   ```

6. **Debugging tips**  
   * Add `echo "Period: $period, Mode: traffic"` before each Java call.  
   * Capture the Java exit code: `java -jar … ; rc=$?; echo "Java exit=$rc"` and act on it.  
   * Use `strace -f -e trace=file -p <pid>` to see which HDFS/Hive files are accessed if needed.

---

## 7. External Configuration & Environment Variables

| Variable (populated in `MNAAS_ShellScript.properties`) | Role |
|------------------------------------------------------|------|
| `GBSLoaderJarPath` | Full path to the Java loader JAR. |
| `GBSLoaderJavaLogPath` | Destination file for the Java loader’s stdout/stderr. |
| `MNAASPropertiesPath` | Directory containing the shared properties file (used as a parameter to the Java loader). |
| `MNAASDailyGBSLoadScriptName` | Script name used for the process‑count guard. |
| Any other variables referenced by the Java loader (e.g., Hive DB names, HDFS paths) are also defined here. |

If any of these are missing or point to non‑existent locations, the script will fail early (Java will not start, or the lock check will be inaccurate).

---

## 8. Suggested Improvements (TODO)

1. **Implement a robust lock mechanism** – replace the `ps | grep` guard with `flock -n /tmp/MNAAS_GBS_Load.lock` to guarantee single‑instance execution and automatic cleanup on crash.

2. **Correct month‑wrap logic and make schedule configurable** – add a function `calc_previous_month()` that returns `MM-YYYY` correctly for January, and move all schedule thresholds (`hour`, `minute`, `early_day`) into the properties file for easier tuning.

*(Additional enhancements such as error‑code handling, alerting on failure, and log rotation are also recommended.)*