**High‑Level Documentation – `move-mediation-scripts/bin/processBalBackup.sh`**

---

### 1. Summary
`processBalBackup.sh` is a thin orchestration wrapper that triggers the **BalNotification** Java loader. It loads the shared `MNAAS_ShellScript.properties` configuration, then executes `BalNotification.jar` with the configuration file and a dedicated log file (`MoveBalBNotification.log`). In production the script is invoked (typically by cron) to process balance‑notification backup files, applying any transformations defined in the Java loader and persisting results to downstream stores (e.g., Hadoop/HDFS, relational DBs).  

---

### 2. Key Components

| Component | Type | Responsibility |
|-----------|------|----------------|
| `MNAAS_ShellScript.properties` | Configuration file | Supplies environment variables, file‑system paths, DB/Hadoop credentials, and any job‑specific flags used by the Java loader. |
| `BalNotification.jar` | Java executable (loader) | Implements the business logic for reading balance‑notification backup files, transforming them, and loading them into target systems. Accepts three command‑line arguments: a mode flag (`File`), the path to the properties file, and the path to the log file. |
| `processBalBackup.sh` | Bash wrapper script | Sources the properties file to expose needed variables, then launches the Java loader with appropriate arguments. No internal functions; acts as a single‑step entry point. |
| `MoveBalBNotification.log` | Log file (output) | Captures stdout/stderr from the Java process for operational monitoring and troubleshooting. |

---

### 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | • `MNAAS_ShellScript.properties` (absolute path)<br>• Implicit inputs read by the Java loader: backup files located in directories defined in the properties (e.g., `${BAL_BACKUP_DIR}`)<br>• Environment variables exported by the properties file (e.g., Hadoop classpath, DB connection strings). |
| **Outputs** | • `MoveBalBNotification.log` (log file under `/app/hadoop_users/MNAAS/MNAASCronLogs/`)<br>• Processed data persisted by the Java loader (e.g., HDFS parquet files, DB tables). |
| **Side Effects** | • File system reads/writes (backup files, log file).<br>• Network calls to Hadoop/HDFS, relational DBs, or external APIs as coded in the Java loader.<br>• Potential movement or deletion of source backup files after successful load (depends on loader implementation). |
| **Assumptions** | • Java runtime (compatible version) is installed and on `$PATH`.<br>• The JAR and properties file exist at the hard‑coded locations and have correct permissions.<br>• The properties file contains all required keys; missing keys will cause the Java loader to fail.<br>• The script runs under a user with access to Hadoop resources and the target DB. |

---

### 4. Interaction with Other Scripts / Components

| Connected Script / Component | Relationship |
|------------------------------|--------------|
| `mnaas_move_files_from_staging_genric.sh` | Likely stages raw backup files into the directory referenced by `${BAL_BACKUP_DIR}` before this script runs. |
| `mnaas_parquet_data_load.sh` / `mnaas_parquet_data_load_test.sh` | May consume the output generated by `BalNotification.jar` (e.g., parquet files) for further enrichment or validation. |
| `move_table_compute_stats.sh` | Could be scheduled after this job to compute statistics on the newly loaded balance‑notification tables. |
| `processAsyncBackup.sh` | Handles asynchronous backup processing for other domains; shares the same properties file and logging conventions. |
| Cron scheduler (`crontab`) | Typically invokes `processBalBackup.sh` on a regular cadence (e.g., hourly) as part of the overall “move” pipeline. |
| Hadoop / HDFS cluster | The Java loader writes transformed data to HDFS paths defined in the properties file. |
| Relational DB (e.g., Oracle, PostgreSQL) | If the loader persists to a DB, it uses credentials from the properties file. |

*Note:* Exact file‑paths and table names are defined in `MNAAS_ShellScript.properties`; reviewing that file will reveal the precise integration points.

---

### 5. Operational Risks & Mitigations

| Risk | Impact | Recommended Mitigation |
|------|--------|------------------------|
| **Missing or corrupted JAR / properties file** | Job fails; no data processed. | Add pre‑run existence checks (`[ -f … ]`) and exit with a clear error code; monitor via alert on non‑zero exit status. |
| **Insufficient permissions** (read backup files, write logs, access Hadoop/DB) | Silent failures or partial loads. | Validate permissions at start; log any permission errors; enforce least‑privilege IAM roles. |
| **Unbounded log growth** | Disk exhaustion on the log directory. | Rotate logs (e.g., `logrotate`) and enforce size limits; include timestamped log filenames. |
| **Java OutOfMemory / performance bottlenecks** | Long runtimes, possible data loss. | Tune JVM options (e.g., `-Xmx`) via environment variable in properties; monitor JVM metrics. |
| **Partial data load on failure** (e.g., some files processed, others not) | Inconsistent downstream tables. | Ensure the Java loader implements transactional semantics or writes a “processed” flag file only on success; consider idempotent design. |
| **Hard‑coded absolute paths** | Breaks on environment changes. | Externalize paths to the properties file (already done) and verify they are configurable per environment. |

---

### 6. Running & Debugging the Script

**Typical execution (via cron):**
```bash
# Cron entry (example, runs every hour at minute 15)
15 * * * * /app/hadoop_users/MNAAS/move-mediation-scripts/bin/processBalBackup.sh >> /dev/null 2>&1
```

**Manual run (for testing / debugging):**
```bash
# Switch to the Hadoop user (if not already)
sudo su - hadoop_user

# Execute with shell tracing to see variable expansion
bash -x /app/hadoop_users/MNAAS/move-mediation-scripts/bin/processBalBackup.sh
```

**Debug steps:**
1. Verify the properties file exists and is readable:
   ```bash
   test -r /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_ShellScript.properties && echo OK
   ```
2. Confirm the JAR is present:
   ```bash
   ls -l /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/BalNotification.jar
   ```
3. Run the Java command directly to capture stdout/stderr:
   ```bash
   java -jar /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/BalNotification.jar \
        File \
        /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_ShellScript.properties \
        /tmp/debug.log
   tail -n 50 /tmp/debug.log
   ```
4. Check the production log for errors:
   ```bash
   less /app/hadoop_users/MNAAS/MNAASCronLogs/MoveBalBNotification.log
   ```

---

### 7. External Config / Environment Dependencies

| Item | Usage |
|------|-------|
| `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_ShellScript.properties` | Sourced at script start; defines variables such as `BAL_BACKUP_DIR`, Hadoop classpath, DB URLs, credentials, and any feature flags used by `BalNotification.jar`. |
| `JAVA_HOME` / `java` binary | Required to launch the JAR. |
| `BAL_BACKUP_DIR` (expected key in properties) | Directory where balance‑notification backup files reside; read by the Java loader. |
| `HADOOP_CONF_DIR`, `HADOOP_USER_NAME` (possible keys) | Provide Hadoop client configuration for the loader. |
| Log directory `/app/hadoop_users/MNAAS/MNAASCronLogs/` | Must be writable by the executing user. |

*If any of these keys are missing, the Java loader will likely abort; verify the properties file before deployment.*

---

### 8. Suggested Improvements (TODO)

1. **Add Robust Pre‑flight Checks**  
   Insert shell logic to verify the existence and readability of the properties file, the JAR, and the log directory before invoking Java. Exit with a distinct non‑zero code and write a concise error message to syslog.

2. **Implement Log Rotation / Timestamped Logs**  
   Modify the script to generate logs with a timestamp suffix (e.g., `MoveBalBNotification_$(date +%Y%m%d%H%M).log`) and configure `logrotate` to purge old logs. This prevents disk‑space exhaustion and aids forensic analysis.

---