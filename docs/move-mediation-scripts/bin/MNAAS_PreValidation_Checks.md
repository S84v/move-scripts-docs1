**MNAAS_PreValidation_Checks.sh – High‑Level Documentation**

---

### 1. Purpose (one‑paragraph summary)  
`MNAAS_PreValidation_Checks.sh` is a pre‑processing driver that validates the presence of required “Telena” files before the daily MNAAS loading pipeline proceeds. It reads a shared process‑status file, invokes a Java validation class twice (once for the HOL environment and once for the SNG environment), updates the status file, logs all actions, and on failure generates an email alert and an SDP ticket. The script is intended to run once per day under cron and to gate downstream ingestion jobs.

---

### 2. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| **check_telena_files_HOL** | Sets flag = 1, runs the Java class `com.tcl.mnass.validation.check_for_missing_telena_files` for the HOL environment, logs success/failure, and records whether any missing files were detected. |
| **check_telena_files_SNG** | Sets flag = 2, runs the same Java class for the SNG environment, logs success/failure, and records missing‑file status. |
| **terminateCron_successful_completion** | Resets the process‑status flag to 0, marks job status *Success*, writes run‑time, logs termination, and exits with code 0. |
| **terminateCron_Unsuccessful_completion** | Logs failure, calls `email_and_SDP_ticket_triggering_step`, logs end‑time, and exits with code 1. |
| **email_and_SDP_ticket_triggering_step** | Updates status file to *Failure*, checks whether an SDP ticket/email has already been created, and if not sends a formatted email (via `mail`/`mailx`) to the support mailbox and creates an SDP ticket. |
| **main block** (bottom of file) | Ensures only one script instance runs, reads the current flag from the status file, decides which validation steps to execute (HOL, SNG, or both), and finally calls the appropriate termination routine. |

---

### 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Configuration files** | `MNAAS_ShellScript.properties` (defines all `$MNAAS*` variables, classpath, jar locations, email lists, etc.). |
| **Process‑status file** | `$MNAASConfPath/MNAAS_PreValidation_Checks_ProcessStatusFile` – read/write; holds flags (`MNAAS_Daily_ProcessStatusFlag`, `MNAAS_Daily_ProcessName`, `MNAAS_job_status`, `MNAAS_email_sdp_created`, `MNAAS_job_ran_time`). |
| **Log files** | `$MNAASLocalLogPath/MNAAS_PreValidation_Checks_Log_YYYY-MM-DD` – appended with `logger -s`. |
| **Output file from Java** | `$MNAAS_check_telena_files_filename` – truncated before each run; presence/size indicates missing Telena files. |
| **External services** | - Java runtime (`java` command) invoking the validation JAR.<br>- System mail (`mail`, `mailx`) for alerts.<br>- SDP ticketing system (via email to `insdp@tatacommunications.com`). |
| **Assumptions** | - The properties file exists and defines all referenced variables.<br>- Java class and JAR are present and compatible with the runtime.<br>- The process‑status file is writable by the script user.<br>- `ps` filtering (`grep $Dname_check_telena_files`) correctly detects running instances.<br>- Mail utilities are configured and can reach the distribution lists. |

---

### 4. Interaction with Other Scripts / Components  

| Component | Interaction |
|-----------|-------------|
| **Down‑stream loading scripts** (e.g., `MNAAS_Loading.sh`) | Read the same process‑status file; they start only when `MNAAS_Daily_ProcessStatusFlag=0` and `MNAAS_job_status=Success`. |
| **Other pre‑validation scripts** (e.g., `MNAAS_Activations_seq_check.sh`) | Share the same logging directory and may also trigger SDP tickets; they rely on the same email distribution lists. |
| **Java validation library** (`com.tcl.mnass.validation.check_for_missing_telena_files`) | Performs the actual file‑system checks for Telena files; the script only orchestrates its execution. |
| **Cron scheduler** | The script is typically invoked from a daily cron entry; the PID guard (`ps aux| grep -w $MNAAS_PreValidation_Checks_ScriptName`) prevents overlapping runs. |
| **SDP ticketing system** | Triggered via email; other monitoring tools may watch the mailbox for tickets generated by this script. |

---

### 5. Operational Risks & Recommended Mitigations  

| Risk | Mitigation |
|------|------------|
| **Concurrent execution** – PID check may miss fast‑starting duplicate processes. | Use a lock file (`flock`) or a dedicated PID file in a known location. |
| **Stale process‑status flag** – If the script aborts unexpectedly, flag may stay non‑zero, blocking downstream jobs. | Add a watchdog that resets the flag after a configurable timeout or on manual operator intervention. |
| **Java class failure** – No explicit error handling beyond exit code; missing JAR or classpath errors will cause silent failures. | Validate existence of JAR and class before execution; capture Java stdout/stderr to the log. |
| **Mail/SDP failure** – If mailx is unavailable, failure notification may be lost. | Queue alerts locally and retry; optionally integrate with an API‑based ticketing system. |
| **Hard‑coded date format in log filenames** – May cause log rotation issues. | Centralize log naming logic in the properties file and rotate logs via logrotate. |
| **`ps | grep` false positives** – The grep command may match its own process line. | Use `pgrep -f` or filter out the grep process (`grep -v grep`). |

---

### 6. Running / Debugging the Script  

| Step | Command / Action |
|------|-------------------|
| **Manual execution** | `bash /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_PreValidation_Checks.sh` |
| **Check that only one instance runs** | `ps -ef | grep MNAAS_PreValidation_Checks.sh` |
| **Force a specific flag** (e.g., start at SNG only) | Edit the status file: `sed -i 's/MNAAS_Daily_ProcessStatusFlag=.*/MNAAS_Daily_ProcessStatusFlag=2/' $MNAASConfPath/MNAAS_PreValidation_Checks_ProcessStatusFile` then run the script. |
| **View detailed logs** | `tail -f $MNAASLocalLogPath/MNAAS_PreValidation_Checks_Log_$(date +%F)` |
| **Debug Java call** | Add `-verbose:class` or redirect Java stdout/stderr: `java ... 2>&1 | tee -a $MNAASLocalLogPath/...` |
| **Simulate failure** | Remove or rename the Java JAR, then run; verify that an SDP ticket email is generated. |
| **Check ticket creation** | Search the SDP mailbox (`insdp@tatacommunications.com`) for the subject containing the script name. |

---

### 7. External Configuration / Environment Variables  

| Variable (populated in `MNAAS_ShellScript.properties`) | Role |
|------------------------------------------------------|------|
| `MNAASConfPath` | Directory containing the process‑status file. |
| `MNAASLocalLogPath` | Base directory for script logs. |
| `CLASSPATHVAR` | Additional classpath entries for the Java call. |
| `MNAAS_Main_JarPath` | Path to the JAR that contains `com.tcl.mnass.validation.check_for_missing_telena_files`. |
| `MNAAS_Property_filename` | Path to the generic MNAAS properties file passed to the Java class. |
| `MNAAS_check_telena_files_filename` | Temporary file that the Java class writes missing‑file information to. |
| `MNAAS_seq_check_logpath_Activations` | Path used in email body for log reference. |
| `ccList`, `GTPMailId`, `SDP_ticket_from_email`, `MOVE_DEV_TEAM` | Email distribution lists and sender addresses for alerting. |
| `Dname_check_telena_files` (hard‑coded) | Logical name used for the Java process; also used in PID checks. |

If any of these variables are missing or point to non‑existent locations, the script will fail early (e.g., `sed` will error, Java will not start, mail will bounce).

---

### 8. Suggested Improvements (TODO)  

1. **Implement robust locking** – Replace the current `ps | grep` guard with `flock -n /var/lock/MNAAS_PreValidation_Checks.lock` to guarantee single‑instance execution.  
2. **Centralize error handling** – Wrap the Java invocation in a function that captures stdout/stderr, writes them to the log, and returns a structured error code; also add a sanity check that the JAR and class exist before execution.  

--- 

*End of documentation.*