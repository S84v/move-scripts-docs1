**File:** `move-mediation-scripts/bin/MNAAS_KYC_RNR_hourly_report.sh`  

---

## 1. High‑Level Summary
This Bash script is the hourly driver for the **KYC (RNR) inventory** table used by the Move mediation platform. It ensures only one instance runs at a time, truncates the target Hive table, reloads it from a pre‑generated Hive script, and refreshes the corresponding Impala metadata. Success or failure is recorded in a shared process‑status file and a log file; on failure an SDP ticket email is sent to the Cloudera support mailbox.

---

## 2. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| **`MNAAS_sim_inventory_kyc_rnr_table`** | *Concurrency guard* → checks for existing process, truncates the Hive table, runs the Hive load script via Beeline, refreshes Impala, and logs each step. |
| **`terminateCron_successful_completion`** | Writes “Success” flags to the process‑status file, logs completion timestamp, and exits with status 0. |
| **`terminateCron_Unsuccessful_completion`** | Logs failure timestamp, triggers email notification (`email_on_reject_triggering_step`), and exits with status 1. |
| **`email_on_reject_triggering_step`** | Builds a minimal SDP ticket payload and sends it via `mailx` to `insdp@tatacommunications.com`. |
| **Main program (bottom of file)** | Reads the shared status file, prevents overlapping runs, updates the PID, evaluates the process‑flag, invokes the table‑load function, and finally calls the appropriate termination routine. |

---

## 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Configuration / Env** | Sourced from `MNAAS_KYC_RNR_hourly_report.properties`. Expected variables (non‑exhaustive):<br>• `MNAAS_KYC_RNR_hourly_report_ProcessStatusFileName` – path to the shared status file.<br>• `MNAAS_KYC_RNR_hourly_report_AggrLogPath` – log file path.<br>• `MNAAS_KYC_RNR_hourly_report_Script` – script name (used for logging/email).<br>• `dbname` – Hive database name.<br>• `MNAAS_sim_inventory_kyc_rnr_table` – target Hive table name.<br>• `IMPALAD_HOST` – Impala daemon host.<br>• `msisdn_sim_inventory_kyc_rnr_table_refresh` – Impala `REFRESH` statement.<br>• `MNAASShellScriptPath` – directory containing the Hive load script.<br>• `MNAAS_sim_inventory_kyc_rnr_script` – Hive script file name.<br>• `SDP_ticket_from_email`, `SDP_ticket_cc_email` – email routing for failure tickets. |
| **External Services** | • **Hive** (via Beeline) – table truncate and load.<br>• **Impala** (via `impala-shell`) – metadata refresh.<br>• **Mail system** (`mailx`) – SDP ticket email.<br>• **System logger** (`logger`) – syslog entries. |
| **Primary Input Data** | The Hive load script (`$MNAAS_sim_inventory_kyc_rnr_script`) which contains the SELECT/INSERT logic that populates the KYC RNR inventory table. |
| **Outputs** | • Updated Hive table `$dbname.$MNAAS_sim_inventory_kyc_rnr_table`.<br>• Updated Impala metadata (via `REFRESH`).<br>• Log entries appended to `$MNAAS_KYC_RNR_hourly_report_AggrLogPath`.<br>• Updated flags in `$MNAAS_KYC_RNR_hourly_report_ProcessStatusFileName` (process‑status, PID, success/failure). |
| **Side Effects** | • Potentially long‑running Hive/Impala queries that consume cluster resources.<br>• Email generation on failure (may trigger downstream ticketing workflows). |
| **Assumptions** | • The properties file exists and defines all required variables.<br>• Hive/Impala services are reachable (`192.168.124.88:10000` for HiveServer2, `$IMPALAD_HOST` for Impala).<br>• The process‑status file is writable by the script user and is shared with other Move scripts for concurrency control.<br>• `mailx` is configured to send external mail. |

---

## 4. Interaction with Other Scripts / Components  

| Interaction | Description |
|-------------|-------------|
| **Process‑status file** (`*_ProcessStatusFileName`) | Shared across many Move scripts (e.g., `MNAAS_Daily_Tolling_tbl_Aggr.sh`, `MNAAS_FailedEvents_tbl_Load.sh`). It stores flags (`MNAAS_Daily_ProcessStatusFlag`, `MNAAS_Script_Process_Id`, etc.) used to prevent overlapping executions. |
| **Hive load script** (`$MNAAS_sim_inventory_kyc_rnr_script`) | Generated by upstream data‑preparation jobs (likely a nightly/ hourly ETL that extracts KYC RNR data from source systems). This script is not part of the current repository but is a required artifact. |
| **Impala refresh statement** (`$msisdn_sim_inventory_kyc_rnr_table_refresh`) | Used by downstream reporting jobs that query the KYC RNR inventory via Impala. Those jobs expect the table to be refreshed after each load. |
| **Logging & alerting** | The log file path is also consumed by monitoring dashboards (e.g., Splunk) that track script health. The SDP email triggers the ticketing system used by the operations team. |
| **Potential upstream scripts** | Scripts that populate the source data for the Hive load (e.g., `MNAAS_KYC_RNR_Extract.sh` – not shown) must complete before this hourly driver runs. |

---

## 5. Operational Risks & Recommended Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Concurrent execution** – If the status file is corrupted or the PID check fails, two instances could truncate the table simultaneously. | Data loss / incomplete load. | Add atomic file lock (e.g., `flock`) around the PID update; verify PID existence before proceeding. |
| **Hive truncate failure** – Network glitch or HiveServer2 outage could leave the table partially truncated. | Subsequent load may fail or produce empty table. | Implement retry logic with exponential back‑off; capture Hive error output for diagnostics. |
| **Impala refresh failure** – If Impala is down, downstream consumers will see stale data. | Reporting errors. | Detect non‑zero exit code from `impala-shell`; optionally fall back to a delayed refresh via a separate watchdog script. |
| **Email notification failure** – `mailx` misconfiguration could suppress failure alerts. | Operators unaware of broken pipeline. | Verify mail delivery status (`mailx -v`) and add a fallback to write a file‑based alert in a monitored directory. |
| **Hard‑coded HiveServer2 host** – IP address is static (`192.168.124.88`). | Breaks after infrastructure change. | Move host/IP to the properties file or a central config service. |
| **Unclear exit codes** – The script exits with `0` or `1` only after termination functions; intermediate failures may not propagate. | Automation frameworks may misinterpret status. | Propagate Hive/Impala exit codes to the script’s exit status for more granular monitoring. |

---

## 6. Running / Debugging the Script  

| Step | Command / Action |
|------|-------------------|
| **1. Verify environment** | Ensure the properties file exists: `ls /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_KYC_RNR_hourly_report.properties` |
| **2. Dry‑run with tracing** | `bash -x MNAAS_KYC_RNR_hourly_report.sh` – the script already enables `set -x`, which prints each command and expanded variables. |
| **3. Check process‑status file** | `cat $MNAAS_KYC_RNR_hourly_report_ProcessStatusFileName` – confirm flags are `0` (idle) before starting. |
| **4. Manually invoke the core function** | ```bash\nMNAAS_sim_inventory_kyc_rnr_table\n``` – watch the log file for success/failure messages. |
| **5. Inspect logs** | `tail -f $MNAAS_KYC_RNR_hourly_report_AggrLogPath` while the script runs. |
| **6. Verify Hive table** | After completion, run `beeline -u "jdbc:hive2://192.168.124.88:10000/default" -e "SELECT COUNT(*) FROM $dbname.$MNAAS_sim_inventory_kyc_rnr_table;"` to confirm rows were loaded. |
| **7. Verify Impala refresh** | `impala-shell -i $IMPALAD_HOST -q "SHOW TABLE STATS $dbname.$MNAAS_sim_inventory_kyc_rnr_table;"` – should reflect updated stats. |
| **8. Simulate failure** | Rename the Hive load script temporarily to cause a Beeline error and observe the generated SDP email. |
| **9. Clean up** | If the script hangs, kill the PID recorded in the status file and reset the flag to `0`. |

---

## 7. External Config / Environment Variables  

| Variable | Source | Usage |
|----------|--------|-------|
| `MNAAS_KYC_RNR_hourly_report_ProcessStatusFileName` | `MNAAS_KYC_RNR_hourly_report.properties` | Shared status/lock file. |
| `MNAAS_KYC_RNR_hourly_report_AggrLogPath` | properties | Log file for this script. |
| `MNAAS_KYC_RNR_hourly_report_Script` | properties | Human‑readable script identifier (used in logs & email). |
| `dbname` | properties | Hive database containing the target table. |
| `MNAAS_sim_inventory_kyc_rnr_table` | properties | Target Hive table name. |
| `IMPALAD_HOST` | properties | Hostname/IP of Impala daemon. |
| `msisdn_sim_inventory_kyc_rnr_table_refresh` | properties | Impala `REFRESH` statement (e.g., `REFRESH $dbname.$MNAAS_sim_inventory_kyc_rnr_table;`). |
| `MNAASShellScriptPath` | properties | Directory where the Hive load script resides. |
| `MNAAS_sim_inventory_kyc_rnr_script` | properties | Filename of the Hive load script (`*.hql`). |
| `SDP_ticket_from_email`, `SDP_ticket_cc_email` | properties | Email addresses for SDP ticket generation. |
| `setparameter` (evaluated via `eval $setparameter`) | likely a wrapper script or environment | May inject additional variables (e.g., Java classpath, Hadoop configs). |

If any of these variables are missing, the script will abort with a non‑zero exit code or produce misleading logs.

---

## 8. Suggested Improvements (TODO)

1. **Atomic Locking** – Replace the ad‑hoc PID/status‑file manipulation with `flock` or a Zookeeper lock to guarantee single‑instance execution even under race conditions.
2. **Centralised Configuration** – Move hard‑coded HiveServer2 host (`192.168.124.88`) and other service endpoints into the properties file or a shared configuration service (e.g., Consul) to avoid code changes during infrastructure updates.  

---