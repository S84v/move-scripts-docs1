**High‑Level Summary**  
`MNAAS_create_customer_cdr_traffic_files_retransfer.sh` is a Bash driver that re‑processes a limited set of “traffic” CDR files produced by the Mediation layer for a specific re‑transfer window (e.g. Mar 21 2021). For each incoming file found in the daily staging directory (`$MNAASMainStagingDirDaily_v2`), the script applies per‑customer filter conditions (defined in a property file), writes the filtered rows to customer‑specific backup locations, normalises line endings, sets permissive file modes, generates checksum files, and records progress in a shared *process‑status* file. On success the status file is marked “Success”; on failure an SDP ticket and notification email are raised. The script is scheduled via cron and contains a PID‑guard to prevent concurrent runs.

---

### 1. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| **traffic_file_creation** | Core loop: iterates over all feed sources defined in `FEED_FILE_PATTERN`, selects up‑to `$No_of_files_to_process` newest files, and for each customer creates filtered backup files, removes CR characters, sets `777` permissions, and writes a checksum (`cksum`). Updates the process‑status flag while running. |
| **terminateCron_successful_completion** | Resets the process‑status flag to *idle*, writes success metadata (run time, job status) to the status file, logs completion, and exits with status 0. |
| **terminateCron_Unsuccessful_completion** | Logs failure, invokes ticket/email step (if needed), and exits with status 1. |
| **email_and_SDP_ticket_triggering_step** | On first failure, composes an SDP ticket via `mailx` (to `insdp@tatacommunications.com`) with details and marks the status file so the ticket is not duplicated. |
| **Main script block** | PID guard: reads previous PID from the status file, checks if the process is still alive, writes its own PID, validates the run‑flag, then calls `traffic_file_creation` and the appropriate termination routine. |

---

### 2. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Configuration (sourced)** | `MNAAS_create_customer_cdr_traffic_files.properties` – defines associative arrays (`FEED_FILE_PATTERN`, `FEED_CUSTOMER_MAPPING`, `MNAAS_Create_Customer_traffic_files_filter_condition`, `CUSTOMER_MAPPING`, etc.), numeric limits (`No_of_files_to_process`), delimiters, and directory paths (`MNAASLocalLogPath`, `MNAASConfPath`). |
| **Environment variables** | `MNAAS_Script_Process_Id`, `MNAAS_job_status`, `MNAAS_email_sdp_created`, `SDP_ticket_from_email`, `SDP_ticket_cc_email` – all stored in the *process‑status* file. |
| **File system – inputs** | Staging directory `$MNAASMainStagingDirDaily_v2` (e.g. `/backup1/MNAAS/Mar21_HOL_retransfer`) containing raw traffic files matching patterns from `FEED_FILE_PATTERN`. |
| **File system – outputs** | For each customer: <br>• Backup file `$BackupDir/${MNAAS_Create_Customer_traffic_files_backup_dir[$customer]}/${customer}${delimiter}${filename}` <br>• Corresponding checksum file `${newfilename}_cksum` (named with `$sem_delimiter`). <br>All files receive `chmod 777`. |
| **Logs** | `$MNAASLocalLogPath/MNAAS_Create_Customer_cdr_traffic_files_retransfer.log_YYYY-MM-DD` (stderr redirected). |
| **Process‑status file** | `$MNAASConfPath/MNAAS_Create_Customer_cdr_traffic_files_retransfer_ProcessStatusFile` – holds flags, PID, job status, timestamps, and ticket‑sent flag. |
| **External services** | `logger` (syslog), `mailx` (SDP ticket/email), `awk`, `sed`, `cksum`. |
| **Assumptions** | • All associative arrays and numeric variables are defined in the sourced properties file. <br>• Directories exist and are writable by the script user. <br>• Input files are UTF‑8 with `;` delimiters. <br>• `awk` filter expressions are syntactically correct. |

---

### 3. Integration Points & Connectivity  

| Connection | Description |
|------------|-------------|
| **Sibling “traffic” scripts** | `MNAAS_create_customer_cdr_traffic_files.sh`, `*_crushsftp.sh`, `*_Vivohub_part_retransfer.sh` – share the same property file and status‑file schema; they process the same feed sources but for different operational windows (regular run vs. re‑transfer). |
| **Process‑status file** | Central coordination point used by all CDR‑creation scripts to avoid overlapping runs and to surface job health to monitoring tools. |
| **SDP ticketing system** | Email generated by `mailx` is consumed by the internal SDP ticketing platform (`insdp@tatacommunications.com`). |
| **Cron scheduler** | The script is invoked by a cron entry (not shown) that sets the appropriate environment (e.g., `PATH`, `HOME`). |
| **Down‑stream consumers** | Backup files are later ingested by downstream Hadoop jobs or reporting pipelines (not part of this script but referenced by naming conventions). |
| **Potential upstream** | Mediation layer that drops raw traffic files into `$MNAASMainStagingDirDaily_v2`. |

---

### 4. Operational Risks & Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Missing or malformed property definitions** (e.g., undefined associative arrays) | Script aborts, no files processed, status file left in “running” state. | Validate required variables at start; add a sanity‑check function that exits with a clear error if any key variable is empty. |
| **Permission errors on backup directories** | Files not written, downstream jobs fail. | Ensure the script runs under a dedicated service account with pre‑provisioned ACLs; log `mkdir -p` failures. |
| **Race condition if PID guard fails** (e.g., stale PID) | Duplicate processing, duplicate checksum files. | Add a timeout check: if PID exists but process not running for > X minutes, treat as stale and clear flag. |
| **`awk` filter syntax error** (e.g., bad `$condition`) | No output or malformed backup files. | Run a dry‑run validation of each `$condition` on a sample file; capture `awk` exit code and abort with a logged error. |
| **Unbounded growth of backup directory** | Disk exhaustion. | Implement a retention policy (e.g., delete files older than N days) in a separate housekeeping script. |
| **Email/SDP ticket flood** on repeated failures | Alert fatigue. | The status file flag `MNAAS_email_sdp_created` already prevents duplicate tickets; ensure it is reset on next successful run. |

---

### 5. Running & Debugging the Script  

1. **Manual invocation** (for testing):  
   ```bash
   export MNAASLocalLogPath=/var/log/mnaas
   export MNAASConfPath=/app/hadoop_users/MNAAS/conf
   # Ensure the property file is present and correct
   ./MNAAS_create_customer_cdr_traffic_files_retransfer.sh
   ```
2. **Check PID guard** – view the status file:  
   ```bash
   grep MNAAS_Script_Process_Id $MNAASConfPath/MNAAS_Create_Customer_cdr_traffic_files_retransfer_ProcessStatusFile
   ps -p <pid> -o cmd=
   ```
3. **Inspect logs** – tail the log file for the current date:  
   ```bash
   tail -f $MNAASLocalLogPath/MNAAS_Create_Customer_cdr_traffic_files_retransfer.log_$(date +%F)
   ```
4. **Validate configuration** – run a quick sanity check:  
   ```bash
   source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_create_customer_cdr_traffic_files.properties
   echo "${FEED_FILE_PATTERN[@]}"   # should list patterns
   ```
5. **Force a failure to test ticketing** – temporarily set an invalid `awk` condition, run the script, then verify an email was sent to `insdp@tatacommunications.com`.  
6. **Cleanup after test** – remove any test files from `$BackupDir` and reset the status flag (`Create_Customer_traffic_files_flag=0`) manually if needed.

---

### 6. External Config / Environment References  

| Reference | Purpose |
|-----------|---------|
| `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_create_customer_cdr_traffic_files.properties` | Holds all associative arrays, numeric limits, directory paths, delimiters, and column‑position mappings used by the script. |
| `$MNAASLocalLogPath` | Base directory for log files. |
| `$MNAASConfPath` | Location of the process‑status file. |
| `$MNAASMainStagingDirDaily_v2` (hard‑coded in script) | Source directory for the re‑transfer batch. |
| `$BackupDir` (hard‑coded) | Destination for per‑customer backup files. |
| `$SDP_ticket_from_email`, `$SDP_ticket_cc_email` | Email addresses used when raising an SDP ticket. |
| `mailx` | Sends the ticket email; requires proper MTA configuration on the host. |

---

### 7. Suggested Improvements (TODO)  

1. **Add explicit configuration validation** – a function that checks existence and non‑emptiness of all required associative arrays, numeric variables, and directories before processing begins.  
2. **Parameterise staging & backup directories** – move the hard‑coded paths (`/backup1/MNAAS/Mar21_HOL_retransfer`, `/backup1/MNAAS/24thMar21_CustCDR_reprocess`) into the property file or environment variables to avoid script edits for each re‑transfer window.  

---