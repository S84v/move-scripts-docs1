**File:** `move-mediation-scripts\bin\mnaas_checksum_validation.sh`  

---

### 1. Purpose (One‑paragraph summary)  
`mnaas_checksum_validation.sh` validates the integrity of inbound “raw” data files by comparing a calculated checksum (using a configurable checksum utility) against a companion “SEM” checksum file generated by upstream processes. For each matching pair the script moves the raw file to a process‑specific staging area and archives the SEM file; for mismatches or missing SEM files the raw and SEM files are routed to a reject folder and an audit entry is written to the supplied log. The script is invoked with command‑line options that identify the business process, checksum method, file extension, log location, and a filename pattern to process.

---

### 2. Key Elements  

| Element | Type | Responsibility |
|---------|------|-----------------|
| **`. /app/hadoop_users/MNAAS/MNAAS_Property_Files/mnaaspropertiese.prop`** | External config | Sources environment variables such as `mnaasdatalandingdir`, `staging_dir`, and other path constants used throughout the script. |
| **`getopts` loop** | Argument parser | Reads `-p` (process name), `-c` (checksum command), `-e` (SEM file extension, defaults to `sem`), `-l` (log file path), `-f` (file‑like pattern). |
| **`for raw_file in \`ls -1 $mnaasdatalandingdir/${filelike}\``** | Main iterator | Enumerates every file matching the supplied pattern in the landing directory. |
| **`pre_file=$(echo $raw_file | cut -d'.' -f1)`** | Helper | Derives the base name (without extension) used to locate the corresponding SEM file. |
| **SEM‑file name construction** | Conditional logic | If `processname` is `kycmediation` the SEM file is `${pre_file}.csv.${extension}`; otherwise `${pre_file}.${extension}`. |
| **Checksum calculation** | Core logic | `raw_file_cksum=$(${checksummethod} $raw_file | cut -d' ' -f1)` – runs the supplied checksum utility (e.g., `md5sum`). |
| **SEM checksum read** | Core logic | `sem_file_cksum=$(cut -d' ' -f1 $sem_file)` – extracts the stored checksum from the SEM file. |
| **Comparison & routing** | Decision point | If the two checksums match, the raw file is moved to `${staging_dir}/${processname}/data/` and the SEM file to a backup directory; otherwise both files go to `${staging_dir}/${processname}/reject`. |
| **`logger -s` calls** | Side‑effect | Writes diagnostic messages to syslog (and also to the supplied log file via redirection). |
| **Error handling** | Minimal | Exits early if required arguments are missing; logs missing SEM files; otherwise continues processing. |

---

### 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Command‑line arguments** | `-p <processname>` – logical name of the downstream process (e.g., `kycmediation`).<br>`-c <checksummethod>` – full command to compute checksum (e.g., `md5sum`).<br>`-e <extension>` – file extension for SEM files; defaults to `sem`.<br>`-l <logpath>` – full path to a log file where script‑specific messages are appended.<br>`-f <filelike>` – shell‑style pattern (e.g., `*.csv`) used to select raw files. |
| **External configuration** | `mnaaspropertiese.prop` – defines at least:<br>`mnaasdatalandingdir` – directory where raw files land.<br>`staging_dir` – root staging directory for all processes.<br>Other variables may be referenced (e.g., backup paths). |
| **File system – inputs** | Raw data files matching `${filelike}` in `${mnaasdatalandingdir}`.<br>Corresponding SEM checksum files (`${pre_file}.${extension}` or `${pre_file}.csv.${extension}`). |
| **File system – outputs** | **Success path:**<br>`mv ${raw_file} ${staging_dir}/${processname}/data/`<br>`mv ${sem_file} /backup1/MNAAS/Customer_CDR/Filesbackup/esimhub/Daily_${processname}_BackupDir/`<br>**Reject path:**<br>`mv ${raw_file} ${staging_dir}/${processname}/reject`<br>`mv ${sem_file} ${staging_dir}/${processname}/reject` |
| **Logging / side effects** | Writes to syslog via `logger -s` and to `${logpath}` (error and audit messages). |
| **Assumptions** | • The checksum utility supplied via `-c` exists in `$PATH` and outputs “checksum  filename”.<br>• All directories referenced exist and are writable by the script user.<br>• Filenames contain no spaces or new‑line characters (script uses simple `ls` + word splitting).<br>• The SEM file contains a single checksum token as the first whitespace‑separated field. |

---

### 4. Interaction with Other Components  

| Component | Relationship |
|-----------|--------------|
| **Upstream ingestion scripts** (e.g., `billable_sub_with_charge_and_limit.sh`, `cdr_buid_search_loading.sh`) | Produce the raw files and accompanying SEM checksum files that this script validates. |
| **Downstream processing pipelines** (e.g., Hadoop ingestion, KYC mediation jobs) | Consume the raw files placed under `${staging_dir}/${processname}/data/`. The presence of a matching SEM file in the backup location is used for audit/reconciliation. |
| **Backup / archival system** (`/backup1/MNAAS/Customer_CDR/Filesbackup/...`) | Receives the SEM files for long‑term retention; may be read by audit or re‑processing jobs. |
| **Monitoring / alerting** (e.g., `kycalert.sh`) | May watch the reject directories or log entries for checksum failures and raise alerts. |
| **Scheduler / orchestrator** (cron, Oozie, Airflow) | Executes this script with appropriate arguments on a regular cadence (e.g., nightly). |

---

### 5. Operational Risks & Mitigations  

| Risk | Impact | Recommended Mitigation |
|------|--------|------------------------|
| **Missing or malformed SEM file** | Raw file is rejected, possible data loss if SEM is later regenerated. | Add a pre‑check that logs a warning but optionally allows processing with a “no‑checksum” flag; ensure upstream processes always generate SEM files. |
| **Checksum command mismatch** (e.g., using `md5sum` on a file that should be `sha256sum`) | False rejects or false accepts. | Validate that `${checksummethod}` produces the expected format; consider normalising to a known utility (e.g., always use `md5sum`). |
| **Word‑splitting on filenames with spaces** | Files may be skipped or moved incorrectly. | Replace the `ls`/`for` loop with `find ... -print0 | while IFS= read -r -d '' raw_file; do ...; done`. |
| **Overwrite on move** (target file already exists) | Data loss. | Use `mv -n` or check for existence before moving; optionally timestamp target filenames. |
| **Insufficient permissions** on staging, backup, or reject directories | Script aborts, leaving files in landing area. | Verify directory permissions at start of script; exit with clear error if not writable. |
| **Unbounded log growth** (syslog + custom log) | Disk fill. | Rotate logs via logrotate; limit size of custom log file. |
| **Hard‑coded backup path** (`/backup1/...`) | Inflexibility across environments. | Externalise backup path to the properties file. |

---

### 6. Typical Execution / Debugging  

**Running the script (example):**  

```bash
./mnaas_checksum_validation.sh \
   -p kycmmediation \
   -c md5sum \
   -e sem \
   -l /var/log/mnaas/checksum_validation.log \
   -f "*.csv"
```

**Debugging steps:**  

1. **Enable shell tracing** – prepend `set -x` after the `#!/bin/bash` line (or run `bash -x script.sh …`).  
2. **Verify environment variables** – `echo $mnaasdatalandingdir $staging_dir` after sourcing the properties file.  
3. **Check that the checksum command works** – `md5sum /path/to/sample.raw`.  
4. **Inspect a single file pair manually** – run the checksum extraction commands directly to confirm they match.  
5. **Review logs** – both syslog (`/var/log/messages` or `journalctl`) and the custom log file for entries prefixed by `logger -s`.  
6. **Confirm directory contents** after execution – ensure files appear in `data/`, `reject/`, and backup locations as expected.

---

### 7. External Configurations & Environment Variables  

| Variable (from `mnaaspropertiese.prop`) | Usage |
|------------------------------------------|-------|
| `mnaasdatalandingdir` | Source directory for raw files (`$mnaasdatalandingdir/${filelike}`). |
| `staging_dir` | Base staging path; script builds `${staging_dir}/${processname}/data/` and `${staging_dir}/${processname}/reject`. |
| (Potentially) `MNAAS_move_files_from_staging_{logpath}` | Appears in an error‑logging line; likely a typo – should be `${logpath}`. |
| Any other variables referenced in the backup path (`/backup1/...`) may also be defined here. |

If any of these are missing, the script will fail with “command not found” or “cannot move” errors.

---

### 8. Suggested Improvements (TODO)

1. **Robust file enumeration** – replace the back‑ticked `ls` loop with a `find … -type f -name "$filelike" -print0` pipeline to correctly handle spaces, newlines, and large directories.  
2. **Centralised error handling** – wrap the core logic in a function that returns status codes; add a final `trap` to capture unexpected exits and write a concise summary to the log.  

---