**MNAAS_Customer_SNG_files_Stat_process.sh – High‑Level Documentation**

---

### 1. Purpose (one‑paragraph summary)
This script ingests the daily “SNG Customer Files Statistics” CSV generated by upstream mediation processes, loads it into Hadoop HDFS, stages it in a temporary Hive table, and then overwrites the partitioned production Hive/Impala table used for KPI measurement. It updates a shared process‑status file, performs housekeeping (old KPI files removal), and on failure generates an SDP ticket and notification email. The script is idempotent across runs and guarded against concurrent execution.

---

### 2. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|-----------------|
| **load_backup_files_records_to_temp_table** | Checks for the presence of the CSV for the target date, copies it to HDFS, truncates the temporary Hive table, loads the CSV into that table, and records success/failure in the process‑status file. |
| **insert_data_to_mainTable** | Moves data from the temporary Hive table into the partitioned production table, refreshes the Impala metadata, deletes KPI measurement files older than 30 days, and logs completion. |
| **terminateCron_successful_completion** | Resets status flags to “Success”, writes final timestamps to the status file, logs termination, and exits with code 0. |
| **terminateCron_Unsuccessful_completion** | Logs failure, optionally triggers email/SDP ticket (only in PROD), writes failure status, and exits with code 1. |
| **email_and_SDP_ticket_triggering_step** | Sends a formatted email to the support mailbox and marks the ticket‑created flag to avoid duplicate alerts. |
| **Main program block** | Prevents parallel runs by checking the PID stored in the status file, decides which steps to run based on the current flag (0/1 → load + insert, 2 → insert only), and drives the overall flow. |

---

### 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Input parameters** | Optional command‑line argument `prev_date` (format `YYYYMMDD`). If omitted, defaults to yesterday’s date. |
| **Configuration file** | `MNAAS_Customer_SNG_files_Stat_process.properties` – defines all environment‑specific variables (paths, table names, Hive DB, Impala host, log file, status file, etc.). |
| **External services** | - Hadoop HDFS (`hadoop fs` commands) <br> - Hive (`hive -e`) <br> - Impala (`impala-shell`) <br> - Mail system (`mailx`) <br> - Underlying OS (process table, `ps`, `find`, `sed`, `logger`). |
| **Primary data source** | CSV file `${MNAAS_Customer_SNG_Stat_file_path}/SNG_Customer_files_Stat_process_${prev_date}.csv`. |
| **Outputs** | - Data loaded into Hive table `$dbname.$customers_files_sng_records_count_tblname` (partitioned by `file_date`). <br> - Updated process‑status file (`$MNAAS_Customer_SNG_files_Stat_process_ProcessStatusFileName`). <br> - Log file (`$MNAAS_Customer_SNG_files_Stat_process_logpath`). |
| **Side effects** | - HDFS directory `$MNAAS_Customer_SNG_filename_hdfs_customer/*` cleared and repopulated. <br> - Temporary Hive table truncated and re‑loaded. <br> - Old KPI measurement files under `/app/hadoop_users/MNAAS/SNG_KPI_Measurement` older than 30 days are deleted. <br> - In PROD, an email/SDP ticket may be raised on failure. |
| **Assumptions** | - The CSV for the target date will appear within a reasonable window; otherwise the script loops indefinitely. <br> - Hive/Impala services are reachable and the user has required permissions. <br> - `mailx` is configured to send external mail. <br> - The status file is writable by the script’s user. |

---

### 4. Integration Points (how it connects to other scripts/components)

| Connected Component | Interaction |
|---------------------|-------------|
| **Upstream CSV generator** (e.g., `MNAAS_Customer_Master.sh` or other mediation jobs) | Produces the daily `SNG_Customer_files_Stat_process_YYYYMMDD.csv` in `${MNAAS_Customer_SNG_Stat_file_path}`. |
| **Process‑status file** (`*_ProcessStatusFileName`) | Shared with many Move scripts; flags (`MNAAS_Daily_ProcessStatusFlag`) drive conditional execution across the pipeline. |
| **Hive/Impala tables** (`$customers_files_sng_inter_record_count_tblname`, `$customers_files_sng_records_count_tblname`) | Populated here; downstream reporting/analytics jobs read from the partitioned production table. |
| **SDP ticketing/email** | On failure, this script sends an email that is consumed by the SDP ticketing system (external to Move). |
| **Cron scheduler** | Typically invoked nightly via a cron entry; the script itself guards against overlapping runs. |
| **House‑keeping scripts** (e.g., `MNAAS_Customer_SNG_files_Stat_process.sh` may be called by a master orchestration script that sequences multiple Move jobs). |

---

### 5. Operational Risks & Recommended Mitigations  

| Risk | Mitigation |
|------|------------|
| **Infinite loop if CSV never arrives** (`while [ 0 ]` never exits) | Add a maximum retry count or timeout; exit with a clear error after N attempts. |
| **Concurrent execution leading to race conditions** | The PID check already prevents it, but ensure the status file is on a reliable shared filesystem and that the PID is cleared on abnormal termination. |
| **Partial load due to Hive/Impala failure** | Wrap Hive/Impala commands in transactions where possible; verify row counts after load and retry on mismatch. |
| **Stale KPI files not cleaned** (if `find … -delete` fails) | Log the exit status of the `find` command; consider moving old files to an archive directory instead of deletion. |
| **Email/SDP flood on repeated failures** | The script checks `MNAAS_email_sdp_created` flag; ensure the flag is reset on the next successful run. |
| **Hard‑coded paths & credentials** | Externalize all paths, DB names, and credentials in the properties file; restrict file permissions. |
| **Missing environment variable `ENV_MODE`** | Default to a safe value (e.g., `DEV`) and log a warning if undefined. |

---

### 6. Running / Debugging the Script  

| Step | Command / Action |
|------|-------------------|
| **Typical nightly execution** | `./MNAAS_Customer_SNG_files_Stat_process.sh` (no args → uses yesterday). |
| **Force a specific date** | `./MNAAS_Customer_SNG_files_Stat_process.sh 20231101` |
| **Enable shell tracing for debugging** | Uncomment `set -x` near the top of the script or run `bash -x MNAAS_Customer_SNG_files_Stat_process.sh`. |
| **Check current status flag** | `grep MNAAS_Daily_ProcessStatusFlag $MNAAS_Customer_SNG_files_Stat_process_ProcessStatusFileName` |
| **View recent log entries** | `tail -f $MNAAS_Customer_SNG_files_Stat_process_logpath` |
| **Force re‑run when flag is stuck** | Manually set flag to `0` in the status file, then restart the script. |
| **Validate Hive load** | After run, query Hive: `SELECT COUNT(*) FROM $dbname.$customers_files_sng_records_count_tblname WHERE file_date='${prev_date}';` |
| **Check Impala refresh** | `impala-shell -i $IMPALAD_HOST -q "SHOW TABLES LIKE '$customer_files_record_count_tblname';"` |

---

### 7. External Configuration & Environment Variables  

| Variable (from properties) | Meaning |
|----------------------------|---------|
| `MNAAS_Customer_SNG_files_Stat_process_logpath` | Full path to the script’s log file. |
| `MNAAS_Customer_SNG_files_Stat_process_ProcessStatusFileName` | Shared status file that stores flags, PID, timestamps, etc. |
| `MNAAS_Customer_SNG_Stat_file_path` | Directory where the daily CSV is placed by upstream jobs. |
| `MNAAS_Customer_SNG_filename_hdfs_customer` | HDFS target directory for the CSV. |
| `dbname` | Hive database name. |
| `customers_files_sng_inter_record_count_tblname` | Temporary Hive table name. |
| `customers_files_sng_records_count_tblname` | Production partitioned Hive table name. |
| `IMPALAD_HOST` | Hostname/IP of the Impala daemon used for metadata refresh. |
| `customer_files_record_count_tblname_refresh` | Impala `REFRESH` statement (e.g., `REFRESH $dbname.$customers_files_sng_records_count_tblname;`). |
| `ENV_MODE` | Execution environment (`PROD`, `DEV`, etc.) – controls whether email/SDP is triggered. |
| `MNAAS_Customer_SNG_files_Stat_process_Scriptname` | Usually set to the script filename for logging. |

*All of the above are sourced from `MNAAS_Customer_SNG_files_Stat_process.properties`. The script assumes the file exists and is readable.*

---

### 8. Suggested Improvements (TODO)

1. **Add a retry/timeout mechanism** for the CSV‑availability loop to avoid endless CPU consumption when the upstream file is missing.  
2. **Externalize the “30‑day” retention period** into the properties file and log the number of files actually deleted, making housekeeping configurable and auditable.  

---