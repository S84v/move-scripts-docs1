**File:** `move-mediation-scripts\bin\MNAAS_Weekly_KYC_Feed_Loading.sh`  

---

### 1. High‑Level Summary
This Bash script is the weekly ingestion driver for the **KYC (Know‑Your‑Customer) feed**. It validates incoming usage files, removes duplicates, verifies SHA‑256 checksums, routes good files to the “sequence‑check” staging area, rejects corrupted files, and updates a shared process‑status file. It also generates operational alerts (email & SDP tickets) when expected files are missing or when Windows‑based Telena feed jobs stop delivering data.

---

### 2. Core Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| **FilesDupsCheck** | - Marks process start in the status file.<br>- Scans the daily staging directory for files matching `$Weekly_KYC_Feed_Weekly_Usage_ext`.<br>- Uses `$MNAASInterFilePath_Dups_Check` to detect duplicates.<br>- Moves duplicate files to `$DupsFilePath`; logs non‑duplicates. |
| **mv_Weekly_KYC_Feed_usage_files** | - Updates status flag to *running*.<br>- If no files are present, checks elapsed time since last successful run; if >24 h, logs a missing‑file alert and optionally sends a “delay” email/SDP ticket.<br>- If files appear after a delay, sends a “recovery” email.<br>- For each file: verifies existence of a matching `.sha256` checksum file, compares hashes, and moves the file to either the sequence‑check directory (`$MNAASMainStagingDirDaily_afr_seq_check`) or the reject directory (`$MNAASRejectedFilePath`).<br>- Updates the last‑process‑time and resets the delay‑email flag. |
| **terminateCron_successful_completion** | - Writes *Success* status, clears the running flag, timestamps the run, logs completion, and exits 0. |
| **terminateCron_Unsuccessful_completion** | - Logs failure, optionally triggers an SDP ticket, and exits 1. |
| **email_and_SDP_ticket_triggering_step** | - Sends a generic “script failure” SDP ticket/email (once per run) using `mailx`. |
| **email_and_SDP_ticket_triggering_step_validation** | - Sends a formatted HTML email to the Windows/Telena team indicating whether the Telena job is receiving files.<br>- If the job is not receiving files, also creates an SDP ticket via `mailx`. |
| **Main Execution Block** | - Reads the previous PID from the status file and ensures only one instance runs (PID guard).<br>- Based on the current flag (`0,1,2`) decides whether to run duplicate check, file move, or both.<br>- Handles unknown flag values as errors. |

---

### 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Input Files** | - Incoming usage files: `$MNAASMainStagingDirDaily/$Weekly_KYC_Feed_Weekly_Usage_ext` (e.g., `*.csv`).<br>- Corresponding checksum files: same name with `.sha256` suffix.<br>- Duplicate‑check reference file: `$MNAASInterFilePath_Dups_Check`. |
| **Configuration** | Sourced from `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Daily_KYC_Feed.properties`. This file defines all path variables, email addresses, job names, and flag names used throughout the script. |
| **State Files** | - Process‑status file: `$MNAAS_Weekly_KYC_Feed_ProcessStatusFileName` (holds flags, timestamps, PID, email‑sent flag, etc.). |
| **Outputs / Side Effects** | - Good files → `$MNAASMainStagingDirDaily_afr_seq_check/` (ready for downstream Hadoop load).<br>- Duplicate files → `$DupsFilePath` (archival).<br>- Corrupt/ checksum‑mismatch files → `$MNAASRejectedFilePath`.<br>- Log entries → `$MNAAS_Weekly_KYC_Feed_LogPath`.<br>- Email alerts via `mailx` and `sendmail`.<br>- SDP tickets via `mailx` to `insdp@tatacommunications.com`. |
| **Assumptions** | - All directories exist and are writable by the script user.<br>- `mailx` and `/usr/sbin/sendmail` are correctly configured and reachable.<br>- The properties file supplies valid values for every referenced variable.<br>- SHA‑256 checksum files are generated by the upstream system. |

---

### 4. Interaction with Other Components  

| Component | Interaction Point |
|-----------|-------------------|
| **Upstream File Producer** | Places daily KYC usage files (and `.sha256` files) into `$MNAASMainStagingDirDaily`. |
| **Duplicate‑Detection Service** | Provides `$MNAASInterFilePath_Dups_Check` – a flat file listing previously processed filenames. |
| **Windows Telena Feed Job** | Monitored via email alerts; the script references `$MNAAS_Telena_feed_windows_Job_name`, `$MNAAS_Telena_feed_windows_server`, `$MNAAS_Telena_feed_windows_user`. |
| **Downstream Hadoop Load** | Consumes files from `$MNAASMainStagingDirDaily_afr_seq_check/` after this script finishes successfully. |
| **SDP Ticketing System** | Receives tickets via `mailx` (subject “Incident”) to `insdp@tatacommunications.com`. |
| **Process‑Status Coordination** | Other scripts in the MNAAS suite read/write the same status file (`$MNAAS_Weekly_KYC_Feed_ProcessStatusFileName`) to coordinate execution order and avoid overlap. |

---

### 5. Operational Risks & Recommended Mitigations  

| Risk | Mitigation |
|------|------------|
| **Stale PID guard** – If the script crashes, the PID remains in the status file, preventing future runs. | Implement a lock file with `flock` and a timeout; or add a health‑check that clears the PID if the process no longer exists. |
| **Missing checksum file** – Files without a `.sha256` are silently ignored, potentially causing data loss. | Treat missing checksum as a failure and move the file to the reject folder with a clear log entry. |
| **Duplicate detection false‑positive** – Legitimate files may be moved to the duplicate archive. | Periodically audit the duplicate‑check file; consider adding a hash‑based duplicate check instead of name‑only. |
| **Email/SDP failure** – Alerts may not be sent, leaving operators unaware of issues. | Capture the exit status of `mailx`/`sendmail` and retry or write to a separate “alert‑failure” log. |
| **Disk‑space exhaustion** – Large volumes of rejected or duplicate files can fill the filesystem. | Add a housekeeping job to purge old files; monitor directory sizes via Nagios/Prometheus. |
| **Hard‑coded paths** – Changes to directory layout require script edits. | Externalize all paths in the properties file (already done) and validate them at start‑up. |

---

### 6. Running / Debugging the Script  

| Step | Command / Action |
|------|-------------------|
| **Manual execution** | `bash /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Daily_KYC_Feed.properties && /path/to/MNAAS_Weekly_KYC_Feed_Loading.sh` (ensure the properties file is sourced). |
| **Enable verbose tracing** | Uncomment the `set -x` line near the top of the script. |
| **Check current status** | `grep -E 'MNAAS_Weekly_ProcessStatusFlag|MNAAS_job_status' $MNAAS_Weekly_KYC_Feed_ProcessStatusFileName` |
| **View recent logs** | `tail -n 50 $MNAAS_Weekly_KYC_Feed_LogPath` |
| **Force a run despite existing PID** | Delete the PID line from the status file or use `kill -9 <old_pid>` before re‑running. |
| **Validate checksum logic** | Manually compute a hash: `sha256sum <file>` and compare with the contents of `<file>.sha256`. |
| **Test email alerts** | Run `email_and_SDP_ticket_triggering_step_validation "Weekly_KYC_Feed" "csv" "JobX" "winSrv" "user" "to@example.com" "cc@example.com" "from@example.com" "Yes"` and verify receipt. |

---

### 7. External Configuration & Environment Variables  

| Variable (populated in the sourced properties file) | Purpose |
|----------------------------------------------------|---------|
| `MNAAS_Weekly_KYC_Feed_LogPath` | Path to the script’s log file. |
| `MNAAS_Weekly_KYC_Feed_ProcessStatusFileName` | Shared status/flag file used for coordination. |
| `MNAASMainStagingDirDaily` | Directory where inbound KYC files land. |
| `Weekly_KYC_Feed_Weekly_Usage_ext` | File extension/pattern for the usage files (e.g., `*.csv`). |
| `DupsFilePath` | Archive location for duplicate files. |
| `MNAASInterFilePath_Dups_Check` | Flat file containing names of previously processed files. |
| `MNAASMainStagingDirDaily_afr_seq_check` | Destination for checksum‑validated files. |
| `MNAASRejectedFilePath` | Destination for files failing checksum validation. |
| `MNAAS_Telena_feed_windows_Job_name`, `MNAAS_Telena_feed_windows_server`, `MNAAS_Telena_feed_windows_user` | Metadata used in alert emails. |
| `MOVE_TELENA_WINDOWS_TO_EMAIL`, `MOVE_TELENA_WINDOWS_CC_EMAIL` | Email recipients for Telena‑job status notifications. |
| `MNAAS_support_team_email`, `SDP_ticket_from_email`, `MOVE_DEV_TEAM` | Addresses used when creating SDP tickets. |
| `MNAAS_Weekly_KYC_Feed_ScriptName` | Human‑readable script identifier (used in logs/tickets). |
| `setparameter` | Likely a wrapper that sets `set -euo pipefail` or similar; defined elsewhere. |

If any of these variables are missing or point to non‑existent paths, the script will fail early (e.g., `mv` will error). Validation of the properties file at start‑up is recommended.

---

### 8. Suggested Improvements (TODO)

1. **Replace PID‑file guard with `flock`** – Guarantees atomic lock acquisition and automatic release on process exit, eliminating stale‑PID scenarios.  
2. **Add explicit error handling for missing directories/files** – Before each `mv` or `ls`, test existence (`[[ -d $dir ]] || exit 1`) and log a clear error; optionally create missing directories on the fly.  

--- 

*End of documentation.*