**High‑Level Documentation – `move-mediation-scripts/bin/scp.sh`**

---

### 1. Summary
`scp.sh` is a Bash utility that copies a set of “missing” data files from a customer‑specific backup directory on the edge node to a staging area on a remote host (`mtthdoped01`). The list of missing files is read from `finalres.txt` (produced by earlier processing steps). After transfer, the script decompresses any `.gz` archives on the remote host. It is typically invoked as part of a larger data‑move pipeline that first identifies missing files, then stages them for downstream processing.

---

### 2. Key Components

| Component | Type | Responsibility |
|-----------|------|----------------|
| `declare -A MNAAS_backup_files_edgenode2_backup_dir` | Bash associative array | Maps a customer identifier (`cust`) to its backup root directory. |
| `cust=$1` / `pname=$2` | Script arguments | `cust` – customer code (e.g., `redONE`).<br>`pname` – product or process name used to locate sub‑directory under the backup root. |
| `processingdir=/app/hadoop_users/Lavanya` | Variable | Base directory where the file list (`finalres.txt`) resides. |
| `copyFrom` | Variable | Fully‑qualified source path built from the associative array and `pname`. |
| `tempdir` | Variable | Remote staging directory on `mtthdoped01` (`/backup1/Lavanya/missingfiles/$cust/$pname`). |
| `while read missingfname … done < $processingdir/finalres.txt` | Loop | Reads each base filename from `finalres.txt` and issues an `scp` for all matching files (`$missingfname.*`). |
| `ssh mtthdoped01 "mkdir -p $tempdir"` | Remote command | Ensures the remote staging directory exists. |
| `ssh mtthdoped01 "gunzip $tempdir/*.gz"` | Remote command | Decompresses any transferred gzip archives. |
| `printf "copied"` | Output | Simple confirmation printed to STDOUT. |

---

### 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | 1. Positional arguments: `<cust>` and `<pname>`.<br>2. `finalres.txt` located at `$processingdir/finalres.txt` (list of missing base filenames, one per line).<br>3. The associative array entry for the supplied `<cust>` (must exist). |
| **Outputs** | - Files copied to `$tempdir` on `mtthdoped01`.<br>- Decompressed files (`*.gz` → original) on the remote host.<br>- Console text `copied`. |
| **Side Effects** | - Remote directory creation (`mkdir -p`).<br>- Potential overwriting of existing files with the same name in `$tempdir`.<br>- Consumption of network bandwidth and remote disk space. |
| **External Dependencies** | - SSH key‑based (or password) access to `mtthdoped01`.<br>- `scp` and `ssh` binaries on the local host.<br>- Read/write permissions on the source backup directory and on the remote staging path.<br>- Sufficient disk space on both source and destination. |
| **Assumptions** | - The associative array contains a valid entry for the supplied customer.<br>- `finalres.txt` is correctly generated by upstream scripts (e.g., `processBalBackup.sh`).<br>- All files to be copied have a common prefix matching a line in `finalres.txt` and an arbitrary extension (`*`).<br>- Remote host `mtthdoped01` is reachable and has the same directory layout (`/backup1/Lavanya/...`). |

---

### 4. Interaction with Other Scripts / Components

| Connected Script / Component | Relationship |
|------------------------------|--------------|
| **Upstream file‑list generators** (e.g., `processBalBackup.sh`, `processNotifBackup.sh`) | Produce `finalres.txt` that drives the copy loop. |
| **Backup directory provisioning** (e.g., `runGBS.sh`, `runMLNS.sh`) | Populate the source directories referenced via `MNAAS_backup_files_edgenode2_backup_dir`. |
| **Downstream processing** (e.g., `move_table_compute_stats.sh`, `runBARep.sh`) | Consume the staged files on `mtthdoped01` after they are decompressed. |
| **Configuration / environment** | The hard‑coded associative array could be shared with other scripts that need the same mapping; any change must be mirrored across them. |
| **Monitoring / orchestration** (e.g., cron jobs, Airflow DAGs) | Likely invoked as a step in a larger workflow that ensures data completeness before analytics jobs run. |

---

### 5. Operational Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Missing associative‑array entry** | Script aborts or copies from an empty path. | Validate `$cust` against the array; exit with clear error if not found. |
| **`finalres.txt` absent or malformed** | No files transferred, silent failure. | Check file existence and non‑empty before entering loop; log error if empty. |
| **Network/SSH failure** | Partial copy, hanging job. | Enable `-o ConnectTimeout` and retry logic; capture exit status of `scp`/`ssh`. |
| **Disk‑space exhaustion on remote host** | Transfer fails, incomplete data set. | Pre‑check remote free space (`ssh mtthdoped01 "df -k $tempdir"`). |
| **File overwrite** | Unexpected data loss if older files are replaced. | Use a unique staging sub‑directory per run (e.g., timestamp) or add `-n` flag to `scp` to avoid overwriting. |
| **Uncompressed large files** | High CPU / I/O load on remote host. | Optionally limit parallelism or schedule decompression during off‑peak windows. |
| **Hard‑coded host name** | Lack of flexibility across environments (dev/test/prod). | Externalize host name to a config file or environment variable. |

---

### 6. Typical Execution & Debugging

**Running the script**

```bash
# Example: copy missing files for customer redONE, product "balance"
./scp.sh redONE balance
```

**Debugging steps**

1. **Enable Bash tracing** – prepend `set -x` at the top of the script or run with `bash -x scp.sh …`.
2. **Verify inputs** – `echo "Source: $copyFrom"` and `echo "Remote dir: $tempdir"`.
3. **Check `finalres.txt`** – `cat /app/hadoop_users/Lavanya/finalres.txt`.
4. **Test a single file copy** – manually run `scp $copyFrom/somefile.* mtthdoped01:$tempdir`.
5. **Inspect remote side** – `ssh mtthdoped01 "ls -l $tempdir"` and `ssh mtthdoped01 "gunzip -t $tempdir/*.gz"`.

All output (including errors) should be redirected to a log file for post‑run analysis, e.g.:

```bash
./scp.sh redONE balance > /var/log/scp_redONE_balance.log 2>&1
```

---

### 7. External Configuration / Environment Variables

| Item | Current Usage | Suggested Externalization |
|------|---------------|---------------------------|
| `MNAAS_backup_files_edgenode2_backup_dir` mapping | Hard‑coded associative array in script. | Move to a shared config file (e.g., `/etc/mnaas/backup_dirs.conf`) and source it. |
| Remote host name `mtthdoped01` | Inline literal in `ssh`/`scp` commands. | Use an environment variable `MNAAS_REMOTE_HOST` or config entry. |
| `processingdir` | Fixed path `/app/hadoop_users/Lavanya`. | Parameterize via env var `MNAAS_PROC_DIR` for flexibility across environments. |

---

### 8. Suggested Improvements (TODO)

1. **Robust error handling & logging** – capture exit codes of `scp` and `ssh`, write structured logs (timestamp, file, status) to a central location.
2. **Configuration refactor** – externalize the customer‑to‑backup‑path map, remote host, and processing directory into a single YAML/INI file and source it at runtime, enabling easier updates and environment‑specific overrides.