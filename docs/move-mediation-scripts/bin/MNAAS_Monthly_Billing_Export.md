**File:** `move-mediation-scripts\bin\MNAAS_Monthly_Billing_Export.sh`

---

### 1. High‑Level Summary
This shell script orchestrates the monthly billing data export for the MNAAS platform. It first loads a shared Java‑batch property file, then launches two Java batch jobs:

1. **BillingExport.jar** – Generates the primary monthly billing report (SIM, usage, MYR, ELUX, JLR) for a supplied month/year.
2. **KLMExport.jar** – Produces a KLM‑specific traffic export for the previous month.

Both jobs write operational details to a common log file (`Export.log`). The script is typically invoked by a cron job to produce the reports for the prior month, but can be run manually with custom parameters.

---

### 2. Key Components & Responsibilities

| Component | Type | Responsibility |
|-----------|------|----------------|
| `MNAAS_Monthly_Billing_Export.sh` | Bash wrapper | Sources shared properties, assembles arguments, invokes Java batch jobs, and directs logging. |
| `MNAAS_Java_Batch.properties` | Property file | Holds environment‑specific configuration (DB URLs, Hadoop paths, credentials, etc.) consumed by both Java jars. |
| `BillingExport.jar` | Java batch application | Reads the property file, extracts billing data for the month supplied (`args[0]`), and creates the SIM, usage, MYR, ELUX, and JLR reports. |
| `KLMExport.jar` | Java batch application | Generates a KLM traffic temporary table/export for the previous month (or a supplied month). |
| `Export.log` | Log file | Centralised stdout/stderr capture for both Java jobs; used for audit and troubleshooting. |

*No explicit functions are defined inside the script; the entire logic is linear.*

---

### 3. Inputs, Outputs, Side‑Effects & Assumptions

| Category | Details |
|----------|---------|
| **Inputs** | 1. **Hard‑coded arguments** passed to each Java jar (see script). <br>2. Property file path (`/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`). |
| **Outputs** | 1. Report files generated by the Java jobs (location defined inside the jars – typically HDFS or a staging directory). <br>2. `Export.log` containing execution details and any error messages. |
| **Side‑effects** | - Potential writes to staging tables / temporary Hive tables. <br>- May trigger downstream downstream processes (e.g., billing ingestion pipelines). |
| **Assumptions** | - Java 8+ runtime is available to the `MNAAS` Hadoop user. <br>- The property file exists and contains valid credentials/paths. <br>- Both JAR files are present and executable (`chmod +x` not required, just `java -jar`). <br>- Sufficient disk space for logs and temporary data. <br>- The script runs under the `MNAAS` Linux user with appropriate HDFS and DB permissions. |

---

### 4. Integration Points with Other Scripts / Components

| Connected Component | Interaction |
|---------------------|-------------|
| **Data Load Scripts** (e.g., `MNAAS_MSISDN_Level_Daily_Usage_Aggr.sh`, `MNAAS_Load_SOTA_Table.sh`) | Populate source tables / Hive partitions that `BillingExport.jar` reads. |
| **Missing Customer Files / IMEI Change Scripts** | May affect the completeness of the billing data; they run earlier in the nightly/weekly cycle. |
| **Downstream Billing System** | Consumes the exported files produced by the two JARs (often via SFTP or a shared HDFS location). |
| **Cron Scheduler** (`MNAAS_Monthly_Billing_Export.cron` or similar) | Triggers this script on a monthly basis (typically on the 2nd day of the month). |
| **Monitoring/Alerting** (e.g., Nagios, Splunk) | Watches `Export.log` for error patterns or non‑zero exit codes. |
| **Property Management** (`MNAAS_Java_Batch.properties`) | Shared across many batch jobs; changes here affect all downstream exports. |

---

### 5. Operational Risks & Recommended Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Missing/Corrupt Property File** | Jobs fail early, no reports generated. | Add pre‑run check: `[[ -f $PROP_FILE ]] || { echo "Missing properties"; exit 1; }`. |
| **Jar Not Found or Not Executable** | Immediate script abort; downstream pipelines stall. | Verify jar existence and permissions at start; alert on failure. |
| **Incorrect Month Argument** (e.g., typo in `2022-10`) | Generates report for wrong period, leading to billing errors. | Accept month as a parameter; validate format (`^[0-9]{4}-[0-9]{2}$`). |
| **Log File Growth** | Disk exhaustion on the Hadoop node. | Implement log rotation (e.g., `logrotate`) or truncate after each run. |
| **Java Out‑Of‑Memory / Performance Issues** | Partial data export, long runtimes. | Tune JVM options in the property file; monitor memory usage. |
| **Silent Failure (non‑zero exit not captured)** | Operators assume success. | Capture `$?` after each `java -jar` call and exit script with that code if non‑zero. |
| **Concurrent Runs** (cron overlapping) | Data corruption or lock contention. | Use a lock file (`flock`) to ensure single instance. |

---

### 6. Example Execution & Debugging Steps

**Typical Cron Invocation (no arguments):**
```bash
0 2 2 * * /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Monthly_Billing_Export.sh
```

**Manual Run (override month):**
```bash
# Export for March 2023
MNAAS_Monthly_Billing_Export.sh 2023-03
```
*(Note: the script currently ignores passed arguments; a future improvement would forward them to the JARs.)*

**Debugging Checklist:**
1. Verify property file: `cat /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`.
2. Confirm JARs exist: `ls -l /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/{BillingExport,KLMExport}.jar`.
3. Run each jar manually to see detailed output:
   ```bash
   java -jar BillingExport.jar 2022-10 /path/to/properties /tmp/debug.log M Y Y N Y Y
   ```
4. Check `Export.log` for stack traces or error codes.
5. Examine downstream staging directories (as defined in the property file) for generated files.
6. Use `echo $?` after each Java call to confirm exit status.

---

### 7. External Configuration / Environment Dependencies

| Item | Usage |
|------|-------|
| `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties` | Provides DB/HDFS connection strings, credentials, and job‑specific parameters consumed by both Java jars. |
| `Export.log` (`/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log`) | Central log for this script; location is hard‑coded. |
| Java runtime (`java` command) | Must be on the `PATH` for the `MNAAS` user; version compatibility with the JARs is assumed. |
| Hadoop user home (`/app/hadoop_users/MNAAS/`) | Base directory for all scripts, jars, and logs; permissions must allow read/write. |
| Environment variables (e.g., `HADOOP_CONF_DIR`, `JAVA_HOME`) | Not referenced directly in the script but required for Hadoop‑related operations inside the JARs. |

---

### 8. Suggested Improvements (TODO)

1. **Parameterise the script** – Accept month/year and report flags as command‑line arguments and forward them to the Java jobs instead of hard‑coding values. This will make the script reusable for back‑fills and testing.
2. **Add robust error handling** – After each `java -jar` invocation, capture the exit code, log a clear success/failure message, and exit the script with a non‑zero status on failure. Also implement a lock (`flock`) to prevent overlapping runs.

---