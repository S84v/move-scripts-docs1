**File:** `move-mediation-scripts/bin/MNAAS_backup_SDP_ticket_validation.sh`

---

## 1. Purpose (one‑paragraph summary)

This Bash script validates the daily backup of SDP (Service Data Processing) ticket files generated by the mediation pipeline. It checks two conditions for each customer/process pair: (a) whether a new file has been **generated** within the last hour, and (b) whether any generated files remain **unprocessed** for more than 60 minutes. The script updates a shared process‑status file, refreshes the Impala metadata for the backup table, logs all actions, and triggers email notifications and SDP ticket creation (via `mailx`/`sendmail`) when failures are detected. It is intended to run as a scheduled cron job and to guard the downstream mediation workflow against missing or stuck backup files.

---

## 2. Key Functions / Logical Units

| Function / Block | Responsibility |
|------------------|----------------|
| **`MNAAS_SDP_ticket_for_CDR_non_genaration`** | Refreshes Impala metadata, queries the backup table for the latest `file_insert_time` per customer/process, detects generation gaps > 1 hr, records offending pairs in `non_generation[]`, and invokes `email_and_SDP_ticket_triggering_step` if any are found. |
| **`MNAAS_SDP_ticket_for_CDR_non_processed`** | Scans the filesystem for files older than 60 min that have not been processed, populates `non_processed[]`, writes a CSV status line per customer/process to the attachment file, and triggers validation‑email logic (`email_and_SDP_ticket_triggering_step_validation`) when needed. |
| **`email_and_SDP_ticket_triggering_step`** | Marks the overall job status as *Failure* in the status file, checks whether an SDP ticket has already been raised, and if not creates a ticket by sending a formatted `mailx` message to the support mailbox. |
| **`email_and_SDP_ticket_triggering_step_validation`** | Sends a multipart MIME email (with CSV attachment) to the Windows‑team and vendors indicating either successful file pulling or a failure, and optionally raises an SDP ticket for Windows‑pull failures. |
| **`terminateCron_successful_completion`** | Resets the status‑file flags to *Success*, logs completion, and exits with status 0. |
| **`terminateCron_Unsuccessful_completion`** | Logs failure, forces an SDP ticket via `email_and_SDP_ticket_triggering_step`, updates the run‑time flag, and exits with status 1. |
| **Main block** | Prevents concurrent runs (PID check), loads the current process flag from the status file, initializes temporary arrays, decides which validation functions to run based on the flag, and finally calls the appropriate termination routine. |

---

## 3. Inputs, Outputs, Side‑Effects & Assumptions

### 3.1 Inputs (external configuration / environment)

| Variable / File | Origin | Use |
|-----------------|--------|-----|
| `MNAAS_backup_SDP_ticket_validation.properties` | Sourced at top of script | Defines all runtime parameters (paths, DB/table names, arrays, email addresses, Impala host, etc.). |
| `MNAAS_customer_backup_dir` (associative array) | Property file | Maps customer name → backup directory relative to `$MNAAS_backup_SDP_ticket_parent_path`. |
| `MNAAS_dtail_extn` (associative array) | Property file | Maps process name → file‑name pattern/extension. |
| `MNAAS_windows_job_mapping` (associative array) | Property file | Maps customer → Windows job identifier used in CSV output. |
| `$IMPALAD_HOST`, `$MNAAS_backup_SDP_ticket_db`, `$MNAAS_backup_SDP_ticket_table` | Property file | Impala connection details for metadata refresh and query. |
| `$MNAAS_backup_SDP_ticket_ProcessStatusFileName` | Property file | Shared status file that stores flags, PID, timestamps, etc. |
| `$MNAAS_backup_SDP_ticket_logpath` | Property file | Log file path for `logger -s`. |
| `$MNAAS_backup_SDP_ticket_attachment` | Property file | CSV file that is attached to notification emails. |
| Email addresses (`$MOVE_TEAM_EMAIL`, `$MNAAS_SUPPORT_TEAM_EMAIL`, etc.) | Property file | Recipients for failure/validation mails. |
| System utilities: `impala-shell`, `mailx`, `sendmail`, `logger`, `sed`, `find`, `date`, `uuidgen` | OS / installed packages | Required for script execution. |

### 3.2 Outputs

* **Log file** – appended throughout execution (`$MNAAS_backup_SDP_ticket_logpath`).
* **Process‑status file** – several key/value pairs are updated (e.g., `MNAAS_SDP_Ticket_CDR_ProcessStatusFlag`, `MNAAS_job_status`, `MNAAS_job_ran_time`, `MNAAS_email_sdp_created`).
* **CSV attachment** – `$MNAAS_backup_SDP_ticket_attachment` containing per‑customer status rows.
* **Email notifications** – sent via `mailx` (SDP ticket) and `sendmail` (Windows‑team validation).
* **SDP ticket** – created implicitly by the formatted `mailx` message to the internal ticketing system.

### 3.3 Side‑effects

* Alters files on the shared filesystem (status file, log, CSV).
* Triggers external ticketing system via email.
* May affect downstream processes that read the status file (e.g., other cron jobs that gate on the flag values).

### 3.4 Assumptions

* The property file defines all required associative arrays and variables; missing entries cause script failure.
* Impala host is reachable and the target table exists.
* `mailx` and `sendmail` are correctly configured to deliver to internal mail systems.
* The script runs on a Linux host with Bash ≥ 4 (required for associative arrays).
* File timestamps on the backup directories are reliable (no clock skew).
* Only one instance runs at a time; PID check is sufficient to prevent concurrency.

---

## 4. Interaction with Other Scripts / Components

| Component | Relationship |
|-----------|--------------|
| **Other “MNAAS_*” scripts** (e.g., `MNAAS_TrafficDetails_*`, `MNAAS_Traffic_tbl_Load.sh`) | Those scripts generate the backup files and populate the Impala table that this validator queries. They also set the `MNAAS_SDP_Ticket_CDR_ProcessStatusFlag` value before invoking this script (or rely on the flag left by a previous run). |
| **Shared Process‑Status File** (`$MNAAS_backup_SDP_ticket_ProcessStatusFileName`) | Acts as a coordination point; other scripts read/write the same file to communicate success/failure and PID. |
| **Impala Metastore** | The script issues `refresh` / `invalidate metadata` commands to ensure the latest backup data is visible to queries. |
| **Windows Pull Jobs** (external Windows servers) | The script validates that Windows jobs have successfully pulled files; failures are reported back to the Windows team via email. |
| **Ticketing System** (internal SDP ticketing) | Triggered by `mailx` messages formatted with `%customer`, `%CATEGORY`, etc.; downstream ticketing automation consumes these emails. |
| **Cron Scheduler** | The script is expected to be invoked by a daily/ hourly cron entry; the PID guard prevents overlapping runs. |

---

## 5. Operational Risks & Recommended Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Incorrect or missing property definitions** (e.g., empty associative arrays) | Script may exit silently or produce false alerts. | Add validation at start of script to verify required variables/arrays exist; fail fast with clear error messages. |
| **Impala refresh failure** | Stale data leads to missed generation detection. | Implement retry logic with exponential back‑off; log both `refresh` and `invalidate metadata` outcomes. |
| **Email delivery failure** (mailx/sendmail) | Operators not notified; tickets not raised. | Capture exit status of mail commands; on failure, write to a fallback alert file and/or trigger an SMS/monitoring alarm. |
| **PID race condition** (two instances start simultaneously) | Duplicate processing, status file corruption. | Use a lock file (`flock`) in addition to PID check; ensure lock is released on exit (trap). |
| **Hard‑coded time thresholds (3600 s, 60 min)** | May not suit all customers/processes. | Externalize thresholds to the property file; allow per‑customer overrides. |
| **Sed in‑place edits on shared status file** | Concurrent edits could corrupt the file. | Serialize writes (e.g., via `flock`) or switch to a lightweight key‑value store (e.g., JSON + `jq`). |
| **Base64 encoding of large CSV attachment** may exceed mail size limits. | Email rejected or truncated. | Split attachment if size > X MB or store the CSV in a shared location and include a link. |

---

## 6. Typical Execution / Debugging Steps

1. **Run manually (debug mode)**  
   ```bash
   cd /app/hadoop_users/MNAAS/MNAAS_Property_Files
   ./MNAAS_backup_SDP_ticket_validation.sh   # or full path
   ```
   The script already enables `set -x` (trace) at the top, so each command will be printed.

2. **Check PID lock** – If you see “Previous … Process is running already”, verify with:  
   ```bash
   ps -fp $(cat $MNAAS_backup_SDP_ticket_ProcessStatusFileName | grep MNAAS_Script_Process_Id | cut -d= -f2)
   ```

3. **Inspect logs** – Tail the log file for recent activity:  
   ```bash
   tail -f $MNAAS_backup_SDP_ticket_logpath
   ```

4. **Validate status file** – Ensure flags are as expected:  
   ```bash
   grep -E 'MNAAS_SDP_Ticket_CDR_ProcessStatusFlag|MNAAS_job_status' $MNAAS_backup_SDP_ticket_ProcessStatusFileName
   ```

5. **Force a failure for testing** – Temporarily set `MNAAS_SDP_Ticket_CDR_ProcessStatusFlag=1` in the status file and re‑run; verify that an SDP ticket email is generated.

6. **Check email delivery** – Look in the mail queue or the recipient inbox; also verify that the attachment CSV contains the expected rows.

7. **Confirm Impala query** – Run the same query manually to ensure it returns a timestamp:  
   ```bash
   impala-shell -i $IMPALAD_HOST -B -q "SELECT max(file_insert_time) FROM $MNAAS_backup_SDP_ticket_db.$MNAAS_backup_SDP_ticket_table WHERE ..."
   ```

---

## 7. External Config / Environment Dependencies

| Config Item | Description | Typical Location |
|------------|-------------|------------------|
| `MNAAS_backup_SDP_ticket_validation.properties` | Central property file sourced at script start; defines all paths, DB names, arrays, email addresses, thresholds, etc. | `/app/hadoop_users/MNAAS/MNAAS_Property_Files/` |
| `MNAAS_backup_SDP_ticket_ProcessStatusFileName` | Shared status file (key‑value pairs) used for coordination with other scripts. | Defined in properties file |
| `MNAAS_backup_SDP_ticket_logpath` | Log file for this script. | Defined in properties file |
| `MNAAS_backup_SDP_ticket_attachment` | CSV file generated for email attachment. | Defined in properties file |
| `IMPALAD_HOST` | Hostname of the Impala daemon. | Defined in properties file |
| Email variables (`MOVE_TEAM_EMAIL`, `MNAAS_SUPPORT_TEAM_EMAIL`, etc.) | Recipients for failure/validation notifications. | Defined in properties file |
| `MNAAS_customer_backup_dir`, `MNAAS_dtail_extn`, `MNAAS_windows_job_mapping` | Associative arrays mapping customers → directories, process names → file patterns, and Windows job identifiers. | Populated in properties file |

---

## 8. Suggested Improvements (TODO)

1. **Add robust input validation & lock handling** – Before any processing, verify that all required variables/arrays are defined and acquire an exclusive lock (`flock`) to avoid race conditions on the status file.

2. **Externalize thresholds & retry parameters** – Move the “1 hour generation gap” and “60 minute unprocessed” thresholds, as well as Impala retry counts, into the property file (or a separate JSON/YAML) to make the script adaptable without code changes. 

---