**File:** `move-mediation-scripts/bin/MNAAS_Monthly_RAReports.sh`

---

## 1. High‑Level Summary
This Bash wrapper orchestrates the generation of two Revenue Assurance (RA) reports for the previous calendar month. It loads shared property values, redirects error output to a central log, invokes the Java `RAReport.jar` twice (once for the full monthly report, once for the “RA”‑specific report), and writes a completion entry to the system logger. The script is intended to be executed by a scheduler (e.g., cron/Control-M) on a daily basis, but it always processes the prior month.

---

## 2. Important Functions / Components  

| Name / Artifact | Type | Responsibility |
|-----------------|------|----------------|
| `MNAAS_Run_Monthly_Report` | Bash function | Calls `RAReport.jar` with the appropriate arguments for the monthly and “ra” reports, then logs success. |
| `RAReport.jar` | Java executable (packaged in `/app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/`) | Implements the actual data extraction, transformation, and file generation for RA reports. Accepts placeholders for date/month (here passed as `null`), a property file path, a log path, a report type (`monthly` / `ra`), and a mail‑send flag (`Y`/`N`). |
| `MNAAS_Java_Batch.properties` | Property file | Supplies configuration values used by the Java jar (DB connections, S3/SFTP targets, email settings, etc.). Also defines `$MNAAS_RAReport_LogPath`. |
| `logger` | System utility | Writes start/end markers and timestamps to the same log file used by the Java process. |

---

## 3. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Inputs** | • Implicit: `$MNAAS_RAReport_LogPath` (environment variable defined in the sourced properties file).<br>• Implicit: any configuration values read by `RAReport.jar` from `MNAAS_Java_Batch.properties` (DB URLs, credentials, output directories, email recipients). |
| **Outputs** | • Two report files generated by `RAReport.jar` (exact filenames/locations are defined inside the jar’s configuration).<br>• Log entries appended to `$MNAAS_RAReport_LogPath` (including Java STDERR and the `logger` messages). |
| **Side Effects** | • Potential email dispatch (first jar call uses flag `Y`).<br>• Database reads (and possibly writes) performed by the Java code.<br>• Network I/O to external storage (HDFS, S3, FTP) as configured. |
| **Assumptions** | • The property file exists and is readable.<br>• `$MNAAS_RAReport_LogPath` points to a writable location for the user executing the script.<br>• Java 1.8+ is installed and `java` is on the PATH.<br>• The jar’s internal logic correctly interprets `null` for date/month as “previous month”. |

---

## 4. External Configuration & Environment  

| Item | Source | Usage |
|------|--------|-------|
| `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties` | Static file in the repo | Sourced at the top of the script; defines `$MNAAS_RAReport_LogPath` and all Java‑side configuration (DB, email, storage). |
| `$MNAAS_RAReport_LogPath` | Exported by the property file | Redirects both Bash STDERR (`exec 2>>`) and `logger` output; also passed to the Java jar as its log destination. |
| `RAReport.jar` | `/app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/` | The core processing engine; expects the property file path as argument 3. |
| System `logger` | `/usr/bin/logger` | Writes to syslog and the same log file for auditability. |

---

## 5. Integration with Other Scripts / Components  

| Connected Component | Relationship |
|---------------------|--------------|
| **Other MNAAS batch scripts** (e.g., `MNAAS_MSISDN_Level_Daily_Usage_Aggr.sh`, `MNAAS_Monthly_Billing_Export.sh`) | Share the same property file and log‑path conventions; typically scheduled sequentially to avoid overlapping DB loads. |
| **Scheduler** (cron, Control‑M, etc.) | Invokes this script nightly; downstream processes may depend on the generated RA reports being present before they start. |
| **Email system** | Triggered by the first Java call (`Y` flag) to notify stakeholders of report availability or errors. |
| **Data stores** (HDFS, relational DB, S3, FTP) | Consumed/produced by `RAReport.jar` according to values in the property file; other scripts read the same stores for downstream analytics. |

---

## 6. Operational Risks & Recommended Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| Missing or unreadable `MNAAS_Java_Batch.properties` | Script aborts, no reports generated. | Validate file existence before sourcing; alert on failure. |
| `$MNAAS_RAReport_LogPath` not writable | Log loss, Java STDERR may fill the console. | Pre‑run check (`test -w`) and fallback to a default log directory. |
| `RAReport.jar` exits with non‑zero status (e.g., DB timeout, OOM) | Incomplete reports, downstream jobs may fail. | Capture exit code, write explicit error to log, and return non‑zero from the wrapper for scheduler alerts. |
| Email dispatch failure (SMTP down) | Stakeholders not notified. | Separate mail step; log mail response and optionally retry. |
| Date handling mismatch (if `null` interpretation changes) | Wrong month’s data processed. | Explicitly compute previous month in Bash and pass as arguments; avoid reliance on internal `null` handling. |
| Concurrent executions (if scheduler mis‑fires) | Resource contention, duplicate reports. | Use a lock file (`flock`) around the main function. |

---

## 7. Example Execution & Debugging  

**Running manually**

```bash
# Ensure environment is the same as the scheduler
source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties

# Optional: verify log path
echo "Log will go to: $MNAAS_RAReport_LogPath"

# Execute the script
bash /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Monthly_RAReports.sh
```

**Debugging steps**

1. **Check property loading** – after sourcing, `echo $MNAAS_RAReport_LogPath`.
2. **Run Java jar directly** to see its console output:  
   ```bash
   java -jar /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/RAReport.jar null null \
        /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties \
        /tmp/ra_debug.log monthly Y
   ```
3. **Inspect logs** – tail the log file defined by `$MNAAS_RAReport_LogPath` for errors.
4. **Validate email** – check the mail queue or recipient inbox if the first call should have sent a message.
5. **Exit code** – after script finishes, `echo $?` should be `0`. Non‑zero indicates a failure in the Java step.

---

## 8. Suggested Improvements (TODO)

1. **Add explicit argument handling** – accept optional date/month parameters instead of hard‑coding `null`. Compute “previous month” in Bash and pass concrete values to the jar for clarity and future flexibility.
2. **Implement robust error handling** – capture the Java process exit status, log a clear error message, and exit the script with a non‑zero code so the scheduler can trigger alerts. Consider wrapping the two jar invocations in a retry loop for transient failures.