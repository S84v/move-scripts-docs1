**File:** `move-mediation-scripts/bin/MNAAS_TrafficDetails_daily_tbl_aggr.sh`  

---

## 1. High‑Level Summary
This script orchestrates the daily aggregation pipeline for the **MNAAS Traffic Details** data set. It:

1. Removes duplicate partition files and prepares clean input files.  
2. Drops existing Hive/Impala partitions for the target aggregation table, recreates them via an intermediate staging table, and finally loads the cleaned data into the main aggregation table.  
3. Triggers a series of downstream enrichment and reporting jobs (MSISDN‑level usage, date‑time dimension, KYC add‑on, balance updates, SIM‑inventory, etc.).  
4. Executes retention‑policy jobs that drop older partitions from a number of raw and aggregated tables.  
5. Maintains a **process‑status file** that records the current step, success/failure flag, PID, and timestamps, and sends an email/SDP ticket on failure.  

The script is intended to run once per day (hour supplied by the scheduler) and is guarded against concurrent executions.

---

## 2. Important Functions & Their Responsibilities  

| Function | Responsibility |
|----------|----------------|
| **MNAAS_remove_dups_from_the_file** | Sorts the daily traffic partition file, removes duplicates, strips WARN lines, updates status flag = 1. |
| **MNAAS_remove_partitions_from_the_table** | Calls Java class `$drop_partitions_in_table` to drop partitions for the aggregation table, refreshes Impala metadata, status = 2. |
| **MNAAS_recreate_partitions_in_the_inter_table** | Loads the unique partition file into a temporary staging table via Java class `$traffic_aggr_dups_remove`, status = 3. |
| **MNAAS_load_into_main_table** | Moves data from the staging table to the final aggregation table via Java class `$Load_traffic_aggr_table`, refreshes Impala, status = 4. |
| **MNAAS_traffic_details_raw_daily_with_no_dups** | Executes the external script `$MNAAS_Traffic_tbl_with_nodups_loading_ScriptName` (guarded against parallel runs), status = 5. |
| **MNAAS_traffic_aggr_adhoc** | Starts the adhoc traffic‑aggregation script `$MNAAS_traffic_aggr_adhoc_ScriptName`, status = 6. |
| **MNAAS_MSISDN_Level_Daily_Usage_Aggr** | Runs the MSISDN‑level daily usage aggregation script, status = 7. |
| **MNAAS_dim_date_time_3months_load** | (Currently disabled – placeholder) would load a 3‑month date‑time dimension, status = 8. |
| **MNAAS_remove_the_contents_of_the_file** | Truncates the raw traffic partition file, status = 13. |
| **MNAAS_retention_for_…** (13 functions) | For each raw/aggregated table, runs Java class `$DropNthOlderPartition` to drop N‑th older partitions, refreshes Impala, updates status = 14‑27. |
| **MNAAS_msisdn_details_kyc_addon_table** | Builds the KYC add‑on table via an Impala query that joins SIM inventory with KYC snapshot, status = 25. |
| **MNAAS_msisdn_details_kyc_bal_update_table** | Truncates and reloads the KYC balance‑update table using a Hive script, status = 26. |
| **MNAAS_sim_inventory_kyc_rnr_table** | Truncates and reloads the SIM‑inventory KYC‑RNR table via Beeline/Hive, status = 27. |
| **terminateCron_successful_completion** | Writes success flag = 0, timestamps, logs end‑time, exits 0. |
| **terminateCron_Unsuccessful_completion** | Logs failure, calls `email_and_SDP_ticket_triggering_step`, exits 1. |
| **email_and_SDP_ticket_triggering_step** | Updates status file to *Failure*, sends an email and creates an SDP ticket (via `mailx`). |

---

## 3. Inputs, Outputs & Side‑Effects  

### 3.1 Inputs (provided via the sourced properties file or command line)

| Variable | Source | Meaning |
|----------|--------|---------|
| `MNAAS_Traffic_Partitions_Daily_FileName` | properties | Raw traffic partition file generated by upstream ingestion. |
| `MNAAS_Traffic_Partitions_Daily_Uniq_FileName` | properties | Destination for de‑duplicated partitions. |
| `MNAAS_Daily_Traffictable_Load_daily_Aggr_ProcessStatusFileName` | properties | Text file that stores process flags, PID, timestamps, etc. |
| `MNAAS_DailyTrafficDetailsLoad_daily_AggrLogPath` | properties | Path to the script’s log file (stderr redirected). |
| `hour` (argument `$1`) | scheduler (cron) | Current hour – used to enforce “run‑once‑per‑day”. |
| `min` (argument `$2`) | scheduler | Not used internally (placeholder). |
| Hive/Impala connection details (`HIVE_HOST`, `IMPALAD_HOST`, ports) | properties | Required for `impala-shell` and Java Hive calls. |
| Java class names (`$drop_partitions_in_table`, `$traffic_aggr_dups_remove`, `$Load_traffic_aggr_table`, `$DropNthOlderPartition`) | properties | Executable entry points for partition management and loading. |
| JAR / classpath variables (`$CLASSPATHVAR`, `$Generic_Jar_Names`, `$MNAAS_Main_JarPath`) | properties | Locations of compiled Java code. |
| Names of downstream scripts (`$MNAAS_Traffic_tbl_with_nodups_loading_ScriptName`, `$MNAAS_traffic_aggr_adhoc_ScriptName`, …) | properties | Shell scripts invoked as part of the pipeline. |
| Email / SDP variables (`$ccList`, `$GTPMailId`, `$SDP_ticket_from_email`, `$MOVE_DEV_TEAM`) | properties | Used for failure notifications. |

### 3.2 Outputs  

| Type | Destination |
|------|-------------|
| **Log entries** | `$MNAAS_DailyTrafficDetailsLoad_daily_AggrLogPath` (stderr) |
| **Process‑status file** | `$MNAAS_Daily_Traffictable_Load_daily_Aggr_ProcessStatusFileName` (flags, PID, timestamps) |
| **Hive/Impala tables** | Various tables (`traffic_details_aggr_daily_tblname`, `traffic_details_raw_daily_tblname`, `msisdn_details_kyc_addon_tblname`, …) |
| **Truncated files** | `$MNAAS_Traffic_Partitions_Daily_FileName` (emptied at the end) |
| **Email / SDP ticket** | Sent via `mail` / `mailx` on failure |

### 3.3 Side‑Effects  

* Deletes/overwrites files on the shared filesystem.  
* Executes Java processes that issue Hive DDL/DML.  
* Runs `impala-shell` to refresh metadata.  
* May spawn additional shell scripts that themselves perform further data loads.  
* Sends external notifications (email, SDP ticket).  

---

## 4. Interaction with Other Scripts & Components  

| Component | How it is used |
|-----------|----------------|
| **`MNAAS_Traffic_tbl_with_nodups_loading.sh`** | Loads the “raw daily no‑dups” table; guarded against concurrent runs. |
| **`MNAAS_traffic_aggr_adhoc.sh`** | Performs adhoc traffic aggregation; invoked after main load. |
| **`MNAAS_MSISDN_Level_Daily_Usage_Aggr.sh`** | Generates per‑MSISDN daily usage aggregates. |
| **`MNAAS_msisdn_details_kyc_addon_table.sh`**, **`MNAAS_msisdn_details_kyc_bal_update_table.sh`**, **`MNAAS_sim_inventory_kyc_rnr_table.sh`** | Enrichment tables that depend on the freshly loaded traffic data. |
| **Java classes** (`$drop_partitions_in_table`, `$traffic_aggr_dups_remove`, `$Load_traffic_aggr_table`, `$DropNthOlderPartition`) | Perform Hive partition manipulation and bulk loads. |
| **Hive / Impala** | Target data warehouse; tables are created/updated/partition‑refreshed. |
| **Process‑status file** (`*_ProcessStatusFileName`) | Shared with other daily scripts (e.g., `MNAAS_TrafficDetails_Mergefile_triggerScript.sh`) to coordinate step execution. |
| **Cron scheduler** | Calls this script with hour/min arguments; ensures daily cadence. |
| **Email / SDP system** | Receives failure alerts; part of the operational monitoring chain. |

---

## 5. Operational Risks & Recommended Mitigations  

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Stale or corrupted process‑status file** – wrong flag leads to skipped steps or infinite loops. | Data loss / incomplete pipeline. | Add validation of flag values at start; rotate status file daily; checksum the file. |
| **Concurrent executions** – PID check may miss a process if PID is reused. | Duplicate loads, race conditions. | Use a lock file (`flock`) instead of PID check; enforce exclusive lock at script start. |
| **Missing/incorrect property values** (paths, table names, Java class names). | Immediate failure, silent data gaps. | Validate required variables after sourcing properties; abort with clear message if any are empty. |
| **Java or Hive failures not captured** – exit codes ignored in some places. | Partial data load, inconsistent tables. | Ensure every external command is wrapped with `|| terminateCron_Unsuccessful_completion`. |
| **Log file growth** – script redirects all stderr to a single log file without rotation. | Disk exhaustion. | Implement log rotation (e.g., `logrotate`) or size‑based truncation. |
| **Hard‑coded host IPs** (e.g., Beeline URL). | Breaks when infrastructure changes. | Move such values to the properties file or environment variables. |
| **Email/SDP ticket flood** – repeated failures may generate many tickets. | Alert fatigue. | Add a “ticket already sent” flag (already present) but also enforce a cooldown period. |
| **Unbounded `set -x`** – verbose debugging in production may expose sensitive data. | Security / performance impact. | Disable `set -x` by default; enable via a debug flag. |

---

## 6. Running / Debugging the Script  

1. **Typical invocation (via cron):**  
   ```bash
   /app/hadoop_users/MNAAS/MNAAS_Scripts/bin/MNAAS_TrafficDetails_daily_tbl_aggr.sh $(date +%H) $(date +%M)
   ```
   *`$1` = current hour, `$2` = current minute.*

2. **Manual run (debug mode):**  
   ```bash
   export DEBUG=1          # optional flag you could add to the script
   set -x                  # already present – shows each command
   ./MNAAS_TrafficDetails_daily_tbl_aggr.sh 02 00   # force hour 02
   tail -f $MNAAS_DailyTrafficDetailsLoad_daily_AggrLogPath
   ```

3. **Checking status:**  
   ```bash
   cat $MNAAS_Daily_Traffictable_Load_daily_Aggr_ProcessStatusFileName
   # Look for MNAAS_Daily_ProcessStatusFlag and MNAAS_job_status
   ```

4. **Force a specific step:**  
   Edit the status file and set `MNAAS_Daily_ProcessStatusFlag` to the desired step number (1‑27) then re‑run the script; it will resume from that step.

5. **Common troubleshooting points:**  
   * Verify that all Java JARs are on `$CLASSPATHVAR`.  
   * Ensure Hive/Impala hosts are reachable (`nc -z $HIVE_HOST $HIVE_JDBC_PORT`).  
   * Confirm that downstream scripts referenced by `$MNAAS_Traffic_tbl_with_nodups_loading_ScriptName` etc. are executable and on `$MNAASShellScriptPath`.  
   * Look for “failed” messages in the log file; the script always logs the exact command that failed before calling `terminateCron_Unsuccessful_completion`.  

---

## 7. External Configuration & Environment Variables  

| Variable | Expected source | Usage |
|----------|----------------|-------|
| `MNAAS_TrafficDetails_daily_tbl_aggr.properties` | File under `/app/hadoop_users/MNAAS/MNAAS_Property_Files/` | Supplies all `$MNAAS_*` variables (paths, DB names, table names, class names, email lists, etc.). |
| `MNAAS_DailyTrafficDetailsLoad_daily_AggrLogPath` | properties | Log file (stderr). |
| `MNAAS_Daily_Traffictable_Load_daily_Aggr_ProcessStatusFileName` | properties | Process‑status tracking file. |
| `MNAAS_Traffic_Partitions_Daily_FileName` | properties | Raw traffic partition file. |
| `MNAAS_Traffic_Partitions_Daily_Uniq_FileName` | properties | De‑duplicated file. |
| `MNAAS_Traffic_tbl_with_nodups_loading_ScriptName`, `MNAAS_traffic_aggr_adhoc_ScriptName`, … | properties | Names of auxiliary scripts invoked. |
| `CLASSPATHVAR`, `Generic_Jar_Names`, `MNAAS_Main_JarPath` | properties | Java runtime classpath. |
| `drop_partitions_in_table`, `traffic_aggr_dups_remove`, `Load_traffic_aggr_table`, `DropNthOlderPartition` | properties | Fully‑qualified Java class names. |
| `HIVE_HOST`, `HIVE_JDBC_PORT`, `IMPALAD_HOST` | properties | Connection endpoints. |
| `ccList`, `GTPMailId`, `SDP_ticket_from_email`, `MOVE_DEV_TEAM` | properties | Notification recipients. |
| `hour_var` | properties (usually `00`) | Expected hour for daily run (used to guard against multiple runs per day). |

---

## 8. Suggested Improvements (TODO)

1. **Replace PID‑file logic with a robust lock mechanism** – use `flock -n /var/lock/mnaas_traffic_aggr.lock` at script start to guarantee single execution and avoid stale PID issues.

2. **Externalize logging & status handling** – create a small library (`mnaas_common.sh`) that provides `log_info`, `log_error`, `set_status_flag`, `write_status_file`. This reduces duplication, makes the script easier to test, and centralises changes (e.g., adding JSON‑structured logs for downstream monitoring tools).  

---  

*End of documentation.*