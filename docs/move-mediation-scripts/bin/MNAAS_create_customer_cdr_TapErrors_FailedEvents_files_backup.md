**High‑Level Summary**  
`MNAAS_create_customer_cdr_TapErrors_FailedEvents_files_backup.sh` is a Bash driver that processes two classes of mediation‑generated files – *Tap‑Error* and *Failed‑Event* records – from the daily “staging‑v2” directory. For each file (up to the 50 newest), it creates a checksum, copies the file to a customer‑specific output directory, backs it up to a parallel backup directory, adjusts permissions, and finally archives the source file to “staging‑v1”. The script updates a shared *process‑status* file, writes detailed logs, and on failure raises an SDP ticket and email notification. It is invoked by a scheduler (cron) and contains self‑guarding logic to avoid concurrent executions.  

---

## 1. Key Functions & Responsibilities  

| Function | Responsibility |
|----------|----------------|
| `tap_errors_file_creation` | Handles *.Tap_Errors_extn* files: checksum generation, copy to `$customer_dir/TapErrors`, backup to `$BackupDir/TapErrors_backup`, chmod, move original to `$MNAASMainStagingDirDaily_v1`. Updates process‑status flag to **1**. |
| `failed_events_file_creation` | Handles *.Failed_Events_extn* files: same steps as above but targeting `$customer_dir/Regulatory` and `$BackupDir/Regulatory_backup`. Updates process‑status flag to **2**. |
| `terminateCron_successful_completion` | Resets process‑status flags to **0**, marks job status *Success*, records run time, writes final log entries, and exits 0. |
| `terminateCron_Unsuccessful_completion` | Logs failure, invokes ticket/email step (if needed), and exits 1. |
| `email_and_SDP_ticket_triggering_step` | On first failure, composes an SDP ticket via `mailx`, updates status flags (`MNAAS_job_status=Failure`, `MNAAS_email_sdp_created=Yes`). Subsequent failures skip ticket creation. |
| **Main script block** | Prevents parallel runs by checking PID stored in the process‑status file, updates PID, reads the current flag, decides which of the above functions to run, and drives termination handling. |

---

## 2. Inputs, Outputs & Side Effects  

| Category | Details |
|----------|---------|
| **Configuration (sourced)** | `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_create_customer_cdr_TapErrors_FailedEvents_files.properties` – defines all directory paths, file extensions, delimiters, log and status file locations, email addresses, etc. |
| **Environment variables** | Expected to be set in the property file: `MNAASMainStagingDirDaily_v2`, `MNAASMainStagingDirDaily_v1`, `Tap_Errors_extn`, `Failed_Events_extn`, `customer_dir`, `BackupDir`, `sem_delimiter`, `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_LogPath`, `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_ProcessStatusFilename`, `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_scriptname`, `SDP_ticket_from_email`. |
| **External services** | `mailx` (SMTP gateway) for SDP ticket/email, system logger (`logger`), `cksum` utility, standard Unix file system. |
| **Input files** | All files matching `$Tap_Errors_extn` and `$Failed_Events_extn` in `$MNAASMainStagingDirDaily_v2`. |
| **Generated files** | Checksum files (`cksum` output) placed alongside the copied data in both customer and backup directories, log entries appended to `$MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_LogPath`, updated process‑status file. |
| **Side effects** | - File system modifications (copy, chmod, move). <br> - Process‑status file mutations (flags, PID, timestamps). <br> - Email/SDP ticket creation on failure. |
| **Assumptions** | • All directories exist and are writable by the script user. <br> • File extensions (`Tap_Errors_extn`, `Failed_Events_extn`) are simple glob patterns (e.g., `*.tap`). <br> • No other process manipulates the same status file concurrently. <br> • `mailx` is correctly configured for the `insdp@tatacommunications.com` address. |

---

## 3. Interaction with Other Scripts & Components  

| Connection | Description |
|------------|-------------|
| **Primary driver** | `MNAAS_create_customer_cdr_TapErrors_FailedEvents_files.sh` (non‑backup version) – this backup script is a sibling that performs the same logical steps but is likely invoked in a separate cron window or as a fallback. Both share the same process‑status and log files. |
| **Process‑status file** | Central coordination point used by multiple mediation scripts (e.g., traffic loading, backup table scripts). The flag values (0‑2) dictate which stage to execute. |
| **Backup retention scripts** | `MNAAS_backup_file_retention.sh` may later prune the backup directories populated here. |
| **Monitoring / Alerting** | SDP ticketing system receives alerts generated by `email_and_SDP_ticket_triggering_step`. |
| **Scheduler** | Cron entries (not shown) launch this script, typically once per day after the mediation layer drops files into the staging area. |
| **Logging infrastructure** | System logger (`logger`) writes to the same log file consumed by other mediation scripts for end‑to‑end traceability. |

---

## 4. Operational Risks & Recommended Mitigations  

| Risk | Mitigation |
|------|------------|
| **Stale PID / false‑positive “already running”** | Add a sanity check on the PID’s start time (`ps -p $PID -o lstart=`) and clear the PID if the process no longer exists. |
| **Directory or permission missing** | Pre‑run validation block that `mkdir -p` required dirs and `chmod 777` (or tighter) before processing. |
| **Partial file processing on failure** | Wrap each file’s processing steps in a subshell with `set -e` and move the source file to a “failed” sub‑dir on error, ensuring idempotence. |
| **Checksum mismatch not detected** | Currently checksum is only written, not verified. Consider adding a verification step after copy. |
| **Email/SDP ticket flood** | Guard against repeated ticket creation (already done) but also implement a rate‑limit (e.g., only one ticket per hour). |
| **Hard‑coded `ls | head -50` may miss files** | Replace with `find … -maxdepth 1 -type f -name "$Tap_Errors_extn" -printf '%T@ %p\n' | sort -k1,1nr | head -n 50 | cut -d' ' -f2-` for reliable ordering. |
| **Unquoted variable expansions** | Add double‑quotes around all variable references to avoid word‑splitting and globbing issues. |

---

## 5. Running / Debugging the Script  

1. **Prerequisite check** – Verify that the property file exists and all variables resolve (e.g., `echo $MNAASMainStagingDirDaily_v2`). |
2. **Dry‑run** – Comment out the `cp`, `mv`, and `chmod` lines, then execute the script manually:  
   ```bash
   bash -x MNAAS_create_customer_cdr_TapErrors_FailedEvents_files_backup.sh
   ```  
   The `-x` flag (already set via `set -x`) prints each command as it runs. |
3. **Log inspection** – Tail the log file defined by `$MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_LogPath` while the script runs. |
4. **Process‑status file** – After a run, view the status file to confirm flags and timestamps:  
   ```bash
   cat $MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_ProcessStatusFilename
   ```  
5. **Force failure** – Temporarily set an invalid directory path in the property file to trigger the error path and verify that an SDP ticket email is generated. |
6. **Cron verification** – Ensure the cron entry points to the full path of the script and that the environment (PATH, MAIL) matches the interactive shell. |

---

## 6. External Config / Environment Dependencies  

| Item | Purpose |
|------|---------|
| `MNAAS_create_customer_cdr_TapErrors_FailedEvents_files.properties` | Centralizes all directory paths, file extensions, delimiters, log and status file locations, and email addresses. |
| `SDP_ticket_from_email` | “From” address used when sending the SDP ticket via `mailx`. |
| `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_LogPath` | Absolute path to the script‑specific log file. |
| `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_ProcessStatusFilename` | Shared status file used for coordination across multiple mediation scripts. |
| `MNAAS_Create_Customer_cdr_TapErrors_FailedEvents_scriptname` | Name of the script (used in logs and status file). |
| `sem_delimiter` | Token appended to checksum filenames (e.g., “;”). |
| `customer_dir`, `BackupDir` | Root directories for per‑customer output and backup storage. |
| `Tap_Errors_extn`, `Failed_Events_extn` | Glob patterns (e.g., `*.tap_err`) that identify the files to process. |
| System utilities (`cksum`, `mailx`, `logger`) | Must be present in the execution PATH. |

---

## 7. Suggested Improvements (TODO)  

1. **Robust error handling & atomic moves** – Replace the `for file in \`ls …\`` loops with `find … -print0 | while IFS= read -r -d '' file; do …; done` and use `mv -T` or `rsync --remove-source-files` to guarantee atomicity.  
2. **Parameterise the “max files per run”** – Move the hard‑coded `head -50` limit into the property file (e.g., `MAX_FILES_PER_RUN=50`) so that operational teams can tune it without code changes.  

---