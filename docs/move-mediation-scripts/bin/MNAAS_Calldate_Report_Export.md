**File:** `move-mediation-scripts/bin/MNAAS_Calldate_Report_Export.sh`

---

## 1. High‑Level Summary
`MNAAS_Calldate_Report_Export.sh` is a thin Bash driver that launches the Java batch **NewBillingExport.jar** to produce daily or monthly call‑date usage reports for the MNAAS (Mobile Network Analytics & Assurance System) platform. It sources a common property file, builds the argument list required by the jar (report month, property file location, log file, execution mode, and a series of Y/N flags indicating which optional reports to generate), and finally executes the jar. The script is invoked by the production scheduler (cron) and is also used ad‑hoc by operators for on‑demand report generation.

---

## 2. Key Components & Responsibilities

| Component | Type | Responsibility |
|-----------|------|----------------|
| **`MNAAS_Calldate_Report_Export.sh`** | Bash driver | • Sources global property file.<br>• Constructs command‑line arguments for the Java batch.<br>• Executes `NewBillingExport.jar` with appropriate flags.<br>• Relies on external logging and email mechanisms. |
| **`MNAAS_Java_Batch.properties`** | Property file (sourced) | Holds environment‑specific configuration (DB URLs, Hadoop/HDFS paths, S3 buckets, email SMTP settings, etc.) used by the Java batch. |
| **`NewBillingExport.jar`** | Java executable (located in `/app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/`) | Main batch logic that reads the supplied month, loads data from source systems, generates the requested reports, writes them to target storage, logs progress, and optionally sends email notifications. |
| **`Export.log`** | Log file (`/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log`) | Captures stdout/stderr from the Java process for audit and troubleshooting. |
| **Cron entry (outside this file)** | Scheduler | Triggers the script on a daily/weekly basis; not defined here but referenced by the naming convention `MNAAS_Calldate_Report_Export`. |

---

## 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | 1. **Month‑Year** – generated by `$(date +"%Y-%m")` (current month) or supplied manually as `$1` when run directly.<br>2. **Property file path** – hard‑coded to `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`.<br>3. **Log file path** – `/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log`.<br>4. **Execution mode** – `M` (monthly) or `D` (daily). In the current script it is `M`.<br>5. **Report flags** – six positional Y/N flags controlling which optional reports are produced (subscription, consolidated traffic, call‑date usage, Singapore Airline, etc.). |
| **Outputs** | 1. **Report files** – CSV/Parquet/Excel files written to HDFS, S3, or a shared network location (exact location defined in the property file).<br>2. **Log entries** – appended to `Export.log`.<br>3. **Email** – if the final flag (`Y`) is set, the Java batch sends the generated reports to the designated recipients (Billing Team, RA Team, etc.). |
| **Side Effects** | • Potential creation of large temporary files on the local node.<br>• Network I/O to Hadoop/HDFS, S3, or internal DBs.<br>• Email traffic to internal distribution lists.<br>• Consumption of Hadoop/YARN resources while the jar runs. |
| **Assumptions** | • The property file exists and is readable by the executing user.<br>• `java` command is on the PATH and compatible with the jar (JDK 1.8+).<br>• Required Hadoop/HDFS client libraries are installed on the host.<br>• Email SMTP server reachable from the host.<br>• Sufficient disk space for temporary data and logs. |

---

## 4. Interaction with Other Scripts & Components

| Connected Component | Relationship |
|---------------------|--------------|
| **Other `MNAAS_*.sh` drivers** (e.g., `MNAAS_Billing_Export.sh`, `MNAAS_Actives_tbl_load_driver.sh`) | Share the same property file and logging conventions; often scheduled sequentially to ensure data availability before report generation. |
| **`MNAAS_Java_Batch.properties`** | Central configuration used by many Java batch jobs; defines source DB connections, target storage paths, and email recipients. |
| **Data Lake / Hadoop Cluster** | The Java jar reads raw CDR/usage tables from HDFS and writes processed reports back to a landing zone. |
| **Email Notification Service** | Triggered by the Java batch when the final flag (`Y`) is set; recipients are defined in the property file. |
| **Cron Scheduler** | The script is typically invoked by a cron entry such as `0 2 * * * /app/hadoop_users/MNAAS/.../MNAAS_Calldate_Report_Export.sh`. |
| **Monitoring/Alerting** | Log file (`Export.log`) is tailed by a monitoring agent (e.g., Splunk, ELK) to raise alerts on failures. |

---

## 5. Operational Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Missing or corrupted property file** | Batch fails early, no reports generated. | Validate file existence before launching; add a fallback to a default config; monitor file checksum. |
| **Incorrect month argument** (e.g., running with future month) | Generates empty or wrong reports, downstream billing impact. | Add argument validation: ensure month ≤ current month; allow `Def` keyword to auto‑select correct month. |
| **Insufficient disk / HDFS quota** | Job aborts mid‑run, partial data left. | Pre‑run quota check; clean up old temp directories; alert on low space. |
| **Java jar not found or version mismatch** | Script exits with “command not found”. | Verify jar path and checksum at deployment; include version logging. |
| **Email delivery failure** (final flag `Y`) | Stakeholders do not receive reports. | Capture email send status in log; retry logic inside Java batch; configure monitoring on SMTP errors. |
| **Uncontrolled log growth** | Log file consumes disk over time. | Rotate `Export.log` via logrotate; enforce size limits. |

---

## 6. Running & Debugging the Script

### 6.1 Typical Execution (via Cron)
```bash
# Cron entry (example)
0 2 * * * /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Calldate_Report_Export.sh
```
The cron invokes the script with no arguments; the script internally uses the current month (`$(date +"%Y-%m")`) and a fixed set of flags.

### 6.2 Manual Run (ad‑hoc)
```bash
# Generate a daily report for March 2025, include only the call‑date usage report and send email
./MNAAS_Calldate_Report_Export.sh 03-2025 \
    /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties \
    /tmp/Export.log D N N N Y N
```
*Adjust the flags as needed (Y = generate, N = skip).*

### 6.3 Debug Steps
1. **Check exit code** – `$?` after the script finishes; non‑zero indicates failure.
2. **Inspect `Export.log`** – Look for stack traces or “ERROR” lines.
3. **Validate arguments** – Echo the constructed command before execution:
   ```bash
   set -x   # enable bash tracing
   java -jar ...   # command as in script
   set +x
   ```
4. **Run Java jar directly** with `-Dlog4j.debug=true` (if supported) to get verbose logging.
5. **Verify external resources** – ping HDFS namenode, test DB connectivity, send a test email.

---

## 7. External Configurations & Environment Variables

| Item | Usage |
|------|-------|
| **`/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`** | Sourced at script start; provides variables such as `DB_URL`, `HDFS_OUTPUT_PATH`, `SMTP_HOST`, etc. |
| **`JAVA_HOME`** (implicit) | Determines which Java runtime is used; must point to a compatible JDK. |
| **`PATH`** | Must contain the `java` executable. |
| **`HADOOP_CONF_DIR`** (if required by the jar) | Location of Hadoop client configuration files (core-site.xml, hdfs-site.xml). |
| **Cron environment** | The script inherits minimal environment; any required variables (e.g., `HADOOP_USER_NAME`) should be exported in the property file or a wrapper script. |

---

## 8. Suggested Improvements (TODO)

1. **Argument Validation & Help Text**  
   Add a function that checks the number and format of arguments, prints usage information, and exits with a clear error code when inputs are invalid.

2. **Dynamic Mode Selection**  
   Replace the hard‑coded `M` (monthly) flag with logic that determines mode based on the supplied date (e.g., if the date equals the current month → `D`, else `M`). This reduces manual errors and aligns with the comment that “Def” should be the default.

---