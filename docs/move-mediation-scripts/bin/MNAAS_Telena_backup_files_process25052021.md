**MNAAS_Telena_backup_files_process25052021.sh – High‑Level Documentation**

---

### 1. Purpose (one‑paragraph summary)

This Bash script orchestrates the end‑to‑end processing of Telena backup files generated by the mediation layer. It scans configured source directories for the latest backup files (up to a configurable limit), removes duplicate rows, extracts file‑level metrics (size, record count, average record length), enriches each record with customer and partition metadata, and writes a delimited summary file. The summary is then loaded into a temporary Hive table, merged into the production table, and the original files are compressed and transferred via SCP to a remote edge node. Finally, the local copies are removed (or aged‑out) and the script updates a shared process‑status file, logs all actions, and raises an SDP ticket + email on failure.

---

### 2. Key Functions & Responsibilities

| Function | Responsibility |
|----------|-----------------|
| **telena_backup_files_to_process** | - Set process flag = 1.<br>- Iterate over configured file‑type patterns and processing locations.<br>- For each file (max `No_of_backup_files_to_process`): remove duplicate rows, compute size/record metrics, build a semicolon‑delimited line containing file metadata, customer mapping, and metrics; append to `$MNAAS_backup_filename_telena`. |
| **load_backup_files_records_to_temp_table** | - Set flag = 2.<br>- If the summary file is non‑empty: copy it to HDFS, truncate the intermediate Hive table `$telena_file_record_count_inter_tblname`, and load the data into it. |
| **insert_data_to_mainTable** | - Set flag = 3.<br>- Insert data from the intermediate Hive table into the partitioned production table `$telena_file_record_count_tblname` (dynamic partitions).<br>- Refresh Impala metadata via `$telena_file_record_count_refresh`. |
| **telena_SCP_backup_files_to_edgenode2** | - Set flag = 4.<br>- Generate a unique list of files (first 7 fields) from the summary, compress each source file, and SCP the `.gz` to the remote backup server (only in `PROD`). |
| **telena_remove_backup_files** | - Set flag = 5.<br>- Delete the local copies of processed files (immediate delete in `PROD`, or age‑out > 40 days in non‑prod). |
| **terminateCron_successful_completion** | - Reset flag = 0, mark job status = Success, write run‑time, log completion, and exit 0. |
| **terminateCron_Unsuccessful_completion** | - Log failure, invoke `email_and_SDP_ticket_triggering_step`, and exit 1. |
| **email_and_SDP_ticket_triggering_step** | - Mark job status = Failure, send an email to the support mailbox, create an SDP ticket (once per run), and log the action. |
| **Main program (bottom block)** | - Guard against concurrent runs using PID stored in the status file.<br>- Read the current flag and invoke the functions in the appropriate order to resume a partially‑completed run. |

---

### 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Configuration (sourced)** | `MNAAS_Telena_backup_files_process.properties` – defines all paths, arrays, Hive/Impala variables, backup server, environment mode, etc. |
| **Environment variables** | `ENV_MODE` (PROD / DEV), `IMPALAD_HOST`, `MNAAS_telena_backup_files_Scriptname` (script name), `MNAAS_Telena_files_backup_ProcessStatusFile` (status file), `MNAAS_backup_files_logpath_Telena` (log file), `MNAAS_backup_filename_telena` (summary CSV), `MNAAS_backup_filename_hdfs_Telena` (HDFS target dir), `MNAAS_files_backup_dups_telena` (temp dedup file), `MNAAS_backup_filename_telena_temp` (temp uniq list). |
| **External services** | Hadoop HDFS (`hadoop fs`), Hive (`hive -e`), Impala (`impala-shell`), remote SSH/SCP server (`$backup_server`), local mail subsystem (`mailx`). |
| **Input data** | - Files matching patterns in `${MNAAS_File_processed_location_dir[*]}` (e.g. `*.csv`).<br>- Customer mapping associative arrays (`FEED_CUSTOMER_MAPPING`, `MNAAS_Customer_SECS`). |
| **Primary output** | - `$MNAAS_backup_filename_telena` – semicolon‑delimited summary file (used for downstream loading and SCP).<br>- Hive tables (`$telena_file_record_count_inter_tblname`, `$telena_file_record_count_tblname`).<br>- Remote compressed backup files on `$backup_server`.<br>- Updated process‑status file (`$MNAAS_Telena_files_backup_ProcessStatusFile`). |
| **Side effects** | - File permission changes (`chmod 777`).<br>- Deletion/compression of source files.<br>- Log entries appended to `$MNAAS_backup_files_logpath_Telena`.<br>- Email/SDP ticket on failure. |
| **Assumptions** | - All associative arrays and directory paths are correctly defined in the properties file.<br>- Hadoop, Hive, Impala CLIs are on `$PATH` and functional.<br>- SSH keys allow password‑less `scp` to `$backup_server` when `ENV_MODE=PROD`.<br>- Sufficient disk space for temporary duplicate‑removal files. |

---

### 4. Interaction with Other Scripts / Components

| Connected Component | How this script interacts |
|---------------------|---------------------------|
| **Other “MNAAS_Telena_*” scripts** | This script is the *backup* stage; earlier scripts (e.g., `MNAAS_Telena_files_process*.sh`) generate the raw Telena files that this script consumes. |
| **Hive metastore** | Loads data into `$telena_file_record_count_inter_tblname` and `$telena_file_record_count_tblname`. Downstream reporting jobs query these tables. |
| **Impala** | Refreshes metadata after the insert (`$telena_file_record_count_refresh`). |
| **Backup server** | Receives compressed copies via SCP; other archival or disaster‑recovery processes pull from there. |
| **Process‑status file** | Shared with other MNAAS scripts to coordinate multi‑step pipelines; flag values (0‑5) indicate progress. |
| **Monitoring / Alerting** | Log file is tail‑monitored; failure triggers email + SDP ticket. |
| **Cron scheduler** | Typically invoked by a daily cron; the script itself guards against overlapping runs. |

---

### 5. Operational Risks & Recommended Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Concurrent execution** (PID guard fails) | Duplicate processing, corrupted status file | Ensure the status file is on a reliable shared filesystem; add lockfile with `flock` as secondary guard. |
| **Large file volume** (exceeds `No_of_backup_files_to_process`) | Unprocessed backlog, memory pressure | Parameterize the limit via a property; add alert if count > limit. |
| **Duplicate removal (`awk '!a[$0]++'`)** may consume high memory for very large files | OOM or slow processing | Stream dedup with `sort -u` or process in chunks; monitor memory usage. |
| **SCP failure** (network, auth) | Backup not archived, downstream jobs may miss files | Retry logic with exponential back‑off; fallback to copy to a staging area. |
| **Hive load failure** (schema mismatch, HDFS permission) | Data not persisted, downstream reports stale | Validate schema before load; pre‑check HDFS directory permissions; capture Hive error logs. |
| **Incorrect customer mapping** (missing entry in associative arrays) | Wrong partitioning, data loss | Add sanity check after `customers=`; log warning and skip if empty. |
| **Hard‑coded `chmod 777`** | Security exposure | Replace with least‑privilege mode defined in properties. |
| **Email/SDP spam** (multiple failures) | Alert fatigue | Ensure ticket flag (`MNAAS_email_sdp_created`) is persisted correctly; add rate‑limiting. |

---

### 6. Running / Debugging the Script

1. **Prerequisites**  
   - Ensure the properties file `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Telena_backup_files_process.properties` is present and all required variables are defined.  
   - Verify Hadoop, Hive, Impala CLIs are reachable.  
   - Confirm SSH key access to `$backup_server` (if `ENV_MODE=PROD`).  

2. **Manual Execution**  
   ```bash
   export ENV_MODE=DEV          # or PROD
   export IMPALAD_HOST=impala01.example.com
   ./MNAAS_Telena_backup_files_process25052021.sh
   ```
   - The script already runs with `set -x` (trace) and logs to `$MNAAS_backup_files_logpath_Telena`.  

3. **Debugging Tips**  
   - Tail the log file while the script runs: `tail -f $MNAAS_backup_files_logpath_Telena`.  
   - To force a specific step, set the flag in the status file (`MNAAS_Daily_ProcessStatusFlag`) to the desired value (0‑5) and re‑run; the main block will resume from that step.  
   - Check intermediate files: `$MNAAS_backup_filename_telena` (summary), `$MNAAS_files_backup_dups_telena` (deduped source), `$MNAAS_backup_filename_telena_temp` (unique list for SCP).  
   - Verify Hive tables after each load: `hive -e "select count(*) from $dbname.$telena_file_record_count_tblname where file_date = '2021-05-25';"`  

4. **Exit Codes**  
   - `0` – successful completion (status file flag reset to 0).  
   - `1` – failure; an email and SDP ticket are generated.  

---

### 7. External Config / Environment Dependencies

| Item | Description | Usage |
|------|-------------|-------|
| `MNAAS_Telena_backup_files_process.properties` | Central property file; defines paths, associative arrays (`MNAAS_backup_files_process_file_pattern`, `MNAAS_File_processed_location_dir`, `FEED_CUSTOMER_MAPPING`, `MNAAS_Customer_SECS`, `MNAAS_telena_type_location_mapping`), Hive DB/table names, backup server, log locations, etc. | Sourced at script start (`.`). |
| `ENV_MODE` | Runtime mode (`PROD` or other). Controls whether SCP is executed and whether files are physically deleted. | Checked in `telena_SCP_backup_files_to_edgenode2` and `telena_remove_backup_files`. |
| `IMPALAD_HOST` | Hostname of the Impala daemon used for metadata refresh. | Passed to `impala-shell`. |
| `MNAAS_Telena_files_backup_ProcessStatusFile` | Shared status file that stores PID, flag, job status, timestamps, etc. | Updated throughout the script; also read by other MNAAS processes. |
| `MNAAS_backup_files_logpath_Telena` | Path to the log file where all `logger` output is appended. | Used for audit and troubleshooting. |
| `MNAAS_backup_filename_telena` | Local CSV file that accumulates per‑file metrics. | Produced by `telena_backup_files_to_process`; consumed by later steps. |
| `MNAAS_backup_filename_hdfs_Telena` | HDFS directory where the CSV is copied before Hive load. | Used in `load_backup_files_records_to_temp_table`. |
| `backup_server` & `backup_dir_location` | Remote host and directory for final backup archive. | Used in SCP step. |
| `MNAAS_email_sdp_created` flag | Prevents duplicate ticket/email generation. | Managed in `email_and_SDP_ticket_triggering_step`. |

---

### 8. Suggested Improvements (TODO)

1. **Replace `eval` and back‑ticks with proper Bash array handling** – improves readability and eliminates potential command‑injection risks.  
2. **Make `No_of_backup_files_to_process` configurable via the properties file** (currently hard‑coded to 500) and add a sanity check that warns when the source directory contains more files than will be processed.  

---