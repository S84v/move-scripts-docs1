**MNAAS_Billing_Export.sh – High‑Level Documentation**

---

### 1. Purpose (One‑Paragraph Summary)
`MNAAS_Billing_Export.sh` is a thin wrapper that launches the `BillingExport.jar` Java batch job for the MNAAS (Mobile Network as a Service) platform. The script loads a shared property file, then invokes the JAR with a fixed set of arguments that trigger a **daily** billing export (type = `D`) for the **current month**. The job writes operational logs to `/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log` and relies on the property file for all environment‑specific configuration (Hadoop, database, SFTP, etc.). It is typically scheduled via cron and forms part of the nightly data‑move pipeline that feeds downstream billing, reporting, and reconciliation processes.

---

### 2. Key Components

| Component | Responsibility |
|-----------|----------------|
| **`. /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties`** | Sources a Bash property file that defines environment variables (e.g., `JAVA_HOME`, Hadoop classpath, DB connection strings, SFTP credentials, output directories). |
| **`java -jar .../BillingExport.jar`** | Executes the Java batch program. The JAR contains the core logic for extracting, transforming, and exporting billing data (SIM, usage, MYR, ELUX, JLR reports). |
| **Hard‑coded argument list** (`null … D N N N N N`) | Controls the batch run: month (`null` → defaults to current month), property file path, log file path, run mode (`D` for daily), and a series of flags (`Y`/`N`) indicating which optional reports to generate. |
| **Log file** (`/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log`) | Captures stdout/stderr from the Java process; used for operational monitoring and troubleshooting. |

*The script itself contains no functions or complex flow; it is a sequential command file.*

---

### 3. Inputs, Outputs, Side‑Effects & Assumptions

| Category | Details |
|----------|---------|
| **Inputs** | 1. **Property file** – `MNAAS_Java_Batch.properties` (must exist and be readable).<br>2. **Hard‑coded arguments** – month (`null` → current month), run mode (`D`), and six report‑generation flags (`N`). |
| **Outputs** | 1. **Log file** – `Export.log` (appended each run).<br>2. **Export artifacts** – files generated by `BillingExport.jar` (typically CSV/Parquet files placed on HDFS, local FS, or transferred via SFTP; exact location defined in the property file). |
| **Side‑effects** | • May write to Hadoop/HDFS.<br>• May insert/update staging tables in the billing database.<br>• May push files to external partners (e.g., via SFTP). |
| **Assumptions** | • Java 1.8+ is installed and `JAVA_HOME` is correctly set in the sourced properties.<br>• The JAR and all dependent libraries are present at the specified path.<br>• The executing user (`hadoop_users/MNAAS`) has read/write permissions on the property file, log directory, and any target storage locations.<br>• The environment variables defined in the property file are sufficient for the Java job (e.g., `HADOOP_CONF_DIR`, DB credentials). |

---

### 4. Integration Points (How It Connects to Other Scripts/Components)

| Connection | Description |
|------------|-------------|
| **Cron Scheduler** | Typically invoked by a crontab entry under `MNAASCronLogs` (e.g., `0 2 * * * /app/hadoop_users/MNAAS/move-mediation-scripts/bin/MNAAS_Billing_Export.sh`). |
| **Property File** | Shared across the entire MNAAS batch suite (see other scripts like `MNAAS_Activations_tbl_load_driver.sh`). Changes here affect multiple jobs. |
| **Java Batch Library** | `BillingExport.jar` is part of the `MNAAS_Jar/Loader_Jars` collection used by other data‑move scripts (e.g., activation loads, dimension builds). |
| **Downstream Processes** | Export files are consumed by downstream reconciliation scripts (e.g., `End_to_End_MOVENL_Mediation_Dashborad.sh`) and reporting dashboards. |
| **Common Logging** | All batch scripts write to `/app/hadoop_users/MNAAS/MNAASCronLogs/`, enabling a unified log‑aggregation view. |
| **Potential Driver Scripts** | Although not currently wrapped by a driver, a future driver (similar to `MNAAS_Activations_tbl_load_driver.sh`) could orchestrate multiple billing‑related jobs in a single run. |

---

### 5. Operational Risks & Recommended Mitigations

| Risk | Mitigation |
|------|------------|
| **Missing/Corrupt Property File** – leads to undefined environment variables and job failure. | Validate existence and readability of the property file at script start; exit with a clear error code if not found. |
| **Jar Not Found or Incompatible** – `java -jar` returns *File not found* or *Unsupported major.minor version*. | Add a pre‑flight check (`[ -f $JAR_PATH ] || { echo "Jar missing"; exit 1; }`). Pin the Java version in the property file and enforce via `java -version` check. |
| **Insufficient Disk Space** – export files or logs may fill the filesystem. | Monitor disk usage; rotate `Export.log` (logrotate) and clean up old export files as part of a housekeeping job. |
| **Permission Issues** – user cannot write to HDFS or SFTP destination. | Include a permissions audit step; log the effective user (`whoami`) and compare with expected ACLs. |
| **Silent Failure of Java Process** – non‑zero exit code not captured. | Capture the exit status (`rc=$?; if [ $rc -ne 0 ]; then echo "Java job failed with $rc" >> $LOG; exit $rc; fi`). |
| **Hard‑coded Flags Prevent Flexibility** – cannot generate optional reports without editing the script. | Externalize the flags to command‑line arguments or a config file (see TODO below). |

---

### 6. Running & Debugging Guide

1. **Standard Execution (via cron or manually)**  
   ```bash
   cd /app/hadoop_users/MNAAS/move-mediation-scripts/bin
   ./MNAAS_Billing_Export.sh
   ```
   - The script will source the property file and launch the Java job.  
   - Check `/app/hadoop_users/MNAAS/MNAASCronLogs/Export.log` for progress and errors.

2. **Manual Debug (verbose Bash)**  
   ```bash
   set -x   # enable command tracing
   ./MNAAS_Billing_Export.sh
   set +x
   ```
   - This prints each command as it runs, helping locate sourcing or path issues.

3. **Validate Environment**  
   ```bash
   . /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties
   echo "JAVA_HOME=$JAVA_HOME"
   echo "HADOOP_CONF_DIR=$HADOOP_CONF_DIR"
   ```
   - Ensure required variables are populated.

4. **Run Java Job Directly (bypass script)**  
   ```bash
   java -jar /app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/BillingExport.jar \
        null /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties \
        /app/hadoop_users/MNAAS/MNAASCronLogs/Export.log D N N N N N
   ```
   - Observe console output; compare with log file.

5. **Check Exit Status**  
   ```bash
   echo $?   # should be 0 on success
   ```

---

### 7. External Configurations & Environment Variables

| File / Variable | Usage |
|-----------------|-------|
| **`MNAAS_Java_Batch.properties`** | Provides all runtime configuration: Hadoop classpath, DB URLs, credentials, output directories, SFTP hosts, and any feature toggles used by `BillingExport.jar`. |
| **`JAVA_HOME`** (set in properties) | Determines which Java runtime is used. |
| **`HADOOP_CONF_DIR`**, **`HADOOP_USER_NAME`** (often set in properties) | Required for any HDFS interaction performed by the Java job. |
| **Log directory** (`/app/hadoop_users/MNAAS/MNAASCronLogs/`) | Must be writable by the executing user. |
| **Jar location** (`/app/hadoop_users/MNAAS/MNAAS_Jar/Loader_Jars/BillingExport.jar`) | Must exist and be executable. |

If any of these files or variables are missing, the script will fail early or the Java job will abort with configuration errors.

---

### 8. Suggested Improvements (TODO)

1. **Parameterize Flags & Mode**  
   Replace the hard‑coded argument list with command‑line options (e.g., `-m <month> -t <type> -r <reportFlags>`). This enables a single script to run both daily and monthly exports without editing the source.

2. **Add Robust Error Handling & Exit Codes**  
   - Verify the property file and JAR existence before execution.  
   - Capture the Java process exit code, log a concise error message, and propagate a non‑zero status to the scheduler.  
   - Implement log rotation or size‑based truncation to prevent uncontrolled growth of `Export.log`.

--- 

*End of documentation.*