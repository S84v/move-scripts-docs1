**MNAAS_Billing_Geneva.sh – High‑Level Documentation**

---

### 1. Purpose (one‑paragraph summary)
`MNAAS_Billing_Geneva.sh` orchestrates the daily Geneva‑billing data pipeline for the MNAAS platform. It ensures that only a single instance runs, updates a shared process‑status file, invokes a Java JAR that generates billing files for a given month, optionally copies those files to the external Geneva server via SCP, backs up the generated files, and records success or failure in logs, status files, and email notifications. The script is driven by a status flag that allows it to resume at the appropriate step when re‑run.

---

### 2. Key Functions & Responsibilities
| Function | Responsibility |
|----------|----------------|
| **MNAAS_Billing_Geneva_Jar_Execution** | Updates status flag to *1*, logs start, runs the `GenevaLoaderPPUJarPath` Java JAR with hard‑coded arguments (billing month, property path, log path, mode **B**, customer filter **42221_F**, etc.), and handles success/failure. |
| **MNAAS_Files_Export_To_Geneva** | Updates status flag to *2*, logs start, counts files in `${Geneva_Files_transfer}`, and if any exist, SCPs them to the Geneva server (`geneva@121.244.244.69:/geneva/GENEVACP/import`). |
| **MNAAS_Geneva_Files_Backup** | Updates status flag to *3*, logs start, moves generated files from `${MNAAS_Billing_Geneva_FilesPath}` to a backup directory `${MNAAS_Billing_Geneva_FilesPath_Backup}`. |
| **terminateCron_successful_completion** | Resets status flag to *0*, writes “Success” and run‑time to the status file, logs completion, sends a success email, and exits 0. |
| **terminateCron_Unsuccessful_completion** | Logs failure, records run‑time, triggers `email_triggering_step`, and exits 1. |
| **email_triggering_step** | Marks job status as “Failure”, checks if an SDP ticket‑creation email has already been sent (`MNAAS_email_sdp_created` flag), sends a failure email (and optionally creates an SDP ticket), and logs the action. |

---

### 3. Inputs, Outputs, Side‑Effects & Assumptions
| Category | Details |
|----------|---------|
| **Inputs** | • Sourced properties file: `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Java_Batch.properties` (defines all environment variables used).<br>• Current date (used only for logging). |
| **Outputs** | • Updated process‑status file (`$MNAASDailyGenevaLoad_ProcessStatusFile`).<br>• Log file (`$GenevaLogPath`).<br>• Billing files generated by the Java JAR (written to `${MNAAS_Billing_Geneva_FilesPath}` or `${Geneva_Files_transfer}`).<br>• Email notifications (success/failure) via `mailx`. |
| **Side‑effects** | • Executes a Java JAR that may write to DBs, HDFS, or other storage (outside script scope).<br>• Performs SCP to external Geneva server (network I/O, authentication).<br>• Moves files to a backup directory (filesystem operation). |
| **Assumptions** | • All variables referenced in the properties file are defined and point to valid paths/hosts.<br>• The Java JAR runs without interactive prompts and returns proper exit codes.<br>• The target Geneva server is reachable on port 5522 and the `geneva` user has write permission to `/geneva/GENEVACP/import`.<br>• The status file is writable by the script user and not concurrently edited by other processes. |

---

### 4. Integration Points (how it connects to other scripts/components)
| Component | Connection |
|-----------|------------|
| **MNAAS_Java_Batch.properties** | Central configuration source for all scripts in the MNAAS batch family (e.g., other billing/export scripts). |
| **Process‑status file** (`$MNAASDailyGenevaLoad_ProcessStatusFile`) | Shared with other daily Geneva‑load scripts (e.g., `MNAAS_Billing_Export.sh`) to coordinate multi‑step pipelines. |
| **Java JAR** (`$GenevaLoaderPPUJarPath`) | Same JAR may be invoked by other scripts for different modes (validation, pre‑rated billing). |
| **SCP target** (`geneva@121.244.244.69`) | Receives files that are later consumed by downstream Geneva billing systems. |
| **Email recipients** | Notification addresses are also used by other batch scripts for operational alerts. |
| **Potential callers** | Typically scheduled via cron; may be invoked manually for re‑runs after fixing data issues. |

---

### 5. Operational Risks & Recommended Mitigations
| Risk | Mitigation |
|------|------------|
| **Hard‑coded billing month (`2022-10`)** – script will always process that month unless edited. | Externalize the month argument (e.g., read from status file or command‑line). |
| **Single‑point status file editing with `sed`** – concurrent edits could corrupt the file. | Use file locking (`flock`) around all reads/writes or move to a lightweight DB/kv store. |
| **SCP credentials/host hard‑coded** – changes require script edit; possible security exposure. | Store host/port/user in the properties file; use SSH keys with restricted permissions. |
| **PID check race condition** – two instances could start if the status file is stale. | Verify process existence with `pgrep -f` and also check a lockfile; clean up stale PID entries. |
| **Java JAR failure not captured beyond exit code** – no detailed error capture. | Redirect JAR stdout/stderr to a dedicated log and parse for known error patterns. |
| **Email flooding on repeated failures** – `email_triggering_step` only guards against duplicate SDP tickets but may still send many mails. | Implement a back‑off or alert suppression window (e.g., only send first failure per day). |

---

### 6. Running & Debugging the Script
1. **Standard execution (cron)** – the script is normally invoked by a daily cron entry; no arguments are required.  
2. **Manual run** – `bash -x /path/to/MNAAS_Billing_Geneva.sh` to enable shell tracing (`-x`) and see variable expansions.  
3. **Force a specific step** – edit the status flag in `$MNAASDailyGenevaLoad_ProcessStatusFile` to the desired value (0‑3) before running.  
4. **Log inspection** – tail the log file defined by `$GenevaLogPath` for real‑time progress.  
5. **Check PID lock** – view the current PID stored in the status file and verify with `ps -p <PID>`.  
6. **Validate file transfer** – after a successful run, confirm files exist on the Geneva server (`ssh geneva@... ls /geneva/GENEVACP/import`).  

---

### 7. External Configuration / Environment Variables
All operational parameters are supplied by the sourced properties file (`MNAAS_Java_Batch.properties`). Key variables referenced in the script include:

| Variable | Meaning |
|----------|---------|
| `GenevaLogPath` | Path to the script’s log file. |
| `MNAASDailyGenevaLoad_ProcessStatusFile` | Shared status/flag file. |
| `MNAASDailyGenevaLoadScriptName` | Name of this script (used in logs/status). |
| `GenevaLoaderPPUJarPath` | Full path to the Java billing JAR. |
| `Mnaas_java_propertypath` | Path to Java property files passed to the JAR. |
| `GenevaLoaderJavaLogPath` | Log file for the Java JAR. |
| `Geneva_Files_transfer` | Directory where generated billing files are staged for export. |
| `Geneva_port`, `Geneva_Host`, `Geneva_server`, `Geneva_path` | (Commented out) SCP destination components – currently hard‑coded in the script. |
| `MNAAS_Billing_Geneva_FilesPath` / `..._Backup` | Source and backup directories for generated files. |
| `MNAAS_Billing_Geneva_FilesPath_Backup` | Backup location for post‑export archiving. |
| `MNAAS_email_sdp_created` | Flag to avoid duplicate failure emails. |

If any of these variables are missing or point to non‑existent locations, the script will fail early (e.g., `sed` will error).

---

### 8. Suggested TODO / Improvements
1. **Parameterize the billing month** – replace the hard‑coded `2022-10` argument with a dynamic value derived from the current date or a command‑line option, and store it in the status file for repeatability.  
2. **Introduce robust locking** – replace the ad‑hoc PID check with `flock` on a lockfile and protect all status‑file updates with atomic operations to prevent race conditions and file corruption.  

---