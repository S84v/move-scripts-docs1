**High‑Level Documentation – `move-mediation-scripts/bin/truncate_table_move_curr_month_count.sh`**

---

### 1. Summary
`truncate_table_move_curr_month_count.sh` is a minimal Hive/Impala script used by the MOVE data‑pipeline to delete all rows from the `move_curr_month_count` table before a new monthly aggregation run. It is typically invoked by higher‑level orchestration wrappers (e.g., nightly “load‑monthly‑counts” jobs) to guarantee a clean target table for the upcoming INSERT/UPSERT phase.

---

### 2. Core Elements

| Element | Type | Responsibility |
|---------|------|-----------------|
| `commit;` | Hive/Impala statement | Forces any pending transaction to be committed before the truncate (ensures the session is in a clean state). |
| `truncate table move_curr_month_count;` | Hive/Impala DDL | Removes **all** rows from the target table while preserving its schema and metadata. |
| `exit;` | Shell / Hive command | Terminates the script / Hive session cleanly. |

*There are no functions or classes in this file; it is a pure command script.*

---

### 3. Inputs, Outputs & Side Effects

| Category | Details |
|----------|---------|
| **Inputs** | None (hard‑coded table name). Implicit inputs are the Hive/Impala connection parameters supplied by the environment (e.g., `HIVE_CONF_DIR`, `IMPALA_HOST`, authentication tokens). |
| **Outputs** | No file or console output is generated by design. Success is indicated by a zero exit code from the Hive client. |
| **Side Effects** | - All rows in `move_curr_month_count` are permanently deleted.<br>- Transaction log is committed (via `commit;`). |
| **Assumptions** | - The script is executed in a context where the Hive/Impala CLI is already invoked (e.g., `beeline -f truncate_table_move_curr_month_count.sh`).<br>- The executing user has `DROP`/`TRUNCATE` privileges on the table.<br>- No concurrent writers are active on the table at the moment of truncation. |

---

### 4. Interaction with Other Components

| Caller / Consumer | How it is Used |
|-------------------|----------------|
| **Monthly aggregation wrappers** (e.g., `run_monthly_counts.sh`, `load_move_curr_month_count.sh`) | Invoked **before** the INSERT/UPSERT step to guarantee the destination table is empty. |
| **Error‑handling framework** (common `run_*.sh` scripts) | The wrapper checks the exit status of this script; on non‑zero status it raises an alert (email/SDP ticket) and aborts the downstream load. |
| **Configuration files** (`move.conf`, `hive-site.xml`) | Provide connection strings, Kerberos principals, and any required JDBC options for the Hive client that runs this script. |
| **Logging/monitoring** (e.g., `move_audit.log`) | The parent orchestration script logs the start/end timestamps and the exit code of this script for audit trails. |

*Because the script contains only raw Hive statements, it is typically fed to the Hive client via a redirection or `-f` flag rather than executed directly as a shell script.*

---

### 5. Operational Risks & Mitigations

| Risk | Impact | Recommended Mitigation |
|------|--------|------------------------|
| **Accidental data loss** – running the script on the wrong environment (e.g., production vs. dev). | Complete loss of current month counts. | - Enforce environment‑specific wrappers that inject a validation step (`[[ $ENV == prod ]] && confirm`).<br>- Use a naming convention that includes the environment (e.g., `truncate_table_move_curr_month_count_prod.sh`). |
| **Concurrent writes** – another process inserting into the table while truncation occurs. | Partial truncation, data inconsistency. | - Serialize access with a lock file or Zookeeper semaphore in the calling orchestration.<br>- Ensure the truncation runs **before** any downstream load starts. |
| **Insufficient privileges** – script fails silently if the user lacks `TRUNCATE` rights. | Downstream load fails, causing stale data. | - Verify privileges during deployment (e.g., `hive -e "show grant user $USER on table move_curr_month_count"`).<br>- Capture and surface the Hive client exit code. |
| **Missing Hive client** – the host where the script runs does not have the required Hive/Impala binaries. | Immediate failure, no truncation. | - Include a pre‑flight check (`which hive || which impala-shell`) in the wrapper.<br>- Document required packages in the deployment guide. |

---

### 6. Running / Debugging the Script

1. **Typical Invocation (from a wrapper)**  
   ```bash
   # In the orchestration script
   hive -f $(dirname $0)/truncate_table_move_curr_month_count.sh
   RC=$?
   if [[ $RC -ne 0 ]]; then
       echo "TRUNCATE failed (rc=$RC)" | mail -s "MOVE job error" ops@example.com
       exit $RC
   fi
   ```

2. **Ad‑hoc Manual Run**  
   ```bash
   # Switch to the appropriate Hive/Impala user
   export HIVE_CONF_DIR=/etc/hive/conf
   hive -f truncate_table_move_curr_month_count.sh
   ```

3. **Debugging Steps**  
   - Append `set -x` at the top of the wrapper to see the exact command line.  
   - Add `-hiveconf hive.execution.engine=mr` (or `tez`) if you need to force a specific execution engine for troubleshooting.  
   - Check Hive logs (`/var/log/hive/hive.log`) for any “Permission denied” or “Table not found” messages.  
   - Verify the table is empty after execution: `hive -e "select count(*) from move_curr_month_count;"`.

---

### 7. External Configuration / Environment Variables

| Variable | Purpose |
|----------|---------|
| `HIVE_CONF_DIR` | Directory containing `hive-site.xml` and other client configs. |
| `HADOOP_USER_NAME` | Hadoop user identity under which the Hive client runs (affects HDFS permissions). |
| `IMPALA_HOST` / `IMPALA_PORT` (if using `impala-shell`) | Target Impala daemon for the truncate operation. |
| `MOVE_ENV` (custom) | Indicates the deployment environment (dev, test, prod) – used by wrappers to guard against accidental execution in the wrong tier. |

*The script itself does not reference these variables directly; they are consumed by the Hive/Impala client that executes the script.*

---

### 8. Suggested Improvements (TODO)

1. **Add Idempotent Guard** – Wrap the `truncate` statement in a conditional that checks a “run‑once” flag file to prevent accidental double‑execution within the same window.  
   ```bash
   if [[ -f /tmp/truncate_move_curr_month_count.done ]]; then
       echo "Already truncated today, skipping."
       exit 0
   fi
   ```

2. **Introduce Logging** – Emit a timestamped log line to a central audit log before and after truncation, e.g., via `logger` or by echoing to `${MOVE_LOG_DIR}/truncate_move_curr_month_count.log`.

---