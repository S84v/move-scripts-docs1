**File:** `move-mediation-scripts/bin/MNAAS_Activations_seq_check.sh`  

---

## 1. High‑Level Summary
This Bash script is the entry‑point for the *MNAAS Activations* sequence‑number validation step in the daily MOVE mediation pipeline. It is invoked (typically by a cron job) after the nightly file drop into the staging area. For each configured feed source it:

1. Detects the earliest newly‑arrived activation file.
2. Calls a Java utility (`MNAAS_seqno_check`) that validates the file’s sequence number against historic records.
3. If the sequence is missing, it notifies the operations team via email (with an attachment of the missing‑file list) and moves the file to an “after‑check” directory.
4. Updates a shared process‑status file, writes detailed logs, and, on failure, raises an SDP ticket through `mailx`.

The script also enforces single‑instance execution, maintains run‑time metadata, and cleans up after successful or unsuccessful runs.

---

## 2. Key Functions & Responsibilities

| Function | Responsibility |
|----------|----------------|
| `seqno_check()` | Loops over all feed sources defined in `FEED_FILE_PATTERN`. For each source it logs start, counts files, selects the oldest file, ensures the Java checker is not already running, invokes the Java class, processes its exit code, sends alerts for missing sequences, and moves the processed file to the post‑check directory. |
| `terminateCron_successful_completion()` | Writes a *Success* state to the process‑status file, timestamps the run, logs completion, and exits with status 0. |
| `terminateCron_Unsuccessful_completion()` | Logs failure, triggers email/SDP ticket creation, and exits with status 1. |
| `email_and_SDP_ticket_triggering_step()` | Updates the status file to *Failure*, checks whether an SDP ticket has already been raised, and if not sends a formatted ticket email via `mailx`. Also updates the ticket‑creation flag. |
| **Main Program** (bottom of file) | Performs single‑instance guard using the PID stored in the status file, updates the PID, checks the daily process flag, calls `seqno_check()`, and finally invokes the appropriate termination routine. |

---

## 3. Inputs, Outputs & Side‑Effects

| Category | Details |
|----------|---------|
| **Configuration (sourced)** | `/app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Activations_seq_check.properties` – defines all environment variables used throughout the script (paths, filenames, email lists, Java class/JAR locations, etc.). |
| **Process‑Status File** | `$MNAAS_Activations_seq_check_ProcessStatusFilename` – a plain‑text key/value file that stores flags (`MNAAS_Daily_ProcessStatusFlag`, `MNAAS_job_status`, `MNAAS_Script_Process_Id`, timestamps, etc.). Updated multiple times. |
| **Log File** | `$MNAAS_seq_check_logpath_Activations` – appended with `logger -s` statements and any command‑line output. |
| **Staging Directories** | `$MNAASMainStagingDirDaily_v1` – source directory where activation files land.<br>`$MNAASMainStagingDirDaily_afr_seq_check` – destination after the sequence check. |
| **Java Checker** | Executed via `java -Dname=… -cp $CLASSPATHVAR:$MNAAS_Main_JarPath $MNAAS_MNAAS_seqno_check_classname …`. Takes the filename and several history files as arguments; returns exit code 0 on success. |
| **Email & SDP Ticket** | Uses `mail` (for operator notification) and `mailx` (for SDP ticket creation). Recipients are built from `${ccList}`, `$GTPMailId`, `$MOVE_DEV_TEAM`, etc. |
| **Output Files** | `MNASS_SeqNo_Check_activations_current_missing_files` – generated by the Java checker; attached to alert email if non‑empty. |
| **Side‑Effects** | - Moves processed activation file to the *after‑check* directory.<br>- May generate an SDP ticket (once per failure).<br>- Updates shared status file that other pipeline components read. |
| **Assumptions** | - The properties file exists and defines all referenced variables.<br>- The Java class is present, compatible with the supplied arguments, and returns proper exit codes.<br>- The process‑status file is writable by the script user.<br>- Mail utilities (`mail`, `mailx`) are configured and can reach external mail servers.<br>- No other process is concurrently modifying the same status file or moving files from the staging area. |

---

## 4. Integration Points & Call Graph

| Component | Interaction |
|-----------|-------------|
| **Cron Scheduler** | Executes this script (usually nightly). |
| **MNAAS Feed Drop** | External upstream system places activation files in `$MNAASMainStagingDirDaily_v1`. |
| **Java Sequence‑Check JAR** | Called from `seqno_check()`; reads/writes the history files passed as arguments. |
| **Process‑Status File** | Shared with other MOVE scripts (e.g., loading, transformation steps) to coordinate run‑state. |
| **Email System** | Sends alerts to ops (`mail`) and SDP tickets (`mailx`). |
| **SDP Ticketing System** | Receives ticket email; downstream incident‑management processes act on it. |
| **Post‑Check Staging** | Files moved to `$MNAASMainStagingDirDaily_afr_seq_check` for the next pipeline stage (e.g., loading into Hadoop/Hive). |
| **Logging Infrastructure** | Log file is likely harvested by a log‑aggregation tool (e.g., Splunk, ELK). |

*Note:* The script does **not** directly invoke any other Bash scripts, but the status file it updates is read by downstream MOVE ingestion scripts (e.g., `MNAAS_Loading.sh`, `MNAAS_Transform.sh`).

---

## 5. Operational Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Stale PID / orphaned lock** – if the script crashes without clearing `MNAAS_Script_Process_Id`, subsequent runs will be blocked. | Pipeline stall. | Add a watchdog that clears the PID if the process no longer exists (e.g., check `ps -p $PID`). |
| **Missing/Corrupt properties file** – undefined variables cause runtime errors. | Immediate failure, no alerts. | Validate required variables at start; abort with clear error message if any are empty. |
| **Java checker failure / non‑zero exit** – leads to termination without clear reason. | Data may be left unprocessed. | Capture Java stdout/stderr to a dedicated log and include it in the failure email. |
| **Email/SDP ticket delivery failure** – ops may miss critical alerts. | Undetected failures. | Verify mail exit status; retry or fallback to an alternative notification channel (e.g., Slack webhook). |
| **File loss during `mv`** – if the destination directory is unavailable. | Data loss. | Use `mv -n` or copy‑then‑remove pattern; verify destination exists before moving. |
| **Log file growth** – unbounded appends may fill disk. | Service outage. | Rotate logs (logrotate) and enforce size limits. |
| **Concurrent runs** – despite PID guard, race conditions may occur if two cron entries start within seconds. | Duplicate processing. | Use `flock` on a lock file for atomic single‑instance enforcement. |

---

## 6. Running & Debugging the Script

| Step | Command / Action |
|------|-------------------|
| **Manual execution** | `bash -x /app/hadoop_users/MNAAS/MNAAS_Activations_seq_check.sh` – the `-x` flag (already set via `set -x`) prints each command as it runs. |
| **Check required env** | `source /app/hadoop_users/MNAAS/MNAAS_Property_Files/MNAAS_Activations_seq_check.properties && env | grep MNAAS` – verify all variables are populated. |
| **Validate single‑instance lock** | `cat $MNAAS_Activations_seq_check_ProcessStatusFilename | grep MNAAS_Script_Process_Id` – ensure PID matches a running process (`ps -p <pid>`). |
| **Force re‑run** (after clearing lock) | `sed -i 's/MNAAS_Script_Process_Id=.*/MNAAS_Script_Process_Id=0/' $MNAAS_Activations_seq_check_ProcessStatusFilename` then re‑execute. |
| **Inspect logs** | `tail -f $MNAAS_seq_check_logpath_Activations` – watch live output. |
| **Debug Java step** | Add `-verbose:class` or redirect Java stdout/stderr: `java … > /tmp/java.out 2>&1`. |
| **Simulate missing file** | Place a dummy activation file that fails the sequence check; verify email and ticket generation. |
| **Check email delivery** | Review `/var/log/maillog` (or equivalent) for `mail`/`mailx` entries. |
| **Unit test function** | Extract `seqno_check` into a separate script and call with a mock `FEED_FILE_PATTERN` associative array. |

---

## 7. External Config / Environment Variables

| Variable (from properties) | Purpose |
|----------------------------|---------|
| `MNAAS_seq_check_logpath_Activations` | Path to the script’s log file. |
| `MNAAS_Activations_seq_check_ProcessStatusFilename` | Shared status file for flags, PID, timestamps. |
| `FEED_FILE_PATTERN` (associative array) | Mapping of feed source names to filename glob patterns. |
| `MNAASMainStagingDirDaily_v1` | Directory where daily activation files are landed. |
| `MNAASMainStagingDirDaily_afr_seq_check` | Destination after sequence validation. |
| `Dname_MNAAS_Activations_seqno_check` | Java process name used for duplicate‑run detection. |
| `CLASSPATHVAR`, `MNAAS_Main_JarPath`, `MNAAS_MNAAS_seqno_check_classname` | Java runtime configuration. |
| `MNAAS_Property_filename` | Path to the same properties file (passed to Java). |
| `MNASS_SeqNo_Check_activations_*` (history, missing, current) | Files used by Java checker to track sequence history and missing entries. |
| `ccList`, `GTPMailId`, `MOVE_DEV_TEAM`, `SDP_ticket_from_email` | Email recipients / sender details for alerts and tickets. |
| `MNAAS_Activations_seq_check_Scriptname` | Human‑readable script identifier used in logs and emails. |

If any of these are missing or point to non‑existent locations, the script will fail early; therefore the properties file must be validated during deployment.

---

## 8. Suggested Improvements (TODO)

1. **Atomic Single‑Instance Lock** – Replace the PID‑file guard with `flock /var/run/MNAAS_Activations_seq_check.lock` to avoid race conditions and stale locks.
2. **Centralised Configuration Validation** – Add a function at script start that checks each required variable (non‑empty, directories exist, files readable) and aborts with a clear error message if any check fails. This will make troubleshooting faster and prevent silent failures.