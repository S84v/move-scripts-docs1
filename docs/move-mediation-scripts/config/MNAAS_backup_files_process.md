# Summary
Defines all environment‑specific constants required by the **MNAAS_Customer_backup_files_process.sh** driver. It supplies script name, status‑file locations, log prefixes, HDFS target directories, Hive table names, processing limits, file‑type patterns, and per‑customer backup destinations for both primary and edge‑node storage. The file is sourced at runtime to drive the nightly customer‑file backup, count, and Hive refresh workflow in the Move‑Mediation pipeline.

# Key Components
- `MNAAS_Customer_backup_files_process_Scriptname` – driver script identifier.  
- `MNAAS_backup_files_process_ProcessStatusFileName` – HDFS flag file used for job coordination.  
- `MNAAS_backup_files_process_logpath` – local log file prefix (timestamp appended by driver).  
- `MNAAS_backup_file_process_filename` – CSV manifest generated by the driver.  
- `MNAAS_backup_filename_hdfs_customer` – HDFS base directory where per‑customer file counts are stored.  
- `customers_files_inter_record_count_tblname` / `customers_files_records_count_tblname` – Hive staging / final tables for record‑count aggregation.  
- `customer_files_record_count_tblname_refresh` – Hive `REFRESH` command template.  
- `sem_extension` – suffix for semaphore files used to enforce single‑instance execution.  
- `edge2node` – hostname of the secondary edge node (mtthdoped02).  
- `No_of_files_to_process` – maximum files the driver will handle per run.  
- `MNAAS_backup_files_process_file_pattern` (associative array) – glob patterns for each data domain (traffic, activations, actives, tolling).  
- `MNAAS_backup_files_process_backup_dir` (associative array) – primary backup root per customer.  
- `MNAAS_backup_files_edgenode2_backup_dir` (associative array) – secondary edge‑node backup root per customer.

# Data Flow
| Stage | Input | Transformation | Output | Side Effects |
|-------|-------|----------------|--------|--------------|
| 1. Driver start | Sourced properties file | Variables loaded into shell environment | In‑memory config | None |
| 2. File discovery | Local filesystem (edge node) matching patterns from `MNAAS_backup_files_process_file_pattern` | Build list limited by `No_of_files_to_process` | List of file paths per customer/domain | Semaphore file created (`*.sem`) |
| 3. File copy | Source files → `MNAAS_backup_files_process_backup_dir[customer]` (primary) and optionally `MNAAS_backup_files_edgenode2_backup_dir[customer]` (secondary) | `hdfs dfs -copyFromLocal` or `cp` | Backed‑up copies in both locations | HDFS write, local disk I/O |
| 4. Manifest generation | Processed file list | CSV row per file (customer, domain, count, timestamps) | `MNAAS_backup_file_process_filename` | Append to local log |
| 5. Record‑count aggregation | Manifest CSV → Hive staging table (`customers_files_inter_record_count_tblname`) | `INSERT OVERWRITE` | Populated staging table | Hive job execution |
| 6. Refresh final table | `customer_files_record_count_tblname_refresh` command | Hive `REFRESH` | Updated final table (`customers_files_records_count_tblname`) | Hive metadata update |
| 7. Status flag | Driver success/failure | Write/overwrite HDFS flag file (`MNAAS_backup_files_process_ProcessStatusFileName`) | Flag file content (`SUCCESS`/`FAIL`) | Downstream jobs poll this flag |

External services: HDFS, Hive/Impala, local Linux filesystem, edge node host (`mtthdoped02`).

# Integrations
- **MNAAS_Customer_backup_files_process.sh** – primary consumer; sources this file via `source` or `.`.  
- **Move‑Mediation Cron Scheduler** – invokes the driver script on a nightly schedule; monitors the status flag file defined here.  
- **Hive Metastore** – referenced tables (`customers_files_inter_record_count_tblname`, `customers_files_records_count_tblname`).  
- **Edge Node (mtthdoped02)** – secondary backup location; driver may SSH or use `hdfs dfs -copyToLocal` to reach it.  
- **Common MNAAS configuration** – other property files (e.g., `MNAAS_Configuration_Files`) may be sourced earlier to provide `$dbname` and generic paths.

# Operational Risks
- **Path mismatch** – hard‑coded absolute paths may become stale after storage re‑layout; mitigated by periodic validation scripts.  
- **File‑pattern drift** – new file naming conventions break glob matches; mitigate with automated pattern regression tests.  
- **Semaphore leakage** – orphan `.sem` files prevent subsequent runs; add cleanup on abnormal termination.  
- **HDFS permission errors** – driver may lack write rights to status flag or count directories; enforce ACLs and monitor job exit codes.  
- **Edge‑node connectivity loss** – backup to `mtthdoped02` may fail silently; implement retry logic and alert on copy failures.

# Usage
```bash
# Load configuration into the current shell
source /app/hadoop_users/MNAAS/MNAAS_Configuration_Files/MNAAS_backup_files_process.properties

# Execute the driver (normally via cron)
bash $MNAAS_Customer_backup_files_process_Scriptname

# Debug: run driver with verbose logging
bash -x $MNAAS_Customer_backup_files_process_Scriptname 2>&1 | tee /tmp/backup_debug.log
```

# Configuration
- **File**: `move-mediation-scripts/config/MNAAS_backup_files_process.properties` (this document).  
- **Referenced env vars**: `$dbname` (provided by common MNAAS config).  
- **External config files**: `MNAAS_Configuration_Files/*` for shared paths and Hive connection settings.  
- **System variables**: `HADOOP_CONF_DIR`, `HIVE_CONF_DIR`, `PATH` must include `hdfs`, `hive`, `sqoop` binaries.

# Improvements
1. **Externalize associative arrays to JSON/YAML** – enables language‑agnostic consumption and easier validation via schema.  
2. **Add schema validation script** – pre‑run check that all required keys exist, paths are reachable, and file patterns compile; abort driver on validation failure.